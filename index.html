<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leccionario Virtual - Gesti√≥n Acad√©mica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* UI Base */
        body { background-color: #f3f4f6; color: #1f2937; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #e5e7eb; }
        .btn-primary { background-color: #2563eb; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        .btn-danger { background-color: #ef4444; color: white; transition: all 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }
        
        /* Badges */
        .role-badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 2px 8px; border-radius: 99px; letter-spacing: 0.05em; }
        .role-Admin { background: #fee2e2; color: #991b1b; }
        .role-Docente { background: #dcfce7; color: #166534; }
        
        /* Loader */
        .loader-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        
        /* Table Styles */
        .custom-table th { background: #f9fafb; color: #6b7280; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; padding: 12px 16px; text-align: left; }
        .custom-table td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; font-size: 0.875rem; }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tr:hover { background-color: #f9fafb; }
        
        /* Signature Preview */
        .sig-preview { width: 80px; height: 40px; object-fit: contain; border: 1px dashed #cbd5e1; border-radius: 4px; background: #f8fafc; }
    </style>
</head>
<body class="font-sans">

    <!-- LOADER -->
    <div id="loader" class="loader-overlay">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h2 class="text-xl font-black text-slate-800">Cargando Sistema...</h2>
        </div>
    </div>

    <!-- VISTA DE AUTENTICACI√ìN -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-50 rounded-2xl mx-auto flex items-center justify-center text-4xl mb-4">üìö</div>
                <h1 class="text-2xl font-black text-slate-900">Leccionario Virtual</h1>
                <p class="text-slate-400 text-sm">Plataforma de Gesti√≥n Acad√©mica</p>
            </div>

            <!-- Tabs Login/Registro -->
            <div class="flex border-b border-slate-100 mb-6">
                <button onclick="switchAuth('login')" id="tab-login" class="flex-1 pb-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors">Ingresar</button>
                <button onclick="switchAuth('register')" id="tab-register" class="flex-1 pb-3 text-sm font-bold text-slate-400 hover:text-slate-600 transition-colors">Crear Cuenta</button>
            </div>

            <!-- Formulario Login -->
            <form id="login-form" class="space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Correo Institucional</label>
                    <input type="email" id="login-email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="usuario@ecomundo.edu.ec" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Contrase√±a</label>
                    <input type="password" id="login-pass" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-primary w-full py-3 rounded-xl font-bold shadow-lg shadow-blue-200">INICIAR SESI√ìN</button>
            </form>

            <!-- Formulario Registro -->
            <form id="register-form" class="space-y-4 hidden">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Nombre Completo</label>
                    <input type="text" id="reg-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Correo</label>
                    <input type="email" id="reg-email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Contrase√±a</label>
                    <input type="password" id="reg-pass" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Firma Digital (Imagen)</label>
                    <div class="relative">
                        <input type="file" id="reg-signature" accept="image/*" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    </div>
                    <p class="text-[9px] text-slate-400">Esta firma se usar√° en los reportes.</p>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-100 hover:bg-green-700 transition">REGISTRAR USUARIO</button>
            </form>

            <div id="auth-message" class="mt-4 text-xs font-bold text-center hidden p-2 rounded-lg"></div>
            
            <div class="mt-8 pt-6 border-t border-slate-100 text-center">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 border border-slate-200">
                    <div id="db-status-dot" class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
                    <span id="db-status-text" class="text-[10px] font-mono text-slate-500">Conectando DB...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA PRINCIPAL (Dashboard y Admin) -->
    <div id="app-view" class="hidden min-h-screen">
        <!-- Sidebar / Navigation -->
        <nav class="bg-white border-b border-slate-200 px-6 py-4 flex flex-col md:flex-row justify-between items-center sticky top-0 z-50 shadow-sm">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black text-xl">L</div>
                <div>
                    <h1 class="font-black text-slate-800 leading-tight">Panel Acad√©mico</h1>
                    <p class="text-xs text-slate-500 font-medium" id="user-role-label">Cargando...</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="hidden md:flex flex-col text-right mr-2">
                    <span id="user-name-display" class="text-sm font-bold text-slate-700">Usuario</span>
                    <span id="user-email-display" class="text-[10px] text-slate-400">correo@ejemplo.com</span>
                </div>
                
                <!-- Botones de Acci√≥n -->
                <button id="btn-admin-panel" onclick="showSection('users')" class="hidden bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-users-gear"></i> Gesti√≥n Usuarios
                </button>
                
                <button onclick="handleLogout()" class="bg-red-50 text-red-500 hover:bg-red-100 px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i> Salir
                </button>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <main class="p-6 max-w-7xl mx-auto">
            
            <!-- SECCI√ìN: GESTI√ìN DE USUARIOS (Solo Admin) -->
            <div id="section-users" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Gesti√≥n de Usuarios</h2>
                    <div class="flex gap-2">
                        <button onclick="loadUsers()" class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-50">
                            <i class="fa-solid fa-rotate"></i> Recargar
                        </button>
                        <button onclick="openModal('modal-user-edit')" class="btn-primary px-6 py-2 rounded-xl text-xs font-bold">
                            <i class="fa-solid fa-plus"></i> Nuevo Usuario
                        </button>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl overflow-hidden shadow-sm">
                    <div class="overflow-x-auto">
                        <table class="w-full custom-table">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Firma</th>
                                    <th>Rol</th>
                                    <th class="text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr><td colspan="4" class="text-center p-8 text-slate-400">Cargando usuarios...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Dashboard Placeholder (Para otras secciones) -->
            <div id="section-dashboard" class="hidden">
                <div class="text-center py-20">
                    <h2 class="text-3xl font-black text-slate-300">Bienvenido al Dashboard</h2>
                    <p class="text-slate-400 mt-2">Selecciona una opci√≥n del men√∫ (si eres admin) o revisa tu horario.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: EDICI√ìN DE USUARIO -->
    <div id="modal-user-edit" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-3xl p-8 modal-animate max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">Datos de Usuario</h3>
                <button onclick="closeModal('modal-user-edit')" class="text-slate-400 hover:text-red-500 text-xl"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <form id="form-user-edit" class="space-y-6">
                <input type="hidden" id="edit-uid">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Nombre</label>
                        <input type="text" id="edit-name" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Correo</label>
                        <input type="email" id="edit-email" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Rol</label>
                        <select id="edit-rol" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold">
                            <option value="Docente">Docente</option>
                            <option value="Admin">Administrador</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Nueva Firma (Opcional)</label>
                        <input type="file" id="edit-signature" accept="image/*" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs">
                    </div>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 flex items-center gap-3">
                    <input type="checkbox" id="edit-is-super" class="w-5 h-5 accent-yellow-600 rounded">
                    <div>
                        <p class="text-xs font-bold text-yellow-800 uppercase">Super Administrador</p>
                        <p class="text-[10px] text-yellow-600">Acceso total al sistema y configuraci√≥n.</p>
                    </div>
                </div>

                <div class="flex justify-end pt-4 border-t border-slate-100">
                    <button type="button" onclick="closeModal('modal-user-edit')" class="px-6 py-2 text-sm font-bold text-slate-500 hover:bg-slate-50 rounded-xl mr-2">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-8 py-2 rounded-xl text-sm font-black uppercase hover:bg-blue-700 shadow-lg shadow-blue-200">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN ---
        const firebaseConfig = { 
            apiKey: "AIzaSyB1eXkCiF5VZcTin0W5hBQv2X2PEE2bAJc", 
            authDomain: "leccionario-virtual.firebaseapp.com", 
            projectId: "leccionario-virtual", 
            storageBucket: "leccionario-virtual.firebasestorage.app", 
            messagingSenderId: "731785058376", 
            appId: "1:731785058376:web:161550bdc3941e1a64207d" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ESTADO ---
        let currentUser = null;
        
        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loader');
            const statusText = document.getElementById('db-status-text');
            const statusDot = document.getElementById('db-status-dot');

            if (user) {
                // Fetch User Data from DB (Root Collection)
                try {
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        currentUser = { uid: user.uid, ...userSnap.data() };
                    } else {
                        // Create basic profile if missing
                        currentUser = { uid: user.uid, email: user.email, rol: "Docente" };
                        await setDoc(userRef, currentUser);
                    }
                    
                    initApp(currentUser);
                    
                    // Update connection status UI
                    if(statusDot) {
                        statusDot.classList.replace('bg-yellow-300', 'bg-green-500');
                        statusDot.classList.remove('animate-pulse');
                        statusText.textContent = "Conectado";
                    }

                } catch (error) {
                    console.error("Error fetching user:", error);
                    // Fallback login
                    initApp({ uid: user.uid, email: user.email, rol: "Docente" });
                }
            } else {
                showAuthView();
            }
            if(loader) loader.style.opacity = 0;
            setTimeout(() => { if(loader) loader.style.display = 'none'; }, 500);
        });

        // --- APP LOGIC ---
        function initApp(user) {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            
            // Populate Header
            document.getElementById('user-name-display').textContent = user.nombre || "Usuario";
            document.getElementById('user-email-display').textContent = user.email;
            document.getElementById('user-role-label').textContent = user.rol;
            
            // Check Admin Privileges
            const superAdmins = ["gasencio@ecomundo.edu.ec", "ajuanazo@ecomundo.edu.ec"];
            const isAdmin = user.isSuperAdmin || superAdmins.includes(user.email) || user.rol === 'Admin';
            
            if (isAdmin) {
                document.getElementById('btn-admin-panel').classList.remove('hidden');
                loadUsers(); // Preload users list if admin
                showSection('users'); // Go directly to users for testing
            } else {
                showSection('dashboard');
            }
        }

        function showAuthView() {
            document.getElementById('app-view').classList.add('hidden');
            document.getElementById('auth-view').classList.remove('hidden');
        }

        // --- USER MANAGEMENT ---
        window.loadUsers = async () => {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center p-8"><div class="inline-block w-6 h-6 border-2 border-blue-600 rounded-full animate-spin border-t-transparent"></div></td></tr>`;
            
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                const users = [];
                querySnapshot.forEach((doc) => users.push({id: doc.id, ...doc.data()}));
                
                if (users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-slate-400">No hay usuarios registrados.</td></tr>`;
                    return;
                }

                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>
                            <div class="font-bold text-slate-800">${u.nombre || "Sin Nombre"}</div>
                            <div class="text-xs text-slate-400">${u.email}</div>
                        </td>
                        <td>
                            ${u.firma ? 
                                `<img src="${u.firma}" class="sig-preview" title="Firma Cargada">` : 
                                `<span class="text-xs text-red-400 font-bold bg-red-50 px-2 py-1 rounded">Pendiente</span>`}
                        </td>
                        <td><span class="role-badge role-${u.rol}">${u.rol}</span></td>
                        <td class="text-right">
                            <button onclick="window.editUser('${u.id}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition"><i class="fa-solid fa-pen-to-square"></i></button>
                        </td>
                    </tr>
                `).join('');
                
                // Store users in global state for editing lookup
                window.usersData = users;

            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-red-500 font-bold">Error al cargar datos: ${error.message}</td></tr>`;
            }
        };
        
        window.editUser = (uid) => {
            const user = window.usersData.find(u => u.id === uid);
            if (!user) return;
            
            document.getElementById('edit-uid').value = user.id;
            document.getElementById('edit-name').value = user.nombre || "";
            document.getElementById('edit-email').value = user.email || "";
            document.getElementById('edit-rol').value = user.rol || "Docente";
            document.getElementById('edit-is-super').checked = !!user.isSuperAdmin;
            
            window.openModal('modal-user-edit');
        };
        
        // Save User Changes
        document.getElementById('form-user-edit').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('edit-uid').value;
            const btn = e.submitter;
            const originalText = btn.textContent;
            btn.textContent = "Guardando...";
            btn.disabled = true;

            const updates = {
                nombre: document.getElementById('edit-name').value,
                rol: document.getElementById('edit-rol').value,
                isSuperAdmin: document.getElementById('edit-is-super').checked
            };
            
            // Handle Signature
            const sigFile = document.getElementById('edit-signature').files[0];
            if (sigFile) {
                updates.firma = await toBase64(sigFile);
            }

            try {
                if (uid) {
                    await updateDoc(doc(db, "users", uid), updates);
                } else {
                    // New user logic (requires Auth API usually, simplified here to DB only for demo)
                    // In real app, create user in Auth first.
                }
                await window.loadUsers();
                window.closeModal('modal-user-edit');
            } catch(error) {
                alert("Error guardando usuario: " + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });


        // --- UI HELPERS ---
        window.switchAuth = (mode) => {
            document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', mode !== 'register');
            document.getElementById('tab-login').className = mode === 'login' ? 'flex-1 pb-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600' : 'flex-1 pb-3 text-sm font-bold text-slate-400 hover:text-slate-600';
            document.getElementById('tab-register').className = mode === 'register' ? 'flex-1 pb-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600' : 'flex-1 pb-3 text-sm font-bold text-slate-400 hover:text-slate-600';
            document.getElementById('auth-message').classList.add('hidden');
        };

        window.showSection = (sectionId) => {
            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('section-'+sectionId);
            if(target) target.classList.remove('hidden');
        };

        window.openModal = (id) => document.getElementById(id).classList.replace('hidden', 'flex');
        window.closeModal = (id) => document.getElementById(id).classList.replace('flex', 'hidden');

        window.handleLogout = async () => {
            await signOut(auth);
            window.location.reload();
        };

        // --- FORM HANDLERS ---
        
        // LOGIN
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const msg = document.getElementById('auth-message');
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                msg.textContent = "Error: " + error.code;
                msg.className = "mt-4 text-xs font-bold text-center p-2 rounded-lg bg-red-100 text-red-600 block";
                msg.classList.remove('hidden');
            }
        });

        // REGISTER
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const name = document.getElementById('reg-name').value;
            const sigFile = document.getElementById('reg-signature').files[0];
            const msg = document.getElementById('auth-message');

            try {
                // 1. Create Auth User
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                
                // 2. Prepare Data
                let signatureBase64 = null;
                if (sigFile) signatureBase64 = await toBase64(sigFile);

                // 3. Save to DB
                await setDoc(doc(db, "users", cred.user.uid), {
                    email: email,
                    nombre: name,
                    rol: "Docente",
                    firma: signatureBase64,
                    createdAt: new Date().toISOString()
                });

                msg.textContent = "Cuenta creada. Ingresando...";
                msg.className = "mt-4 text-xs font-bold text-center p-2 rounded-lg bg-green-100 text-green-600 block";
                msg.classList.remove('hidden');

            } catch (error) {
                msg.textContent = "Error: " + error.code;
                msg.className = "mt-4 text-xs font-bold text-center p-2 rounded-lg bg-red-100 text-red-600 block";
                msg.classList.remove('hidden');
            }
        });

        // UTILS
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

    </script>
</body>
</html>