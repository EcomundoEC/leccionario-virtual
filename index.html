<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leccionario Virtual - Ecomundo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para compilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Mapa de importaciones para ES Modules -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"
        }
    }
    </script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Script principal de la aplicación -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "firebase/auth";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, query, where, orderBy, writeBatch, getDocs } from "firebase/firestore";
        import { getAnalytics } from "firebase/analytics";
        import { 
            GraduationCap, User, PenTool, ShieldCheck, BookOpen, LogOut, 
            Loader2, AlertCircle, CheckCircle2, Menu, Users, Settings, 
            Plus, Trash2, Save, X, Edit, ChevronRight, Layers, LayoutGrid, Library,
            Calendar, Briefcase, Clock, ChevronDown, Monitor, Coffee, Bell, Copy, FileBarChart, Filter, FileSignature, CheckSquare, Square
        } from 'lucide-react';

        // --- CONFIGURACIÓN DE COLORES ECOMUNDO ---
        const COLORS = {
            blue: '#003366',
            red: '#cc0000',
            light: '#f0f4f8',
            gray: '#64748b'
        };

        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyB1eXkCiF5VZcTin0W5hBQv2X2PEE2bAJc",
            authDomain: "leccionario-virtual.firebaseapp.com",
            projectId: "leccionario-virtual",
            storageBucket: "leccionario-virtual.firebasestorage.app",
            messagingSenderId: "731785058376",
            appId: "1:731785058376:web:161550bdc3941e1a64207d",
            measurementId: "G-ZR0SXQDNY9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let analytics;
        try { analytics = getAnalytics(app); } catch (e) { console.log("Analytics offline"); }

        // --- COMPONENTES FALTANTES AGREGADOS ---
        
        const Loader = () => (
            <div className="flex h-screen w-screen items-center justify-center bg-gray-50 text-blue-900">
                <div className="flex flex-col items-center gap-4">
                    <Loader2 className="animate-spin" size={48} />
                    <p className="font-bold text-lg animate-pulse">Cargando Leccionario...</p>
                </div>
            </div>
        );

        const AuthView = ({ mode, setMode, onLogin, onRegister, error }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [nombre, setNombre] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (mode === 'login') onLogin(e, email, password);
                else onRegister({ nombre, email, password, firma: '' });
            };

            return (
                <div className="flex-1 flex flex-col items-center justify-center bg-gradient-to-br from-blue-900 to-blue-700 p-4 relative overflow-hidden">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full z-10">
                        <div className="flex justify-center mb-6 text-blue-900">
                            <GraduationCap size={64} />
                        </div>
                        <h2 className="text-3xl font-bold mb-8 text-center text-gray-800">
                            {mode === 'login' ? 'Bienvenido' : 'Crear Cuenta'}
                        </h2>
                        {error && <div className="bg-red-50 border-l-4 border-red-500 text-red-700 p-3 mb-6 rounded text-sm font-medium flex items-center gap-2"><AlertCircle size={16}/> {error}</div>}
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {mode === 'register' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                                    <input type="text" placeholder="Ej: Juan Pérez" value={nombre} onChange={e=>setNombre(e.target.value)} className="w-full border-gray-300 border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" required />
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                                <input type="email" placeholder="correo@ecomundo.edu.ec" value={email} onChange={e=>setEmail(e.target.value)} className="w-full border-gray-300 border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                                <input type="password" placeholder="••••••••" value={password} onChange={e=>setPassword(e.target.value)} className="w-full border-gray-300 border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" required minLength={6} />
                            </div>
                            
                            <button type="submit" className="w-full bg-blue-900 text-white p-3 rounded-lg font-bold hover:bg-blue-800 transition-colors shadow-lg mt-2 flex justify-center items-center gap-2">
                                {mode === 'login' ? <><LogOut size={18}/> Iniciar Sesión</> : <><User size={18}/> Registrarse</>}
                            </button>
                        </form>
                        
                        <div className="mt-6 text-center">
                            <button onClick={() => setMode(mode === 'login' ? 'register' : 'login')} className="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
                                {mode === 'login' ? '¿No tienes cuenta? Solicita acceso' : '¿Ya tienes cuenta? Inicia sesión'}
                            </button>
                        </div>
                    </div>
                    {/* Elementos decorativos de fondo */}
                    <div className="absolute top-[-50px] left-[-50px] w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-[-50px] right-[-50px] w-96 h-96 bg-blue-400/20 rounded-full blur-3xl"></div>
                </div>
            );
        };

        const ProfileModule = ({ profile }) => (
            <div className="max-w-3xl mx-auto animate-in fade-in duration-500">
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div className="h-32 bg-gradient-to-r from-blue-900 to-blue-700"></div>
                    <div className="px-8 pb-8">
                        <div className="relative flex justify-between items-end -mt-12 mb-6">
                            <div className="bg-white p-2 rounded-full shadow-lg border-4 border-white inline-block">
                                <div className="bg-blue-100 text-blue-900 w-24 h-24 rounded-full flex items-center justify-center text-4xl font-bold">
                                    {profile?.nombre?.charAt(0) || 'U'}
                                </div>
                            </div>
                            <span className="bg-blue-100 text-blue-800 px-4 py-1.5 rounded-full text-sm font-bold border border-blue-200 shadow-sm flex items-center gap-2">
                                <ShieldCheck size={16}/> {profile?.rol}
                            </span>
                        </div>
                        <h2 className="text-3xl font-bold text-gray-800">{profile?.nombre}</h2>
                        <p className="text-gray-500 font-medium mb-6 flex items-center gap-2 mt-1"><User size={16}/> {profile?.email}</p>
                        
                        <div className="border-t border-gray-100 pt-6 mt-6">
                            <h3 className="font-bold text-gray-800 mb-4">Información de la Cuenta</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <div className="text-xs text-gray-500 uppercase font-bold mb-1">ID de Usuario</div>
                                    <div className="font-mono text-sm text-gray-700 break-all">{profile?.uid}</div>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                    <div className="text-xs text-gray-500 uppercase font-bold mb-1">Privilegios</div>
                                    <div className="text-sm font-medium text-gray-700">{profile?.isSuperAdmin ? 'Super Administrador' : 'Estándar'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const UsersModule = () => {
            const [usersList, setUsersList] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const q = query(collection(db, 'users'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Ordenamos en memoria para evitar configuraciones complejas de índices en Firestore
                    data.sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));
                    setUsersList(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Error al obtener usuarios: ", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div className="flex justify-center items-center h-64 text-blue-900">
                        <Loader2 className="animate-spin" size={32} />
                        <span className="ml-2 font-bold text-lg">Cargando directorio...</span>
                    </div>
                );
            }

            return (
                <div className="max-w-6xl mx-auto animate-in fade-in duration-500">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-3">
                            <Users size={28} className="text-blue-900" />
                            Directorio de Usuarios
                        </h2>
                        <div className="bg-blue-100 text-blue-800 px-4 py-1.5 rounded-full text-sm font-bold border border-blue-200 shadow-sm flex items-center gap-2">
                            <ShieldCheck size={16} /> {usersList.length} Registrados
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-gray-50 uppercase font-bold text-xs text-gray-500 border-b border-gray-200">
                                    <tr>
                                        <th className="px-6 py-4">Usuario</th>
                                        <th className="px-6 py-4">Rol / Privilegios</th>
                                        <th className="px-6 py-4 text-center">Firma Digital</th>
                                        <th className="px-6 py-4">Fecha de Registro</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {usersList.length === 0 && (
                                        <tr><td colSpan="4" className="px-6 py-8 text-center text-gray-400">No hay usuarios registrados.</td></tr>
                                    )}
                                    {usersList.map(u => (
                                        <tr key={u.id} className="hover:bg-gray-50 transition-colors">
                                            <td className="px-6 py-4">
                                                <div className="font-bold text-gray-800 text-base">{u.nombre}</div>
                                                <div className="text-gray-500 flex items-center gap-1 mt-1 text-xs">
                                                    <User size={12}/> {u.email}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="flex flex-col gap-1 items-start">
                                                    <span className={`px-2.5 py-1 rounded text-xs font-bold ${u.rol === 'Admin' ? 'bg-purple-100 text-purple-800 border border-purple-200' : 'bg-green-100 text-green-800 border border-green-200'}`}>
                                                        {u.rol}
                                                    </span>
                                                    {u.isSuperAdmin && (
                                                        <span className="flex items-center gap-1 text-[10px] text-gray-500 font-bold uppercase mt-1">
                                                            <ShieldCheck size={12} className="text-purple-500"/> Super Admin
                                                        </span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="px-6 py-4 text-center">
                                                {u.firma ? (
                                                    <div className="flex justify-center">
                                                        <img 
                                                            src={u.firma} 
                                                            alt={`Firma de ${u.nombre}`} 
                                                            className="max-h-12 max-w-[120px] object-contain border border-gray-200 rounded p-1 bg-white shadow-sm" 
                                                        />
                                                    </div>
                                                ) : (
                                                    <span className="text-gray-400 text-xs italic flex flex-col items-center gap-1">
                                                        <FileSignature size={16} className="text-gray-300" />
                                                        Sin firma
                                                    </span>
                                                )}
                                            </td>
                                            <td className="px-6 py-4 text-gray-500 text-xs font-medium">
                                                {u.createdAt ? new Date(u.createdAt).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        
        const ScheduleModule = () => (
            <div className="max-w-6xl mx-auto p-8 text-center border-2 border-dashed border-gray-300 rounded-2xl bg-gray-50 text-gray-500">
                <Calendar size={48} className="mx-auto mb-4 text-gray-300"/>
                <h3 className="text-xl font-bold mb-2 text-gray-700">Horario de Clases</h3>
                <p>Módulo en construcción para visualizar y gestionar horarios dinámicos.</p>
            </div>
        );
        
        const WorkloadReportModule = () => (
            <div className="max-w-6xl mx-auto p-8 text-center border-2 border-dashed border-gray-300 rounded-2xl bg-gray-50 text-gray-500">
                <FileBarChart size={48} className="mx-auto mb-4 text-gray-300"/>
                <h3 className="text-xl font-bold mb-2 text-gray-700">Reportes de Carga Horaria</h3>
                <p>Herramientas de exportación e impresión en desarrollo.</p>
            </div>
        );


        // --- COMPONENTE DE FILA CON SELECCIÓN Y EDICIÓN ---
        const SelectableRow = ({ id, initialValue, subLabel, isSelected, onToggle, onUpdate }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [value, setValue] = useState(initialValue);

            // Sincronizar si cambia desde fuera
            useEffect(() => setValue(initialValue), [initialValue]);

            const handleUpdate = async () => {
                if (value !== initialValue && value.trim() !== "") {
                    await onUpdate(id, value);
                }
                setIsEditing(false);
            };

            return (
                <div className={`flex items-center gap-3 p-3 border rounded-lg transition-all ${isSelected ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200 hover:border-blue-300'}`}>
                    
                    {/* Checkbox de Selección */}
                    <button 
                        onClick={() => onToggle(id)}
                        className={`p-1 rounded transition-colors ${isSelected ? 'text-red-600' : 'text-gray-300 hover:text-gray-500'}`}
                    >
                        {isSelected ? <CheckSquare size={20} /> : <Square size={20} />}
                    </button>

                    {/* Contenido Editable */}
                    <div className="flex-1">
                        {isEditing ? (
                            <div className="flex items-center gap-2">
                                <input 
                                    value={value} 
                                    onChange={(e) => setValue(e.target.value)} 
                                    className="flex-1 border border-blue-300 rounded px-2 py-1 text-sm outline-none"
                                    autoFocus
                                />
                                <button onClick={handleUpdate} className="text-green-600 p-1 hover:bg-green-50 rounded"><Save size={16}/></button>
                                <button onClick={() => { setIsEditing(false); setValue(initialValue); }} className="text-gray-400 p-1 hover:bg-gray-50 rounded"><X size={16}/></button>
                            </div>
                        ) : (
                            <div onClick={() => onToggle(id)} className="cursor-pointer">
                                <div className={`font-medium ${isSelected ? 'text-red-800' : 'text-gray-800'}`}>{initialValue}</div>
                                {subLabel && <div className="text-xs text-gray-400">{subLabel}</div>}
                            </div>
                        )}
                    </div>

                    {/* Botón Editar Individual */}
                    {!isEditing && (
                        <button onClick={() => setIsEditing(true)} className="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50">
                            <Edit size={16}/>
                        </button>
                    )}
                </div>
            );
        };

        // --- BARRA DE BORRADO MASIVO ---
        const BulkDeleteToolbar = ({ selectedIds, onDelete, onCancel }) => {
            if (selectedIds.size === 0) return null;

            return (
                <div className="sticky top-0 z-10 flex justify-between items-center bg-red-600 text-white p-3 rounded-lg shadow-lg mb-4 animate-in slide-in-from-top-2">
                    <div className="font-bold flex items-center gap-2">
                        <CheckSquare size={18}/>
                        {selectedIds.size} elemento(s) seleccionado(s)
                    </div>
                    <div className="flex gap-2">
                        <button onClick={onCancel} className="px-3 py-1 text-xs font-bold bg-white/20 hover:bg-white/30 rounded text-white transition-colors">Cancelar</button>
                        <button onClick={onDelete} className="px-3 py-1 text-xs font-bold bg-white text-red-600 hover:bg-red-50 rounded flex items-center gap-1 transition-colors">
                            <Trash2 size={14}/> Eliminar
                        </button>
                    </div>
                </div>
            );
        };

        // --- APLICACIÓN PRINCIPAL ---
        function EcomundoApp() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [view, setView] = useState('loading');
            const [authMode, setAuthMode] = useState('login');
            const [error, setError] = useState('');
            
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        const profileRef = doc(db, 'users', currentUser.uid);
                        const unsubProfile = onSnapshot(profileRef, (docSnap) => {
                            if (docSnap.exists()) {
                                setProfile({ ...docSnap.data(), uid: currentUser.uid });
                                setView('app');
                            } else {
                                setProfile(null);
                            }
                        });
                        return () => unsubProfile();
                    } else {
                        setUser(null);
                        setProfile(null);
                        setView('auth');
                    }
                });
                return () => unsubscribe();
            }, []);

            const handleLogin = async (e, email, password) => {
                e.preventDefault();
                setError('');
                try { await signInWithEmailAndPassword(auth, email, password); } 
                catch (err) { setError('Error de credenciales o conexión.'); }
            };

            const handleRegister = async (formData) => {
                setError('');
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, formData.email, formData.password);
                    const newUser = userCredential.user;
                    const isSuper = ['gasencio@ecomundo.edu.ec', 'ajuanazo@ecomundo.edu.ec'].includes(formData.email.toLowerCase());
                    const newProfile = {
                        nombre: formData.nombre,
                        email: formData.email.toLowerCase(),
                        rol: isSuper ? 'Admin' : 'Docente',
                        isSuperAdmin: isSuper,
                        firma: formData.firma || null,
                        createdAt: new Date().toISOString(),
                        uid: newUser.uid
                    };
                    await setDoc(doc(db, 'users', newUser.uid), newProfile);
                } catch (err) { setError('Error al registrar: ' + err.message); }
            };

            const handleLogout = async () => { await signOut(auth); };

            if (view === 'loading') return <Loader />;

            return (
                <div className="font-sans text-gray-800 h-screen overflow-hidden flex flex-col bg-gray-100">
                    {view === 'auth' ? (
                        <AuthView mode={authMode} setMode={setAuthMode} onLogin={handleLogin} onRegister={handleRegister} error={error} />
                    ) : (
                        <DashboardLayout profile={profile} onLogout={handleLogout} />
                    )}
                </div>
            );
        }

        // --- LAYOUT PRINCIPAL ---
        const DashboardLayout = ({ profile, onLogout }) => {
            const [activeModule, setActiveModule] = useState('profile'); 
            const isAdmin = profile?.rol === 'Admin' || profile?.isSuperAdmin;

            return (
                <div className="flex h-screen bg-gray-100 w-full">
                    <aside className="w-64 bg-white shadow-xl z-20 hidden md:flex flex-col border-r border-gray-200">
                        <div className="h-16 flex items-center justify-center border-b border-gray-200" style={{ backgroundColor: COLORS.blue }}>
                            <div className="flex items-center gap-3 text-white">
                                <GraduationCap size={24} />
                                <span className="font-bold text-xl tracking-wide">Ecomundo</span>
                            </div>
                        </div>
                        
                        <nav className="flex-1 py-6 px-3 space-y-1 overflow-y-auto custom-scrollbar">
                            <SidebarItem icon={<User size={18}/>} label="Mi Perfil" isActive={activeModule === 'profile'} onClick={() => setActiveModule('profile')} />
                            
                            {isAdmin && (
                                <>
                                    <div className="pt-6 pb-2 px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Gestión Académica</div>
                                    <SidebarItem icon={<Settings size={18}/>} label="Configuración" isActive={activeModule === 'config'} onClick={() => setActiveModule('config')} />
                                    <SidebarItem icon={<Briefcase size={18}/>} label="Distributivo" isActive={activeModule === 'distributive'} onClick={() => setActiveModule('distributive')} />
                                    <SidebarItem icon={<Calendar size={18}/>} label="Horario de Clases" isActive={activeModule === 'schedule'} onClick={() => setActiveModule('schedule')} />
                                    
                                    <div className="pt-6 pb-2 px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Reportes</div>
                                    <SidebarItem icon={<FileBarChart size={18}/>} label="Reporte Carga Horaria" isActive={activeModule === 'reports_load'} onClick={() => setActiveModule('reports_load')} />

                                    <div className="pt-6 pb-2 px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Sistema</div>
                                    <SidebarItem icon={<Users size={18}/>} label="Usuarios" isActive={activeModule === 'users'} onClick={() => setActiveModule('users')} />
                                </>
                            )}
                        </nav>

                        <div className="p-4 border-t border-gray-100 bg-gray-50">
                            <button onClick={onLogout} className="flex items-center justify-center gap-2 bg-white border border-gray-200 text-gray-600 hover:text-red-600 hover:border-red-200 hover:bg-red-50 w-full px-4 py-2.5 rounded-lg transition-all text-sm font-bold shadow-sm">
                                <LogOut size={16} /> Cerrar Sesión
                            </button>
                        </div>
                    </aside>

                    <div className="flex-1 flex flex-col h-screen overflow-hidden">
                        <header className="md:hidden h-16 text-white flex items-center justify-between px-4 shadow-md z-10" style={{ backgroundColor: COLORS.blue }}>
                            <div className="flex items-center gap-2 font-bold text-lg"><GraduationCap/> Ecomundo</div>
                            <button onClick={onLogout} className="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors"><LogOut size={20}/></button>
                        </header>

                        <main className="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 relative">
                            {activeModule === 'profile' && <ProfileModule profile={profile} />}
                            {activeModule === 'users' && isAdmin && <UsersModule />}
                            {activeModule === 'config' && isAdmin && <ConfigModule />}
                            {activeModule === 'distributive' && isAdmin && <DistributiveModule />}
                            {activeModule === 'schedule' && isAdmin && <ScheduleModule />}
                            {activeModule === 'reports_load' && isAdmin && <WorkloadReportModule />}
                        </main>
                    </div>
                </div>
            );
        };

        const SidebarItem = ({ icon, label, isActive, onClick }) => (
            <button 
                onClick={onClick}
                className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200
                ${isActive ? 'bg-blue-50 text-blue-900 shadow-sm border border-blue-100' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900 border border-transparent'}`}
                style={isActive ? { color: COLORS.blue } : {}}
            >
                <span className={`${isActive ? 'opacity-100' : 'opacity-70'}`}>{icon}</span> {label}
            </button>
        );

        // --- MÓDULOS DE CONFIGURACIÓN (CON SELECCIÓN MÚLTIPLE) ---

        const ConfigModule = () => {
            const [activeTab, setActiveTab] = useState('years');
            const [years, setYears] = useState([]);
            const [selectedYearId, setSelectedYearId] = useState('');

            useEffect(() => {
                const q = query(collection(db, 'academic_years')); 
                const unsubscribe = onSnapshot(q, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    data.sort((a, b) => b.name.localeCompare(a.name));
                    setYears(data);
                    if (!selectedYearId && data.length > 0) setSelectedYearId(data[0].id);
                });
                return () => unsubscribe();
            }, [selectedYearId]);

            return (
                <div className="max-w-6xl mx-auto animate-in fade-in duration-500">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Configuración Académica</h2>
                            <p className="text-sm text-gray-500 mt-1">Administra los parámetros base del sistema.</p>
                        </div>
                        <div className="flex items-center gap-3 bg-blue-50 p-2.5 rounded-lg border border-blue-100">
                            <span className="text-xs font-bold text-blue-800 uppercase px-2 flex items-center gap-1"><Calendar size={14}/> Año Lectivo Activo:</span>
                            <select value={selectedYearId} onChange={(e) => setSelectedYearId(e.target.value)} className="font-bold text-blue-900 outline-none bg-white border border-blue-200 rounded px-3 py-1.5 cursor-pointer shadow-sm">
                                {years.map(y => <option key={y.id} value={y.id}>{y.name}</option>)}
                                {years.length === 0 && <option value="">Crear primero</option>}
                            </select>
                        </div>
                    </div>

                    <div className="flex gap-2 mb-6 border-b border-gray-200 pb-1 overflow-x-auto custom-scrollbar">
                        {['years', 'sections', 'areas', 'subjects', 'courses', 'time_slots'].map(tab => (
                            <ConfigTab key={tab} id={tab} label={tab === 'years' ? 'Años' : tab === 'sections' ? 'Secciones' : tab === 'areas' ? 'Áreas' : tab === 'subjects' ? 'Materias' : tab === 'courses' ? 'Cursos' : 'Franjas Horarias'} active={activeTab} set={setActiveTab} />
                        ))}
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        {activeTab === 'years' && <YearsManager years={years} />}
                        {activeTab !== 'years' && !selectedYearId && <div className="text-center py-12 flex flex-col items-center justify-center text-gray-400 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200"><AlertCircle size={32} className="mb-2 text-gray-300"/> Selecciona o crea un Año Lectivo para configurar este apartado.</div>}
                        {selectedYearId && (
                            <>
                                {activeTab === 'sections' && <GenericCrud collectionName="sections" yearId={selectedYearId} label="Sección" placeholder="Ej: Matutina / Vespertina" />}
                                {activeTab === 'areas' && <GenericCrud collectionName="areas" yearId={selectedYearId} label="Área" placeholder="Ej: Ciencias Exactas" />}
                                {activeTab === 'subjects' && <SubjectsManager yearId={selectedYearId} />}
                                {activeTab === 'courses' && <CoursesManager yearId={selectedYearId} />}
                                {activeTab === 'time_slots' && <TimeSlotsManager yearId={selectedYearId} />}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const ConfigTab = ({ id, label, active, set }) => (
            <button onClick={() => set(id)} className={`px-5 py-2.5 rounded-t-lg text-sm font-bold border-b-2 transition-all whitespace-nowrap ${active ? 'bg-white text-blue-900 border-blue-900 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]' : 'border-transparent text-gray-500 hover:bg-gray-200 hover:text-gray-700'}`}>
                {label}
            </button>
        );

        // --- HOOK DE GESTIÓN DE SELECCIÓN ---
        const useSelection = (collectionName) => {
            const [selectedIds, setSelectedIds] = useState(new Set());

            const toggleSelect = (id) => {
                const newSet = new Set(selectedIds);
                if (newSet.has(id)) newSet.delete(id);
                else newSet.add(id);
                setSelectedIds(newSet);
            };

            const deleteSelected = async () => {
                if (!window.confirm(`¿Estás seguro de eliminar ${selectedIds.size} elementos seleccionados? Esta acción es irreversible.`)) return;
                
                const batch = writeBatch(db);
                selectedIds.forEach(id => {
                    const ref = doc(db, collectionName, id);
                    batch.delete(ref);
                });

                try {
                    await batch.commit();
                    setSelectedIds(new Set()); 
                } catch (e) {
                    alert("Error eliminando: " + e.message);
                }
            };

            const cancelSelection = () => setSelectedIds(new Set());

            return { selectedIds, toggleSelect, deleteSelected, cancelSelection };
        };

        // --- MANAGERS RE-IMPLEMENTADOS CON SELECCIÓN MÚLTIPLE ---

        const YearsManager = ({ years }) => {
            const [name, setName] = useState('');
            const { selectedIds, toggleSelect, deleteSelected, cancelSelection } = useSelection('academic_years');

            const add = async (e) => { e.preventDefault(); if(name) { await addDoc(collection(db, 'academic_years'), { name, isActive: true }); setName(''); }};
            const update = async (id, val) => await updateDoc(doc(db, 'academic_years', id), { name: val });
            
            return (
                <div>
                    <BulkDeleteToolbar selectedIds={selectedIds} onDelete={deleteSelected} onCancel={cancelSelection} />
                    <h3 className="font-bold text-gray-500 text-xs uppercase mb-4 flex items-center gap-2"><Calendar size={14}/> Gestión de Años Lectivos</h3>
                    <form onSubmit={add} className="flex gap-3 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <input value={name} onChange={e=>setName(e.target.value)} placeholder="Ej: 2024-2025" className="flex-1 border border-gray-300 p-2.5 rounded focus:ring-2 focus:ring-blue-500 outline-none" required />
                        <button type="submit" className="bg-blue-600 hover:bg-blue-700 transition-colors text-white px-6 rounded font-bold shadow-sm flex items-center gap-2">
                            <Plus size={18}/> Crear
                        </button>
                    </form>
                    <div className="space-y-2">
                        {years.length === 0 && <p className="text-center text-gray-400 py-4">No hay años creados.</p>}
                        {years.map(y => (
                            <SelectableRow key={y.id} id={y.id} initialValue={y.name} isSelected={selectedIds.has(y.id)} onToggle={toggleSelect} onUpdate={update} />
                        ))}
                    </div>
                </div>
            );
        };

        const GenericCrud = ({ collectionName, yearId, label, placeholder }) => {
            const [items, setItems] = useState([]);
            const [name, setName] = useState('');
            const { selectedIds, toggleSelect, deleteSelected, cancelSelection } = useSelection(collectionName);
            
            useEffect(() => {
                const q = query(collection(db, collectionName), where('academicYearId', '==', yearId));
                return onSnapshot(q, s => setItems(s.docs.map(d=>({id:d.id, ...d.data()}))));
            }, [collectionName, yearId]);
            
            const add = async (e) => { e.preventDefault(); if(name) { await addDoc(collection(db, collectionName), { name, academicYearId: yearId }); setName(''); }};
            const update = async (id, val) => await updateDoc(doc(db, collectionName, id), { name: val });

            return (
                <div>
                    <BulkDeleteToolbar selectedIds={selectedIds} onDelete={deleteSelected} onCancel={cancelSelection} />
                    <h3 className="font-bold text-gray-500 text-xs uppercase mb-4 flex items-center gap-2"><Layers size={14}/> Gestión de {label}s</h3>
                    <form onSubmit={add} className="flex gap-3 mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <input value={name} onChange={e=>setName(e.target.value)} placeholder={placeholder || `Nombre de ${label}`} className="flex-1 border border-gray-300 p-2.5 rounded focus:ring-2 focus:ring-blue-500 outline-none" required />
                        <button className="bg-blue-600 hover:bg-blue-700 transition-colors text-white px-5 rounded font-bold shadow-sm flex items-center gap-2">
                            <Plus size={18}/> Añadir
                        </button>
                    </form>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {items.length === 0 && <div className="col-span-full text-center text-gray-400 py-4">Agrega registros usando el formulario superior.</div>}
                        {items.map(i => (
                            <SelectableRow key={i.id} id={i.id} initialValue={i.name} isSelected={selectedIds.has(i.id)} onToggle={toggleSelect} onUpdate={update} />
                        ))}
                    </div>
                </div>
            );
        };

        const SubjectsManager = ({ yearId }) => {
            const [subjects, setSubjects] = useState([]);
            const [areas, setAreas] = useState([]);
            const [name, setName] = useState('');
            const [areaId, setAreaId] = useState('');
            const { selectedIds, toggleSelect, deleteSelected, cancelSelection } = useSelection('subjects');

            useEffect(() => onSnapshot(query(collection(db, 'areas'), where('academicYearId', '==', yearId)), s => { const d = s.docs.map(x=>({id:x.id, ...x.data()})); setAreas(d); if(d.length) setAreaId(d[0].id); }), [yearId]);
            useEffect(() => onSnapshot(query(collection(db, 'subjects'), where('academicYearId', '==', yearId)), s => setSubjects(s.docs.map(d=>({id:d.id, ...d.data()})))), [yearId]);
            
            const add = async (e) => { e.preventDefault(); if(name && areaId) { const areaName = areas.find(a=>a.id===areaId)?.name; await addDoc(collection(db, 'subjects'), { name, areaId, areaName, academicYearId: yearId }); setName(''); }};
            const update = async (id, val) => await updateDoc(doc(db, 'subjects', id), { name: val });

            return (
                <div>
                    <BulkDeleteToolbar selectedIds={selectedIds} onDelete={deleteSelected} onCancel={cancelSelection} />
                    <h3 className="font-bold text-gray-500 text-xs uppercase mb-4 flex items-center gap-2"><BookOpen size={14}/> Gestión de Materias</h3>
                    
                    {areas.length === 0 ? (
                        <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg mb-6 flex items-center gap-3">
                            <AlertCircle size={20}/> Debes crear áreas académicas antes de agregar materias.
                        </div>
                    ) : (
                        <form onSubmit={add} className="flex flex-col md:flex-row gap-3 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <select value={areaId} onChange={e=>setAreaId(e.target.value)} className="border border-gray-300 p-2.5 rounded md:w-1/3 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                {areas.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}
                            </select>
                            <input value={name} onChange={e=>setName(e.target.value)} placeholder="Nombre Materia (Ej: Matemáticas)" className="flex-1 border border-gray-300 p-2.5 rounded outline-none focus:ring-2 focus:ring-blue-500" required />
                            <button className="bg-blue-600 hover:bg-blue-700 text-white px-5 rounded font-bold shadow-sm py-2.5 md:py-0 flex justify-center items-center gap-2">
                                <Plus size={18}/> Crear
                            </button>
                        </form>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {subjects.length === 0 && <div className="col-span-full text-center text-gray-400 py-4">Agrega materias asociándolas a un área.</div>}
                        {subjects.map(s => (
                            <SelectableRow key={s.id} id={s.id} initialValue={s.name} subLabel={s.areaName} isSelected={selectedIds.has(s.id)} onToggle={toggleSelect} onUpdate={update} />
                        ))}
                    </div>
                </div>
            );
        };

        const CoursesManager = ({ yearId }) => {
            const [courses, setCourses] = useState([]);
            const [sections, setSections] = useState([]);
            const [courseName, setCourseName] = useState('');
            const [parallel, setParallel] = useState('');
            const [sectionId, setSectionId] = useState('');
            const { selectedIds, toggleSelect, deleteSelected, cancelSelection } = useSelection('courses');

            useEffect(() => onSnapshot(query(collection(db, 'sections'), where('academicYearId', '==', yearId)), s => { const d = s.docs.map(x=>({id:x.id, ...x.data()})); setSections(d); if(d.length) setSectionId(d[0].id); }), [yearId]);
            useEffect(() => onSnapshot(query(collection(db, 'courses'), where('academicYearId', '==', yearId)), s => setCourses(s.docs.map(d=>({id:d.id, ...d.data()})))), [yearId]);
            
            const add = async (e) => { e.preventDefault(); if(courseName && parallel && sectionId) { const sectionName = sections.find(s=>s.id===sectionId)?.name; await addDoc(collection(db, 'courses'), { name: courseName, parallel, sectionId, sectionName, academicYearId: yearId }); setCourseName(''); setParallel(''); }};
            const update = async (id, val) => await updateDoc(doc(db, 'courses', id), { name: val });
            
            return (
                <div>
                    <BulkDeleteToolbar selectedIds={selectedIds} onDelete={deleteSelected} onCancel={cancelSelection} />
                    <h3 className="font-bold text-gray-500 text-xs uppercase mb-4 flex items-center gap-2"><LayoutGrid size={14}/> Gestión de Cursos</h3>
                    
                    {sections.length === 0 ? (
                         <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg mb-6 flex items-center gap-3">
                             <AlertCircle size={20}/> Crea al menos una sección académica antes de configurar cursos.
                         </div>
                    ) : (
                        <form onSubmit={add} className="flex flex-col md:flex-row gap-3 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <select value={sectionId} onChange={e=>setSectionId(e.target.value)} className="border border-gray-300 p-2.5 rounded md:w-1/3 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                {sections.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                            <input value={courseName} onChange={e=>setCourseName(e.target.value)} placeholder="Curso (Ej: 10mo EGB)" className="border border-gray-300 p-2.5 rounded flex-1 outline-none focus:ring-2 focus:ring-blue-500" required />
                            <input value={parallel} onChange={e=>setParallel(e.target.value)} placeholder="Paralelo (Ej: A)" className="border border-gray-300 p-2.5 rounded w-full md:w-32 outline-none focus:ring-2 focus:ring-blue-500" required />
                            <button className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded font-bold shadow-sm flex justify-center items-center gap-2">
                                <Plus size={18}/> Crear
                            </button>
                        </form>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {courses.length === 0 && <div className="col-span-full text-center text-gray-400 py-4">No hay cursos creados para este año.</div>}
                        {courses.map(c => (
                            <SelectableRow key={c.id} id={c.id} initialValue={`${c.name} "${c.parallel}"`} subLabel={c.sectionName} isSelected={selectedIds.has(c.id)} onToggle={toggleSelect} onUpdate={update} />
                        ))}
                    </div>
                </div>
            );
        };

        const TimeSlotsManager = ({ yearId }) => {
            const [slots, setSlots] = useState([]);
            const [sections, setSections] = useState([]);
            const [currentSectionId, setCurrentSectionId] = useState('');
            const [sourceSectionId, setSourceSectionId] = useState('');
            const [start, setStart] = useState('');
            const [end, setEnd] = useState('');
            const [type, setType] = useState('Clase'); 
            const { selectedIds, toggleSelect, deleteSelected, cancelSelection } = useSelection('time_slots');

            useEffect(() => onSnapshot(query(collection(db, 'sections'), where('academicYearId', '==', yearId)), s => { const d = s.docs.map(x=>({id:x.id, ...x.data()})); setSections(d); if(d.length > 0 && !currentSectionId) setCurrentSectionId(d[0].id); }), [yearId]);
            useEffect(() => { if(!currentSectionId) return; const q = query(collection(db, 'time_slots'), where('sectionId', '==', currentSectionId)); const unsub = onSnapshot(q, (snapshot) => { const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); data.sort((a, b) => a.start.localeCompare(b.start)); setSlots(data); }); return () => unsub(); }, [currentSectionId]);
            
            const add = async (e) => { e.preventDefault(); if(start && end && currentSectionId) { await addDoc(collection(db, 'time_slots'), { start, end, type, academicYearId: yearId, sectionId: currentSectionId }); setStart(''); setEnd(''); }};
            
            const copySlots = async () => { 
                if(!sourceSectionId || !currentSectionId || sourceSectionId === currentSectionId) return alert("Selecciona una sección origen válida y diferente a la actual."); 
                if(!window.confirm("¿Estás seguro de copiar las franjas horarias? Esto agregará las franjas de la sección origen a la sección actual.")) return; 
                
                try {
                    const qSource = query(collection(db, 'time_slots'), where('sectionId', '==', sourceSectionId)); 
                    const snapSource = await getDocs(qSource); 
                    const batch = writeBatch(db); 
                    snapSource.docs.forEach(docSrc => { 
                        const data = docSrc.data(); 
                        const newRef = doc(collection(db, 'time_slots')); 
                        batch.set(newRef, { ...data, sectionId: currentSectionId, academicYearId: yearId }); 
                    }); 
                    await batch.commit(); 
                    alert("Franjas copiadas exitosamente."); 
                } catch(e) {
                    alert("Error al copiar franjas: " + e.message);
                }
            };

            return (
                <div>
                    <BulkDeleteToolbar selectedIds={selectedIds} onDelete={deleteSelected} onCancel={cancelSelection} />
                    <h3 className="font-bold text-gray-500 text-xs uppercase mb-4 flex items-center gap-2"><Clock size={14}/> Gestión de Franjas Horarias</h3>
                    
                    {sections.length === 0 ? (
                        <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg mb-6 flex items-center gap-3">
                             <AlertCircle size={20}/> Requiere configurar secciones previamente.
                        </div>
                    ) : (
                        <>
                            <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg shadow-sm">
                                <label className="block text-xs font-bold text-blue-900 uppercase mb-2">Configurando Horario Para la Sección:</label>
                                <select value={currentSectionId} onChange={e=>setCurrentSectionId(e.target.value)} className="w-full border border-blue-300 rounded-md p-2.5 font-bold text-gray-800 bg-white shadow-sm outline-none">
                                    {sections.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-3 items-center mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                <div className="flex items-center gap-2 text-gray-500 w-full sm:w-auto"><Copy size={18}/> <span className="text-sm font-medium">Copiar desde:</span></div>
                                <select value={sourceSectionId} onChange={e=>setSourceSectionId(e.target.value)} className="text-sm border border-gray-300 p-2 rounded-md flex-1 w-full bg-white outline-none">
                                    <option value="">Seleccione sección origen...</option>
                                    {sections.filter(s=>s.id !== currentSectionId).map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                                <button type="button" onClick={copySlots} className="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md font-bold transition-colors w-full sm:w-auto">Importar Franjas</button>
                            </div>

                            {currentSectionId && (
                                <>
                                    <form onSubmit={add} className="flex flex-col md:flex-row gap-3 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 items-end shadow-sm">
                                        <div className="flex-1 w-full">
                                            <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Hora Inicio</label>
                                            <input type="time" value={start} onChange={e=>setStart(e.target.value)} className="border border-gray-300 p-2.5 rounded-md w-full outline-none focus:ring-2 focus:ring-blue-500 bg-white" required />
                                        </div>
                                        <div className="flex-1 w-full">
                                            <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Hora Fin</label>
                                            <input type="time" value={end} onChange={e=>setEnd(e.target.value)} className="border border-gray-300 p-2.5 rounded-md w-full outline-none focus:ring-2 focus:ring-blue-500 bg-white" required />
                                        </div>
                                        <div className="flex-1 w-full">
                                            <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Tipo de Franja</label>
                                            <select value={type} onChange={e=>setType(e.target.value)} className="border border-gray-300 p-2.5 rounded-md w-full outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                                <option value="Clase">Bloque de Clase</option>
                                                <option value="Receso">Receso / Lunch</option>
                                            </select>
                                        </div>
                                        <button className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-md font-bold transition-colors shadow-sm w-full md:w-auto flex justify-center items-center gap-2">
                                            <Plus size={18}/> Agregar
                                        </button>
                                    </form>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {slots.length === 0 && <div className="col-span-full text-center text-gray-400 py-4">No hay franjas configuradas para esta sección.</div>}
                                        {slots.map(s => (
                                            <SelectableRow 
                                                key={s.id} 
                                                id={s.id} 
                                                initialValue={`${s.start} - ${s.end}`} 
                                                subLabel={s.type}
                                                isSelected={selectedIds.has(s.id)}
                                                onToggle={toggleSelect}
                                                onUpdate={()=>{/* Las horas no se actualizan en línea en esta versión */}}
                                            />
                                        ))}
                                    </div>
                                </>
                            )}
                        </>
                    )}
                </div>
            );
        };

        // --- DISTRIBUTIVO COMPLETADO ---
        const DistributiveModule = () => {
            const [years, setYears] = useState([]);
            const [yearId, setYearId] = useState('');
            const [sections, setSections] = useState([]);
            const [sectionId, setSectionId] = useState('');
            const [courses, setCourses] = useState([]);
            const [courseId, setCourseId] = useState('');
            const [subjects, setSubjects] = useState([]);
            const [teachers, setTeachers] = useState([]);
            const [allocations, setAllocations] = useState({});

            useEffect(() => onSnapshot(query(collection(db, 'academic_years')), s => { const d = s.docs.map(x=>({id:x.id, ...x.data()})); setYears(d); if(d.length) setYearId(d[0].id); }), []);
            useEffect(() => onSnapshot(query(collection(db, 'users')), s => { const allUsers = s.docs.map(d=>({id:d.id, ...d.data()})); const staff = allUsers.filter(u => u.rol === 'Docente' || u.rol === 'Admin'); setTeachers(staff); }), []);
            useEffect(() => { if(yearId) onSnapshot(query(collection(db, 'sections'), where('academicYearId', '==', yearId)), s => { const d = s.docs.map(x=>({id:x.id, ...x.data()})); setSections(d); setSectionId(''); setCourseId(''); })}, [yearId]);
            useEffect(() => { if(sectionId) { onSnapshot(query(collection(db, 'courses'), where('sectionId', '==', sectionId)), s => { const d = s.docs.map(x=>({id:x.id, ...x.data()})); setCourses(d); setCourseId(''); }); } else { setCourses([]); } }, [sectionId]);
            useEffect(() => { if(yearId) onSnapshot(query(collection(db, 'subjects'), where('academicYearId', '==', yearId)), s => setSubjects(s.docs.map(d=>({id:d.id, ...d.data()})))); }, [yearId]);
            
            useEffect(() => { 
                if(courseId) { 
                    const q = query(collection(db, 'allocations'), where('courseId', '==', courseId)); 
                    return onSnapshot(q, snap => { 
                        const allocs = {}; 
                        snap.docs.forEach(d => allocs[d.data().subjectId] = d.data().teacherId); 
                        setAllocations(allocs); 
                    }); 
                } 
            }, [courseId]);

            const assignTeacher = async (subjectId, teacherId) => { 
                const allocId = `${courseId}_${subjectId}`; 
                if (teacherId) {
                    await setDoc(doc(db, 'allocations', allocId), { academicYearId: yearId, courseId, subjectId, teacherId }); 
                } else {
                    await deleteDoc(doc(db, 'allocations', allocId));
                }
            };

            return (
                <div className="max-w-6xl mx-auto animate-in fade-in duration-500">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Distributivo de Carga Horaria</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div>
                            <label className="block text-xs font-bold text-gray-400 uppercase mb-2">1. Año Lectivo</label>
                            <select value={yearId} onChange={e=>setYearId(e.target.value)} className="w-full border border-gray-300 p-2.5 rounded outline-none font-bold text-blue-900 bg-blue-50">
                                {years.map(y=><option key={y.id} value={y.id}>{y.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-400 uppercase mb-2">2. Sección</label>
                            <select value={sectionId} onChange={e=>setSectionId(e.target.value)} className="w-full border border-gray-300 p-2.5 rounded outline-none bg-white">
                                <option value="">Seleccione Sección...</option>
                                {sections.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-400 uppercase mb-2">3. Curso</label>
                            <select value={courseId} onChange={e=>setCourseId(e.target.value)} className="w-full border border-gray-300 p-2.5 rounded outline-none bg-white disabled:bg-gray-100 disabled:text-gray-400" disabled={!sectionId}>
                                <option value="">Seleccione Curso...</option>
                                {courses.map(c=><option key={c.id} value={c.id}>{c.name} "{c.parallel}"</option>)}
                            </select>
                        </div>
                    </div>

                    {courseId ? (
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div className="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                <h3 className="font-bold text-gray-700">Asignación de Docentes por Materia</h3>
                                <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">Autoguardado activado</span>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-white uppercase font-bold text-xs text-gray-400 border-b border-gray-200">
                                        <tr>
                                            <th className="px-6 py-4">Materia</th>
                                            <th className="px-6 py-4">Área Académica</th>
                                            <th className="px-6 py-4">Docente Asignado</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {subjects.length === 0 && <tr><td colSpan="3" className="px-6 py-8 text-center text-gray-400">No hay materias configuradas para este año lectivo.</td></tr>}
                                        {subjects.map(s => (
                                            <tr key={s.id} className="hover:bg-gray-50 transition-colors">
                                                <td className="px-6 py-4 font-bold text-gray-800">{s.name}</td>
                                                <td className="px-6 py-4 text-gray-500">{s.areaName}</td>
                                                <td className="px-6 py-4">
                                                    <select 
                                                        value={allocations[s.id] || ''} 
                                                        onChange={(e) => assignTeacher(s.id, e.target.value)} 
                                                        className={`border rounded-lg p-2.5 w-full outline-none transition-all ${allocations[s.id] ? 'bg-blue-50 text-blue-900 font-bold border-blue-200 shadow-sm' : 'text-gray-500 bg-white border-gray-300'}`}
                                                    >
                                                        <option value="">-- Sin Asignar --</option>
                                                        {teachers.map(t=><option key={t.id} value={t.id}>{t.nombre} ({t.rol})</option>)}
                                                    </select>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ) : (
                        <div className="text-center p-12 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 flex flex-col items-center justify-center">
                            <Briefcase size={48} className="text-gray-300 mb-4" />
                            <p className="font-medium text-lg text-gray-500">Seleccione un curso en los filtros superiores</p>
                            <p className="text-sm">para ver o configurar su distributivo de carga horaria.</p>
                        </div>
                    )}
                </div>
            );
        };

        // Renderizado del Componente Principal
        const root = createRoot(document.getElementById('root'));
        root.render(<EcomundoApp />);
    </script>
</body>
</html>