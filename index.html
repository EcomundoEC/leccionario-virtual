<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leccionario Virtual - Gesti√≥n Acad√©mica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* UI Base */
        body { background-color: #f3f4f6; color: #1f2937; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #e5e7eb; }
        .btn-primary { background-color: #2563eb; color: white; transition: all 0.2s; }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        .btn-danger { background-color: #ef4444; color: white; transition: all 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }
        
        /* Badges */
        .role-badge { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; padding: 2px 8px; border-radius: 99px; letter-spacing: 0.05em; }
        .role-Admin { background: #fee2e2; color: #991b1b; }
        .role-Docente { background: #dcfce7; color: #166534; }
        
        /* Loader */
        .loader-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        
        /* Table Styles */
        .custom-table th { background: #f9fafb; color: #6b7280; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; padding: 12px 16px; text-align: left; }
        .custom-table td { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; font-size: 0.875rem; }
        .custom-table tr:last-child td { border-bottom: none; }
        .custom-table tr:hover { background-color: #f9fafb; }
        
        /* Signature Preview - Modified for transparency */
        .sig-preview { width: 80px; height: 40px; object-fit: contain; mix-blend-mode: multiply; }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 1rem; border-radius: 0.75rem; color: white; font-weight: bold; font-size: 0.875rem; shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 10px; min-width: 250px; }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Tabs Styling */
        .tab-btn { @apply px-4 py-2 text-sm font-bold text-slate-500 border-b-2 border-transparent hover:text-slate-700 transition-colors; }
        
        /* Diferenciaci√≥n visual de pesta√±as de reporte */
        .tab-btn.active { @apply text-blue-600 border-blue-600; }
        
        .tab-btn-individual.active { @apply text-blue-600 border-blue-600 bg-blue-50/50; }
        .tab-btn-mass.active { @apply text-indigo-600 border-indigo-600 bg-indigo-50/50; }
        
        /* Dropdown */
        .dropdown:hover .dropdown-menu { display: block; }

        /* Schedule Matrix */
        .matrix-table { width: 100%; border-collapse: separate; border-spacing: 2px; }
        .matrix-th { background: #3b82f6; color: white; padding: 10px; font-size: 0.8rem; border-radius: 8px; font-weight: 800; text-align: center; }
        .matrix-time-cell { background: #eff6ff; color: #1e40af; font-weight: bold; padding: 10px; border-radius: 8px; font-size: 0.75rem; text-align: center; vertical-align: middle; width: 100px; }
        .matrix-cell { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px; height: 80px; vertical-align: top; cursor: pointer; transition: all 0.2s; position: relative; }
        .matrix-cell:hover { border-color: #3b82f6; background: #f8fafc; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .matrix-cell-content { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .matrix-add-icon { color: #cbd5e1; font-size: 1.5rem; }
        .matrix-cell:hover .matrix-add-icon { color: #3b82f6; }
        .matrix-subject { font-weight: bold; color: #1e293b; font-size: 0.8rem; line-height: 1.2; }

        /* Print Styles - Improved */
        @media print {
            .no-print, nav, #btn-admin-panel, .btn-primary, .fixed { display: none !important; }
            .print-break-after { break-after: page; page-break-after: always; }
            #report-container { display: block !important; box-shadow: none; border: none; padding: 0; margin: 0; position: absolute; top: 0; left: 0; width: 100%; }
            body { background: white; padding: 0; margin: 0; }
            main { padding: 0; margin: 0; max-width: none; }
            .glass-panel { border: none; }
            /* Force background colors */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="font-sans text-slate-800">

    <!-- LOADER -->
    <div id="loader" class="loader-overlay">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h2 class="text-xl font-black text-slate-800">Cargando Sistema...</h2>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- VISTA DE AUTENTICACI√ìN -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-50 rounded-2xl mx-auto flex items-center justify-center text-4xl mb-4">üìö</div>
                <h1 class="text-2xl font-black text-slate-900">Leccionario Virtual</h1>
                <p class="text-slate-400 text-sm">Plataforma de Gesti√≥n Acad√©mica</p>
            </div>

            <!-- Tabs Login/Registro -->
            <div class="flex border-b border-slate-100 mb-6">
                <button onclick="switchAuth('login')" id="tab-login" class="flex-1 pb-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 transition-colors">Ingresar</button>
                <button onclick="switchAuth('register')" id="tab-register" class="flex-1 pb-3 text-sm font-bold text-slate-400 hover:text-slate-600 transition-colors">Crear Cuenta</button>
            </div>

            <!-- Formulario Login -->
            <form id="login-form" class="space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Correo Institucional</label>
                    <input type="email" id="login-email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="usuario@ecomundo.edu.ec" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Contrase√±a</label>
                    <input type="password" id="login-pass" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-primary w-full py-3 rounded-xl font-bold shadow-lg shadow-blue-200">INICIAR SESI√ìN</button>
            </form>

            <!-- Formulario Registro -->
            <form id="register-form" class="space-y-4 hidden">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Nombre Completo</label>
                    <input type="text" id="reg-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Correo</label>
                    <input type="email" id="reg-email" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Contrase√±a</label>
                    <input type="password" id="reg-pass" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" required>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Firma Digital (Imagen)</label>
                    <div class="relative">
                        <input type="file" id="reg-signature" accept="image/*" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    </div>
                    <p class="text-[9px] text-slate-400">Esta firma se usar√° en los reportes.</p>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-100 hover:bg-green-700 transition">REGISTRAR USUARIO</button>
            </form>

            <div id="auth-message" class="mt-4 text-xs font-bold text-center hidden p-2 rounded-lg"></div>
            
            <div class="mt-8 pt-6 border-t border-slate-100 text-center">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-100 border border-slate-200">
                    <div id="db-status-dot" class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
                    <span id="db-status-text" class="text-[10px] font-mono text-slate-500">Conectando DB...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA PRINCIPAL -->
    <div id="app-view" class="hidden min-h-screen">
        <!-- Navbar -->
        <nav class="bg-white border-b border-slate-200 px-6 py-4 flex flex-col md:flex-row justify-between items-center sticky top-0 z-50 shadow-sm no-print">
            <div class="flex items-center gap-4 mb-4 md:mb-0 cursor-pointer" onclick="showSection('dashboard')">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black text-xl">L</div>
                <div>
                    <h1 class="font-black text-slate-800 leading-tight">Panel Acad√©mico</h1>
                    <p class="text-xs text-slate-500 font-medium" id="user-role-label">Cargando...</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Menu Acad√©mico (Admin Only) -->
                <div id="nav-academic" class="hidden relative dropdown group">
                    <button class="flex items-center gap-2 text-sm font-bold text-slate-600 hover:text-blue-600 py-2">
                        <i class="fa-solid fa-graduation-cap"></i> Acad√©mico <i class="fa-solid fa-chevron-down text-xs"></i>
                    </button>
                    <div class="dropdown-menu hidden absolute top-full right-0 w-56 bg-white border border-slate-200 rounded-xl shadow-xl mt-1 py-2 z-50">
                        <a href="#" onclick="showSection('academic-admin')" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600">
                            <i class="fa-solid fa-sliders w-5"></i> Admin. Acad√©mica
                        </a>
                        <a href="#" onclick="showSection('courses')" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600">
                            <i class="fa-solid fa-layer-group w-5"></i> Cursos y Paralelos
                        </a>
                        <a href="#" onclick="showSection('distributive')" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600">
                            <i class="fa-solid fa-chalkboard-user w-5"></i> Distributivo
                        </a>
                         <a href="#" onclick="showSection('schedules')" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600">
                            <i class="fa-regular fa-calendar-days w-5"></i> Horarios
                        </a>
                    </div>
                </div>

                <!-- Menu Reportes -->
                <div id="nav-reports" class="hidden relative dropdown group ml-2">
                    <button class="flex items-center gap-2 text-sm font-bold text-slate-600 hover:text-blue-600 py-2">
                        <i class="fa-solid fa-print"></i> Reportes <i class="fa-solid fa-chevron-down text-xs"></i>
                    </button>
                    <div class="dropdown-menu hidden absolute top-full right-0 w-56 bg-white border border-slate-200 rounded-xl shadow-xl mt-1 py-2 z-50">
                        <a href="#" onclick="showSection('leccionario-report')" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600">
                            <i class="fa-solid fa-book-open w-5"></i> Leccionario Diario
                        </a>
                    </div>
                </div>

                <div class="hidden md:flex flex-col text-right mr-2 ml-4 pl-4 border-l border-slate-200">
                    <span id="user-name-display" class="text-sm font-bold text-slate-700">Usuario</span>
                    <span id="user-email-display" class="text-[10px] text-slate-400">correo@ejemplo.com</span>
                </div>
                
                <!-- Bot√≥n Cambiar Contrase√±a -->
                <button onclick="openModal('modal-change-password')" class="bg-slate-100 text-slate-600 hover:bg-blue-50 hover:text-blue-600 px-3 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2" title="Cambiar Contrase√±a">
                    <i class="fa-solid fa-key"></i>
                </button>

                <button id="btn-admin-panel" onclick="showSection('users')" class="hidden bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-2 rounded-xl text-xs font-bold transition items-center gap-2" title="Gesti√≥n Usuarios">
                    <i class="fa-solid fa-users-gear"></i>
                </button>
                
                <button onclick="handleLogout()" class="bg-red-50 text-red-500 hover:bg-red-100 px-3 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="p-6 max-w-7xl mx-auto">
            
            <!-- 1. DASHBOARD -->
            <div id="section-dashboard" class="hidden">
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">Mi Agenda de Hoy</h2>
                        <p class="text-slate-500" id="current-date-label">Cargando fecha...</p>
                    </div>
                    <div class="text-right hidden md:block">
                        <div class="flex items-center gap-2">
                            <span id="school-cycle-display" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Ciclo Escolar 2024-2025</span>
                            <button onclick="editSchoolCycle()" class="text-blue-400 hover:text-blue-600"><i class="fa-solid fa-pen-to-square text-xs"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Grid de Clases de Hoy -->
                <div id="dashboard-daily-schedule" class="grid grid-cols-1 gap-4">
                    <!-- Loading state -->
                    <div class="text-center py-20 bg-white rounded-3xl border border-dashed border-slate-300">
                        <div class="inline-flex w-16 h-16 bg-slate-50 rounded-full items-center justify-center text-2xl mb-4 animate-bounce">üìÖ</div>
                        <p class="text-slate-400 font-medium">Buscando clases para hoy...</p>
                    </div>
                </div>

                 <div class="mt-12">
                    <h3 class="text-xl font-bold text-slate-800 mb-4 border-b border-slate-200 pb-2">Resumen de Cargas</h3>
                    <div id="dashboard-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 opacity-75">
                         <!-- Cards peque√±as -->
                    </div>
                </div>
            </div>

            <!-- 2. GESTI√ìN DE USUARIOS -->
            <div id="section-users" class="hidden space-y-6">
                <!-- ... Contenido Usuarios (Sin Cambios) ... -->
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Gesti√≥n de Usuarios</h2>
                    <div class="flex gap-2">
                        <button onclick="loadUsers()" class="bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-50">
                            <i class="fa-solid fa-rotate"></i> Recargar
                        </button>
                        <button onclick="openModal('modal-user-edit'); resetEditForm();" class="btn-primary px-6 py-2 rounded-xl text-xs font-bold">
                            <i class="fa-solid fa-plus"></i> Nuevo Usuario
                        </button>
                    </div>
                </div>
                <div class="glass-panel rounded-2xl overflow-hidden shadow-sm">
                    <div class="overflow-x-auto">
                        <table class="w-full custom-table">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Firma</th>
                                    <th>Rol</th>
                                    <th class="text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr><td colspan="4" class="text-center p-8 text-slate-400">Cargando usuarios...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. ADMINISTRACI√ìN ACAD√âMICA -->
            <div id="section-academic-admin" class="hidden space-y-6">
                 <!-- ... Contenido Admin Acad√©mica (Sin Cambios) ... -->
                 <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Administraci√≥n Acad√©mica</h2>
                </div>
                <div class="border-b border-slate-200 mb-6 flex gap-2">
                    <button class="tab-btn active" onclick="switchTab(this, 'tab-sections')">Secciones</button>
                    <button class="tab-btn" onclick="switchTab(this, 'tab-areas')">√Åreas</button>
                    <button class="tab-btn" onclick="switchTab(this, 'tab-subjects')">Materias</button>
                </div>
                <div id="tab-sections" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="glass-panel p-6 rounded-2xl h-fit">
                        <h3 class="font-bold text-lg mb-4">Nueva Secci√≥n</h3>
                        <form id="form-section" class="space-y-4">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Nombre Secci√≥n</label>
                                <input type="text" id="section-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" placeholder="Ej: Matutina, Vespertina, B√°sica..." required>
                            </div>
                            <button type="submit" class="btn-primary w-full py-2 rounded-xl text-sm font-bold">Guardar Secci√≥n</button>
                        </form>
                    </div>
                    <div class="glass-panel rounded-2xl overflow-hidden lg:col-span-2">
                        <table class="w-full custom-table">
                            <thead><tr><th>Nombre Secci√≥n</th><th class="text-right">Acciones</th></tr></thead>
                            <tbody id="sections-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tab-areas" class="tab-content hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="glass-panel p-6 rounded-2xl h-fit">
                        <h3 class="font-bold text-lg mb-4">Nueva √Årea</h3>
                        <form id="form-area" class="space-y-4">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Nombre √Årea</label>
                                <input type="text" id="area-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" placeholder="Ej: Ciencias Exactas, Lengua..." required>
                            </div>
                            <button type="submit" class="btn-primary w-full py-2 rounded-xl text-sm font-bold">Guardar √Årea</button>
                        </form>
                    </div>
                    <div class="glass-panel rounded-2xl overflow-hidden lg:col-span-2">
                        <table class="w-full custom-table">
                            <thead><tr><th>Nombre √Årea</th><th class="text-right">Acciones</th></tr></thead>
                            <tbody id="areas-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tab-subjects" class="tab-content hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="glass-panel p-6 rounded-2xl h-fit">
                        <h3 class="font-bold text-lg mb-4">Nueva Materia</h3>
                        <form id="form-subject" class="space-y-4">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Nombre Materia</label>
                                <input type="text" id="subject-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" placeholder="Ej: Matem√°ticas Avanzadas" required>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">√Årea Perteneciente</label>
                                <select id="subject-area-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" required>
                                    <option value="">Seleccione √Årea...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn-primary w-full py-2 rounded-xl text-sm font-bold">Guardar Materia</button>
                        </form>
                    </div>
                    <div class="glass-panel rounded-2xl overflow-hidden lg:col-span-2">
                        <table class="w-full custom-table">
                            <thead><tr><th>Materia</th><th>√Årea</th><th class="text-right">Acciones</th></tr></thead>
                            <tbody id="subjects-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. GESTI√ìN DE CURSOS Y PARALELOS -->
            <div id="section-courses" class="hidden space-y-6">
                <!-- ... Contenido Cursos (Sin Cambios) ... -->
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Cursos y Paralelos</h2>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="glass-panel p-6 rounded-2xl h-fit">
                        <h3 class="font-bold text-lg mb-4">Crear Curso</h3>
                        <form id="form-course" class="space-y-4">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Nombre Curso</label>
                                <input type="text" id="course-name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" placeholder="Ej: 1er A√±o Bachillerato" required>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Secci√≥n</label>
                                <select id="course-section-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" required>
                                    <option value="">Seleccione Secci√≥n...</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Paralelos (Separados por comas)</label>
                                <input type="text" id="course-parallels" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none" placeholder="A, B, C" required>
                                <p class="text-[10px] text-slate-400">Ejemplo: A, B, C</p>
                            </div>
                            <button type="submit" class="btn-primary w-full py-2 rounded-xl text-sm font-bold">Guardar Curso</button>
                        </form>
                    </div>
                    <div class="glass-panel rounded-2xl overflow-hidden lg:col-span-2">
                        <table class="w-full custom-table">
                            <thead><tr><th>Curso</th><th>Secci√≥n</th><th>Paralelos</th><th class="text-right">Acciones</th></tr></thead>
                            <tbody id="courses-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. DISTRIBUTIVO -->
            <div id="section-distributive" class="hidden space-y-6">
                <!-- ... Contenido Distributivo (Sin Cambios) ... -->
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Distributivo de Materias</h2>
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="font-bold text-sm text-slate-500 uppercase mb-4">Asignar Materia a Docente</h3>
                    <form id="form-distributive" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500">Docente</label>
                            <select id="dist-teacher-select" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none text-sm" required></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500">Curso</label>
                            <select id="dist-course-select" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none text-sm" required onchange="updateDistParallels()"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500">Paralelo</label>
                            <select id="dist-parallel-select" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none text-sm" required></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500">Materia</label>
                            <select id="dist-subject-select" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg outline-none text-sm" required></select>
                        </div>
                    </form>
                    <div class="mt-4 flex justify-end">
                        <button type="submit" form="form-distributive" class="btn-primary px-6 py-2 rounded-xl text-sm font-bold">Asignar Carga</button>
                    </div>
                </div>
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <table class="w-full custom-table">
                        <thead><tr><th>Docente</th><th>Curso / Paralelo</th><th>Materia</th><th class="text-right">Acciones</th></tr></thead>
                        <tbody id="distributive-table-body">
                            <tr><td colspan="4" class="text-center p-8 text-slate-400">No hay asignaciones registradas.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 6. HORARIOS (MATRIZ INTERACTIVA) -->
            <div id="section-schedules" class="hidden space-y-6">
                <!-- ... Contenido Horarios (Sin Cambios) ... -->
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-black text-slate-800">Matriz de Horarios</h2>
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                    <h3 class="font-bold text-sm text-slate-500 uppercase mb-4">1. Selecci√≥n de Curso</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="relative group">
                            <select id="sched-section-select" class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl appearance-none focus:ring-2 focus:ring-blue-500 font-bold text-slate-700" onchange="updateSchedCourses()">
                                <option value="">Selecciona Secci√≥n...</option>
                            </select>
                        </div>
                         <div class="relative group">
                            <select id="sched-course-select" class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl appearance-none focus:ring-2 focus:ring-blue-500 font-bold text-slate-700" onchange="updateSchedParallels()" disabled>
                                <option value="">Selecciona Curso...</option>
                            </select>
                        </div>
                        <div class="relative group">
                            <select id="sched-parallel-select" class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl appearance-none focus:ring-2 focus:ring-blue-500 font-bold text-slate-700" onchange="loadScheduleMatrix()" disabled>
                                <option value="">Selecciona Paralelo...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="schedule-matrix-container" class="hidden animate-fade-in space-y-4">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <div>
                            <h3 class="font-bold text-blue-800">Configuraci√≥n de Horas</h3>
                            <p class="text-xs text-blue-600">A√±ade los bloques horarios para armar la matriz.</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <button onclick="openCopyScheduleModal()" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-200 transition border border-indigo-200 flex items-center gap-2">
                                <i class="fa-solid fa-copy"></i> Copiar a...
                            </button>
                            <form onsubmit="addPeriod(event)" class="flex gap-2 items-center">
                                <input type="time" id="period-start" required class="p-2 border border-blue-200 rounded-lg text-sm bg-white" title="Inicio">
                                <span class="text-blue-400 font-bold">-</span>
                                <input type="time" id="period-end" required class="p-2 border border-blue-200 rounded-lg text-sm bg-white" title="Fin">
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition">
                                    <i class="fa-solid fa-plus mr-1"></i> A√±adir Hora
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="glass-panel p-4 rounded-2xl overflow-x-auto">
                        <table class="matrix-table">
                            <thead>
                                <tr>
                                    <th class="w-[100px]"></th>
                                    <th class="matrix-th">Lunes</th>
                                    <th class="matrix-th">Martes</th>
                                    <th class="matrix-th">Mi√©rcoles</th>
                                    <th class="matrix-th">Jueves</th>
                                    <th class="matrix-th">Viernes</th>
                                    <th class="w-[50px]"></th>
                                </tr>
                            </thead>
                            <tbody id="matrix-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 7. REPORTES DE LECCIONARIO -->
            <div id="section-leccionario-report" class="hidden space-y-6">
                <div class="flex justify-between items-center no-print">
                    <h2 class="text-2xl font-black text-slate-800">Reportes de Leccionario</h2>
                </div>

                <div class="glass-panel p-6 rounded-2xl no-print">
                    <!-- Tabs de Reporte -->
                    <div class="border-b border-slate-200 mb-6 flex gap-2">
                        <button class="tab-btn tab-btn-individual active" onclick="switchTab(this, 'rep-tab-individual')">Por Curso</button>
                        <button class="tab-btn tab-btn-mass" onclick="switchTab(this, 'rep-tab-section')">Por Secci√≥n (Masivo)</button>
                    </div>

                    <!-- Datos Generales (Comunes) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 border-b border-slate-100 pb-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase">Instituci√≥n</label>
                            <input type="text" id="rep-institution" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" placeholder="Nombre de la Instituci√≥n">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase">C√≥digo Auditor√≠a</label>
                            <input type="text" id="rep-audit-code" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" placeholder="Ej: AUD-2024-001">
                        </div>
                    </div>

                    <!-- Tab Individual -->
                    <div id="rep-tab-individual" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Secci√≥n</label>
                                <select id="rep-section-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" onchange="updateRepCourses()">
                                    <option value="">Seleccione...</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Curso</label>
                                <select id="rep-course-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" onchange="updateRepParallels()" disabled>
                                    <option value="">Seleccione...</option>
                                </select>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Paralelo</label>
                                <select id="rep-parallel-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" disabled>
                                    <option value="">Seleccione...</option>
                                </select>
                            </div>
                             <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Fecha</label>
                                <input type="date" id="rep-date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                            </div>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button onclick="generateLeccionarioReport()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition">
                                <i class="fa-solid fa-file-invoice mr-2"></i> Generar Reporte Individual
                            </button>
                        </div>
                    </div>

                    <!-- Tab Por Secci√≥n -->
                    <div id="rep-tab-section" class="tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Secci√≥n a Imprimir</label>
                                <select id="rep-mass-section-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                                    <option value="">Seleccione Secci√≥n...</option>
                                </select>
                            </div>
                             <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase">Fecha del Reporte</label>
                                <input type="date" id="rep-mass-date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                            </div>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button onclick="generateSectionReport()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">
                                <i class="fa-solid fa-layer-group mr-2"></i> Generar Reporte Masivo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Contenedor del Reporte (Vista Previa / Impresi√≥n) -->
                <div id="report-container" class="hidden">
                    <div class="bg-white p-4 rounded-xl shadow mb-4 flex justify-between items-center no-print">
                        <h3 class="font-bold text-slate-700">Vista Previa</h3>
                        <button onclick="window.print()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700">
                            <i class="fa-solid fa-print mr-2"></i> Imprimir Reporte
                        </button>
                    </div>
                    
                    <!-- Aqu√≠ se inyectar√°n las p√°ginas del reporte -->
                    <div id="report-content-area" class="space-y-8 print:space-y-0"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL: CAMBIAR CONTRASE√ëA (NUEVO) -->
    <div id="modal-change-password" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 modal-animate shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xl mx-auto mb-2"><i class="fa-solid fa-key"></i></div>
                <h3 class="text-xl font-black text-slate-800">Cambiar Contrase√±a</h3>
                <p class="text-xs text-slate-400">Actualiza tu clave de acceso</p>
            </div>
            
            <form id="form-change-password" class="space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Nueva Contrase√±a</label>
                    <input type="password" id="new-password" required minlength="6" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" placeholder="M√≠nimo 6 caracteres">
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('modal-change-password')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold hover:bg-slate-200">Cancelar</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200">Actualizar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: EDICI√ìN DE USUARIO -->
    <div id="modal-user-edit" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-4">
        <!-- ... (Sin Cambios) ... -->
        <div class="bg-white w-full max-w-2xl rounded-3xl p-8 modal-animate max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">Datos de Usuario</h3>
                <button onclick="closeModal('modal-user-edit')" class="text-slate-400 hover:text-red-500 text-xl"><i class="fa-solid fa-times"></i></button>
            </div>
            <form id="form-user-edit" class="space-y-6">
                <input type="hidden" id="edit-uid">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Nombre</label>
                        <input type="text" id="edit-name" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Correo</label>
                        <input type="email" id="edit-email" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Rol</label>
                        <select id="edit-rol" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold">
                            <option value="Docente">Docente</option>
                            <option value="Admin">Administrador</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">Nueva Firma (Opcional)</label>
                        <input type="file" id="edit-signature" accept="image/*" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs">
                    </div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100 flex items-center gap-3">
                    <input type="checkbox" id="edit-is-super" class="w-5 h-5 accent-yellow-600 rounded">
                    <div>
                        <p class="text-xs font-bold text-yellow-800 uppercase">Super Administrador</p>
                        <p class="text-[10px] text-yellow-600">Acceso total al sistema y configuraci√≥n.</p>
                    </div>
                </div>
                <div class="flex justify-end pt-4 border-t border-slate-100">
                    <button type="button" onclick="closeModal('modal-user-edit')" class="px-6 py-2 text-sm font-bold text-slate-500 hover:bg-slate-50 rounded-xl mr-2">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-8 py-2 rounded-xl text-sm font-black uppercase hover:bg-blue-700 shadow-lg shadow-blue-200">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: ASIGNAR MATERIA (HORARIO) -->
    <div id="modal-assign-subject" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-4">
        <!-- ... (Sin Cambios) ... -->
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 modal-animate shadow-2xl">
            <h3 class="text-lg font-black text-slate-800 mb-1">Asignar Materia</h3>
            <p class="text-xs text-slate-400 mb-4" id="assign-modal-subtitle">Lunes 07:00 - 07:40</p>
            <input type="hidden" id="assign-period-id">
            <input type="hidden" id="assign-day">
            <div class="space-y-4">
                <select id="assign-subject-select" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold text-slate-700">
                    <option value="">-- Seleccionar --</option>
                </select>
                <div class="flex gap-2 pt-2">
                    <button onclick="removeAssignment()" class="flex-1 bg-red-50 text-red-500 py-2 rounded-xl text-xs font-bold hover:bg-red-100">
                        <i class="fa-solid fa-trash mr-1"></i> Borrar
                    </button>
                    <button onclick="saveAssignment()" class="flex-1 bg-blue-600 text-white py-2 rounded-xl text-xs font-bold hover:bg-blue-700 shadow-lg shadow-blue-200">
                        <i class="fa-solid fa-check mr-1"></i> Guardar
                    </button>
                </div>
            </div>
            <button onclick="closeModal('modal-assign-subject')" class="absolute top-4 right-4 text-slate-300 hover:text-slate-500"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <!-- MODAL: COPIAR HORARIO -->
    <div id="modal-copy-schedule" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 modal-animate shadow-2xl flex flex-col max-h-[85vh]">
            <h3 class="text-xl font-black text-slate-800 mb-1">Copiar Horario</h3>
            <p class="text-xs text-slate-500 mb-4">Selecciona los cursos destino para copiar el horario actual.</p>
            
            <div class="flex-1 overflow-y-auto pr-2 space-y-2" id="copy-targets-list">
                <!-- Checkboxes generated by JS -->
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100 flex gap-2">
                <button onclick="closeModal('modal-copy-schedule')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold hover:bg-slate-200 text-xs">Cancelar</button>
                <button onclick="confirmCopySchedule()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 text-xs flex items-center justify-center gap-2">
                    <i class="fa-solid fa-copy"></i> Copiar Horario
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL: FIRMAR LECCIONARIO -->
    <div id="modal-sign-leccionario" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl p-8 modal-animate shadow-2xl">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xl"><i class="fa-solid fa-file-signature"></i></div>
                <div>
                    <h3 class="text-xl font-black text-slate-800">Firmar Leccionario</h3>
                    <p class="text-xs text-slate-500" id="sign-class-info">Matem√°ticas | 10mo A</p>
                </div>
            </div>

            <form id="form-sign-leccionario" class="space-y-4">
                <input type="hidden" id="sign-entry-id"> <!-- ID para edici√≥n -->
                <input type="hidden" id="sign-schedule-id">
                <input type="hidden" id="sign-course-id">
                <input type="hidden" id="sign-subject-id">
                <input type="hidden" id="sign-period-start">
                <input type="hidden" id="sign-period-end">

                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Tema de Clase</label>
                    <input type="text" id="sign-topic" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium" placeholder="Ej: Introducci√≥n al √Ålgebra">
                </div>
                
                <div class="space-y-1">
                    <label class="text-xs font-bold text-slate-500 uppercase">Observaciones (Opcional)</label>
                    <textarea id="sign-obs" rows="3" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm" placeholder="Novedades ocurridas en clase..."></textarea>
                </div>

                <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-xl flex gap-3 items-start">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-600 mt-1"></i>
                    <p class="text-xs text-yellow-800 leading-relaxed">
                        Al firmar, est√°s certificando que la clase fue impartida en el horario establecido. Se estampar√° tu firma digital autom√°ticamente.
                    </p>
                </div>

                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('modal-sign-leccionario')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold hover:bg-slate-200">Cancelar</button>
                    <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-200 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-pen-nib"></i> Firmar y Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, deleteDoc, addDoc, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN ---
        const firebaseConfig = { 
            apiKey: "AIzaSyB1eXkCiF5VZcTin0W5hBQv2X2PEE2bAJc", 
            authDomain: "leccionario-virtual.firebaseapp.com", 
            projectId: "leccionario-virtual", 
            storageBucket: "leccionario-virtual.firebasestorage.app", 
            messagingSenderId: "731785058376", 
            appId: "1:731785058376:web:161550bdc3941e1a64207d" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ESTADO GLOBAL ---
        let currentUser = null;
        let globalData = {
            users: [],
            sections: [],
            areas: [],
            subjects: [],
            courses: [],
            distributive: [],
            schedules: [], // All schedules needed for day view
            course_periods: [],
            currentPeriods: [], // Filas del horario
            currentAssignments: [], // Celdas del horario
            dailyClasses: [] // Cache for dashboard interactions
        };
        
        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loader');
            const statusDot = document.getElementById('db-status-dot');

            if (user) {
                try {
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        currentUser = { uid: user.uid, ...userSnap.data() };
                        initApp(currentUser);
                        if(statusDot) { statusDot.classList.replace('bg-yellow-400', 'bg-green-500'); statusDot.classList.remove('animate-pulse'); }
                    } else {
                        console.warn("User auth exists but firestore doc missing (Deleted?). Logging out.");
                        await signOut(auth);
                        showToast("Usuario no encontrado o eliminado.", 'error');
                        showAuthView();
                    }

                } catch (error) {
                    console.error("Error fetching user:", error);
                    showToast("Error de conexi√≥n parcial", 'error');
                }
            } else {
                showAuthView();
            }
            if(loader) loader.style.opacity = 0;
            setTimeout(() => { if(loader) loader.style.display = 'none'; }, 500);
        });

        // --- APP INIT ---
        async function initApp(user) {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            
            document.getElementById('user-name-display').textContent = user.nombre || "Usuario";
            document.getElementById('user-email-display').textContent = user.email;
            document.getElementById('user-role-label').textContent = user.rol;
            
            const superAdmins = ["gasencio@ecomundo.edu.ec", "ajuanazo@ecomundo.edu.ec"];
            const isAdmin = user.isSuperAdmin || superAdmins.includes(user.email) || user.rol === 'Admin';
            
            // Cargar datos - CON MANEJO DE ERRORES ROBUSTO
            try {
                await loadAllAcademicData(isAdmin); 
            } catch (e) {
                console.error("Error loading academic data", e);
            }

            loadSavedReportConfig();
            loadSchoolCycle(); // Load saved cycle name

            if (isAdmin) {
                document.getElementById('btn-admin-panel').classList.remove('hidden');
                document.getElementById('nav-academic').classList.remove('hidden');
                document.getElementById('nav-reports').classList.remove('hidden');
                showSection('dashboard');
            } else {
                // Para Docentes, nos aseguramos que estos elementos est√©n ocultos
                document.getElementById('btn-admin-panel').classList.add('hidden');
                document.getElementById('nav-academic').classList.add('hidden');
                document.getElementById('nav-reports').classList.add('hidden');
                showSection('dashboard');
            }
            
            renderDailyDashboard();
            loadTeacherAssignments(user.uid);
        }

        function showAuthView() {
            document.getElementById('app-view').classList.add('hidden');
            document.getElementById('auth-view').classList.remove('hidden');
        }

        // --- CAMBIAR CONTRASE√ëA ---
        document.getElementById('form-change-password').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPass = document.getElementById('new-password').value;
            const user = auth.currentUser;

            if (user) {
                try {
                    await updatePassword(user, newPass);
                    showToast("Contrase√±a actualizada exitosamente");
                    window.closeModal('modal-change-password');
                    document.getElementById('form-change-password').reset();
                } catch (error) {
                    if (error.code === 'auth/requires-recent-login') {
                        showToast("Por seguridad, debes volver a iniciar sesi√≥n para cambiar la contrase√±a", 'error');
                        await signOut(auth);
                        window.location.reload();
                    } else {
                        showToast("Error al cambiar contrase√±a: " + error.message, 'error');
                    }
                }
            }
        });

        // --- PERSISTENCIA Y UTILIDADES DE UI ---
        window.loadSavedReportConfig = () => {
            const inst = localStorage.getItem('rep_institution');
            const code = localStorage.getItem('rep_audit_code');
            if(inst) document.getElementById('rep-institution').value = inst;
            if(code) document.getElementById('rep-audit-code').value = code;
        };

        window.saveReportConfig = () => {
            const inst = document.getElementById('rep-institution').value;
            const code = document.getElementById('rep-audit-code').value;
            localStorage.setItem('rep_institution', inst);
            localStorage.setItem('rep_audit_code', code);
        };

        window.loadSchoolCycle = () => {
            const cycle = localStorage.getItem('school_cycle') || "Ciclo Escolar 2024-2025";
            document.getElementById('school-cycle-display').textContent = cycle;
        };

        window.editSchoolCycle = () => {
            const current = document.getElementById('school-cycle-display').textContent;
            const newCycle = prompt("Ingrese el nombre del Ciclo Escolar:", current);
            if (newCycle) {
                localStorage.setItem('school_cycle', newCycle);
                document.getElementById('school-cycle-display').textContent = newCycle;
                showToast("Ciclo escolar actualizado");
            }
        };

        // --- DASHBOARD: AGENDA DIARIA ---
        window.renderDailyDashboard = async () => {
            const container = document.getElementById('dashboard-daily-schedule');
            const dateLabel = document.getElementById('current-date-label');
            
            // 1. Determinar D√≠a
            const days = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
            const now = new Date();
            const todayName = days[now.getDay()];
            const todayStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const fullDate = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            dateLabel.textContent = fullDate.charAt(0).toUpperCase() + fullDate.slice(1);

            const myDistributive = globalData.distributive.filter(d => d.teacherId === currentUser.uid);
            
            if (myDistributive.length === 0) {
                 container.innerHTML = `<div class="text-center py-10"><p class="text-slate-400">No tienes carga horaria asignada.</p></div>`;
                 return;
            }

            // Fetch fresco de Entries de HOY para este profesor
            const qEntries = query(collection(db, "leccionario_entries"), 
                where("teacherId", "==", currentUser.uid),
                where("date", "==", todayStr)
            );
            const snapEntries = await getDocs(qEntries);
            const myEntries = [];
            snapEntries.forEach(d => myEntries.push({id: d.id, ...d.data()})); // Include ID

            // Fetch Schedules
            const schedSnap = await getDocs(collection(db, "schedules"));
            const allSchedules = [];
            schedSnap.forEach(d => allSchedules.push({id: d.id, ...d.data()}));
            
            const perSnap = await getDocs(collection(db, "course_periods"));
            const allPeriods = [];
            perSnap.forEach(d => allPeriods.push({id: d.id, ...d.data()}));

            let todaysClasses = [];

            myDistributive.forEach(dist => {
                const matches = allSchedules.filter(s => 
                    s.courseId === dist.courseId && 
                    s.parallel === dist.parallel && 
                    s.subjectId === dist.subjectId &&
                    s.day === todayName
                );

                matches.forEach(match => {
                    const period = allPeriods.find(p => p.id === match.periodId);
                    if (period) {
                        // Check if registered
                        const existingEntry = myEntries.find(e => e.scheduleId === match.id);

                        todaysClasses.push({
                            scheduleId: match.id,
                            distributiveId: dist.id,
                            subjectId: dist.subjectId,
                            courseId: dist.courseId,
                            parallel: dist.parallel,
                            start: period.start,
                            end: period.end,
                            subjectName: globalData.subjects.find(s => s.id === dist.subjectId)?.name,
                            courseName: globalData.courses.find(c => c.id === dist.courseId)?.name,
                            isRegistered: !!existingEntry,
                            entryId: existingEntry ? existingEntry.id : null,
                            savedTopic: existingEntry ? existingEntry.topic : '',
                            savedObs: existingEntry ? existingEntry.observation : ''
                        });
                    }
                });
            });

            todaysClasses.sort((a,b) => a.start.localeCompare(b.start));
            
            // Store for easy access in modal
            globalData.dailyClasses = todaysClasses;

            if (todaysClasses.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-3xl border border-slate-100">
                        <div class="inline-flex w-16 h-16 bg-green-50 rounded-full items-center justify-center text-2xl mb-4">‚òï</div>
                        <h3 class="font-bold text-slate-700">¬°D√≠a Libre!</h3>
                        <p class="text-slate-400 text-sm">No tienes clases programadas para hoy ${todayName}.</p>
                    </div>`;
                return;
            }

            container.innerHTML = todaysClasses.map((cls, index) => {
                const statusColor = cls.isRegistered ? 'border-green-500' : 'border-blue-600';
                const statusBg = cls.isRegistered ? 'bg-green-50' : 'bg-white';
                const btnText = cls.isRegistered ? 'Ver / Editar' : 'Registrar Lecci√≥n';
                const btnColor = cls.isRegistered ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-800 hover:bg-slate-700';
                const badge = cls.isRegistered ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold uppercase ml-2">‚úÖ Registrado</span>' : '';

                return `
                <div class="${statusBg} p-5 rounded-2xl border-l-4 ${statusColor} shadow-sm flex flex-col md:flex-row items-center justify-between gap-4 transition hover:shadow-md">
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <div class="bg-white border border-slate-200 px-4 py-2 rounded-xl text-center min-w-[90px]">
                            <span class="block text-lg font-black text-slate-700">${cls.start}</span>
                            <span class="block text-xs font-bold text-slate-400">a ${cls.end}</span>
                        </div>
                        <div>
                            <h4 class="text-lg font-black text-slate-800 flex items-center">
                                ${cls.subjectName} ${badge}
                            </h4>
                            <p class="text-sm text-slate-500 font-medium">
                                <i class="fa-solid fa-users text-xs mr-1"></i> ${cls.courseName} "<strong>${cls.parallel}</strong>"
                            </p>
                        </div>
                    </div>
                    
                    <button onclick="openSignModal('${index}')" 
                        class="w-full md:w-auto ${btnColor} text-white px-6 py-3 rounded-xl font-bold text-sm transition flex items-center justify-center gap-2 shadow-lg shadow-slate-200">
                        <i class="fa-solid fa-pen-nib"></i> ${btnText}
                    </button>
                </div>
                `;
            }).join('');
        };

        // --- FIRMA DE LECCIONARIO (CON MODO EDICI√ìN) ---
        window.openSignModal = (index) => {
            // Validar Firma
            if (!currentUser.firma) {
                showToast("‚ö†Ô∏è ERROR: No tienes firma digital configurada. Ve a tu perfil.", 'error');
                return;
            }

            const cls = globalData.dailyClasses[index];
            if (!cls) return;

            document.getElementById('sign-class-info').textContent = `${cls.subjectName} | ${cls.courseName} "${cls.parallel}"`;
            
            // Set hidden fields
            document.getElementById('sign-schedule-id').value = cls.scheduleId;
            document.getElementById('sign-course-id').value = cls.courseId;
            document.getElementById('sign-subject-id').value = cls.subjectId;
            document.getElementById('sign-period-start').value = cls.start;
            document.getElementById('sign-period-end').value = cls.end;
            
            // Set data for Edit Mode
            document.getElementById('sign-entry-id').value = cls.entryId || "";
            document.getElementById('sign-topic').value = cls.savedTopic || "";
            document.getElementById('sign-obs').value = cls.savedObs || "";
            
            window.openModal('modal-sign-leccionario');
        };

        document.getElementById('form-sign-leccionario').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.submitter;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';
            btn.disabled = true;

            const entryId = document.getElementById('sign-entry-id').value;
            
            const data = {
                teacherId: currentUser.uid,
                teacherName: currentUser.nombre,
                scheduleId: document.getElementById('sign-schedule-id').value,
                courseId: document.getElementById('sign-course-id').value,
                subjectId: document.getElementById('sign-subject-id').value,
                topic: document.getElementById('sign-topic').value,
                observation: document.getElementById('sign-obs').value,
                date: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                timestamp: new Date().toISOString(),
                signatureSnapshot: currentUser.firma,
                periodStart: document.getElementById('sign-period-start').value,
                periodEnd: document.getElementById('sign-period-end').value
            };

            try {
                if (entryId) {
                    // Update
                    await updateDoc(doc(db, "leccionario_entries", entryId), data);
                    showToast("‚úÖ Leccionario Actualizado");
                } else {
                    // Create
                    await addDoc(collection(db, "leccionario_entries"), data);
                    showToast("‚úÖ Leccionario Firmado y Guardado");
                }
                window.closeModal('modal-sign-leccionario');
                renderDailyDashboard();
            } catch (error) {
                showToast("Error al guardar: " + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // --- REPORTES ---
        // Helper auxiliar HTML
        async function buildReportHTML(courseId, parallel, dateStr, institution, auditCode, dayName) {
            const qSched = query(collection(db, "schedules"), 
                where("courseId", "==", courseId), 
                where("parallel", "==", parallel),
                where("day", "==", dayName)
            );
            const snapSched = await getDocs(qSched);
            let schedules = [];
            snapSched.forEach(d => schedules.push({id: d.id, ...d.data()}));

            if(schedules.length === 0) return null;

            const qEntries = query(collection(db, "leccionario_entries"), 
                where("courseId", "==", courseId), 
                where("date", "==", dateStr) 
            );
            const snapEntries = await getDocs(qEntries);
            let entries = [];
            snapEntries.forEach(d => entries.push({id: d.id, ...d.data()}));

            const qPeriods = query(collection(db, "course_periods"), 
                where("courseId", "==", courseId), 
                where("parallel", "==", parallel)
            );
            const snapPeriods = await getDocs(qPeriods);
            let periods = [];
            snapPeriods.forEach(d => periods.push({id: d.id, ...d.data()}));

            let reportRows = schedules.map(sched => {
                const period = periods.find(p => p.id === sched.periodId);
                const entry = entries.find(e => e.scheduleId === sched.id);
                const subject = globalData.subjects.find(s => s.id === sched.subjectId);
                
                const distItem = globalData.distributive.find(d => 
                    d.courseId === courseId && d.parallel === parallel && d.subjectId === sched.subjectId
                );
                const teacher = globalData.users.find(u => u.id === distItem?.teacherId);

                return {
                    start: period ? period.start : "00:00",
                    end: period ? period.end : "00:00",
                    subjectName: subject ? subject.name : "Desconocida",
                    teacherName: teacher ? teacher.nombre : "Sin Asignar",
                    topic: entry ? entry.topic : "NO FIRMADO",
                    observation: entry ? entry.observation : "NO FIRMADO",
                    signature: entry ? entry.signatureSnapshot : null,
                    isSigned: !!entry
                };
            });

            reportRows.sort((a,b) => a.start.localeCompare(b.start));
            
            // Fetch Section Data for Report
            const courseObj = globalData.courses.find(c => c.id === courseId);
            const sectionObj = courseObj ? globalData.sections.find(s => s.id === courseObj.sectionId) : null;
            const sectionName = sectionObj ? sectionObj.name : "SECCI√ìN DESCONOCIDA";
            const cycleName = localStorage.getItem('school_cycle') || "2025-2026"; // Fallback/Default
            
            return `
            <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-200 print:shadow-none print:border-none print-break-after" style="font-family: 'Arial', sans-serif; font-size: 10pt;">
                
                <!-- Row 1: Logo & Audit Code -->
                <div class="flex justify-between items-center mb-1" style="font-family: 'Calibri', sans-serif; font-size: 11pt;">
                    <div><img src="logo.png" alt="Logo" class="h-16 object-contain"></div> <!-- Adjusted height assumption -->
                    <div class="font-bold">${auditCode}</div>
                </div>

                <!-- Row 2: Institution -->
                <div class="text-center font-bold mb-1" style="font-family: 'Calibri', sans-serif; font-size: 11pt;">
                    ${institution.toUpperCase()}
                </div>

                <!-- Row 3: Section -->
                <div class="text-center font-bold mb-4" style="font-family: 'Calibri', sans-serif; font-size: 11pt;">
                    ${sectionName.toUpperCase()}
                </div>

                <!-- Row 4: Course & Parallel (Right) -->
                <div class="text-right font-bold mb-2">
                    ${courseObj ? courseObj.name : "---"} - PARALELO: ${parallel}
                </div>

                <!-- Row 5: Cycle -->
                <div class="text-center font-bold mb-2 uppercase">
                    LECCIONARIO ${cycleName}
                </div>

                <!-- Row 6: Day & Date -->
                <div class="flex justify-between items-center mb-2 pb-1">
                    <div class="font-bold uppercase">D√çA: ${dayName}</div>
                    <div class="font-bold">${dateStr}</div>
                </div>

                <!-- Table Content (Arial 10pt) -->
                <div class="overflow-hidden border border-slate-800 rounded-none">
                    <table class="w-full" style="font-size: 10pt;">
                        <thead>
                            <tr class="bg-slate-100 border-b border-slate-800" style="font-size: 12pt;">
                                <th class="border-r border-slate-800 p-1 text-center w-16">HORA</th>
                                <th class="border-r border-slate-800 p-1 text-center">MATERIA</th>
                                <th class="border-r border-slate-800 p-1 text-center">TEMA TRATADO</th>
                                <th class="border-r border-slate-800 p-1 text-center">DOCENTE</th>
                                <th class="border-r border-slate-800 p-1 text-center w-24">FIRMA</th>
                                <th class="p-1 text-center">OBSERVACI√ìN</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportRows.map(row => {
                                const isReceso = row.subjectName.toUpperCase().includes("RECESO");
                                if (isReceso) {
                                    return `
                                    <tr class="border-b border-slate-800 bg-gray-200 print:bg-gray-200">
                                        <td class="p-1 border-r border-slate-800 text-center align-middle font-bold">
                                            <div>${row.start}</div>
                                            <div>${row.end}</div>
                                        </td>
                                        <td colspan="5" class="p-1 border-slate-800 text-center align-middle font-black tracking-widest text-slate-600">
                                            RECESO
                                        </td>
                                    </tr>
                                    `;
                                } else {
                                    return `
                                    <tr class="border-b border-slate-800 hover:bg-slate-50">
                                        <td class="p-1 border-r border-slate-800 text-center align-middle">
                                            <div>${row.start}</div>
                                            <div>${row.end}</div>
                                        </td>
                                        <td class="p-1 border-r border-slate-800 font-bold align-middle">
                                            ${row.subjectName}
                                        </td>
                                        <td class="p-1 border-r border-slate-800 align-middle ${!row.isSigned ? 'text-red-500 font-bold' : ''}">
                                            ${row.topic}
                                        </td>
                                        <td class="p-1 border-r border-slate-800 align-middle text-center italic">
                                            ${row.teacherName}
                                        </td>
                                        <td class="p-1 border-r border-slate-800 text-center align-middle">
                                            ${row.isSigned && row.signature 
                                                ? `<img src="${row.signature}" class="h-8 mx-auto object-contain" style="mix-blend-mode: multiply;">` 
                                                : `<span class="text-xs text-red-500 font-bold">NO FIRMADO</span>`} 
                                        </td>
                                        <td class="p-1 align-middle ${!row.isSigned ? 'text-red-500 font-bold' : ''}">
                                            ${row.observation || ''}
                                        </td>
                                    </tr>
                                    `;
                                }
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-2 text-right text-[8px] text-slate-400">
                    Generado el ${new Date().toLocaleDateString()} | Creado por: GAscencio
                </div>
            </div>`;
        }

        window.generateLeccionarioReport = async () => {
            saveReportConfig();
            const sectionId = document.getElementById('rep-section-select').value;
            const courseId = document.getElementById('rep-course-select').value;
            const parallel = document.getElementById('rep-parallel-select').value;
            const dateStr = document.getElementById('rep-date').value;
            const institution = document.getElementById('rep-institution').value;
            const auditCode = document.getElementById('rep-audit-code').value;

            if(!sectionId || !courseId || !parallel || !dateStr || !institution || !auditCode) {
                showToast("Por favor complete todos los campos.", 'error');
                return;
            }

            const dateObj = new Date(dateStr + 'T00:00:00');
            const days = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
            const dayName = days[dateObj.getDay()];

            const html = await buildReportHTML(courseId, parallel, dateStr, institution, auditCode, dayName);
            
            if (!html) {
                showToast(`No hay clases programadas para el ${dayName}.`, 'error');
                return;
            }

            const area = document.getElementById('report-content-area');
            area.innerHTML = html;
            document.getElementById('report-container').classList.remove('hidden');
            area.scrollIntoView({ behavior: 'smooth' });
        };

        window.generateSectionReport = async () => {
            saveReportConfig();
            const sectionId = document.getElementById('rep-mass-section-select').value;
            const dateStr = document.getElementById('rep-mass-date').value;
            const institution = document.getElementById('rep-institution').value;
            const auditCode = document.getElementById('rep-audit-code').value;

            if(!sectionId || !dateStr || !institution || !auditCode) {
                showToast("Complete secci√≥n, fecha y datos institucionales.", 'error');
                return;
            }

            const dateObj = new Date(dateStr + 'T00:00:00');
            const days = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
            const dayName = days[dateObj.getDay()];

            const courses = globalData.courses.filter(c => c.sectionId === sectionId);
            if (courses.length === 0) return showToast("No hay cursos en esta secci√≥n.", 'error');

            const area = document.getElementById('report-content-area');
            area.innerHTML = '<div class="text-center p-10"><i class="fa-solid fa-spinner fa-spin text-3xl text-blue-500"></i><p>Generando reportes masivos...</p></div>';
            document.getElementById('report-container').classList.remove('hidden');

            let combinedHTML = "";
            let count = 0;

            for (const course of courses) {
                for (const parallel of course.parallels) {
                    const html = await buildReportHTML(course.id, parallel, dateStr, institution, auditCode, dayName);
                    if (html) {
                        combinedHTML += html;
                        count++;
                    }
                }
            }

            if (count === 0) {
                area.innerHTML = `<div class="text-center p-10 text-red-500">No se encontraron clases programadas para esta secci√≥n en ${dayName}.</div>`;
            } else {
                area.innerHTML = combinedHTML;
                showToast(`Generados ${count} reportes.`);
            }
        };

        // --- CARGADORES DE DATOS ---

        async function loadAllAcademicData(isAdmin) {
            // Cargas esenciales para todos
            await Promise.all([
                loadSections(),
                loadAreas(),
                loadSubjects(),
                loadCourses(),
                loadDistributive()
            ]);
            
            // Cargas solo para Admin (evitar error de permisos)
            if (isAdmin) {
                try {
                    await loadUsers();
                } catch(e) {
                    console.warn("Could not load users list (Permission denied?):", e);
                }
            }
            
            updateDropdowns();
        }

        // 1. Usuarios (CORREGIDO: FIRMA VISIBLE)
        window.loadUsers = async () => {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center p-8"><i class="fa-solid fa-spinner fa-spin"></i></td></tr>`;
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                globalData.users = [];
                querySnapshot.forEach((doc) => globalData.users.push({id: doc.id, ...doc.data()}));
                
                if (globalData.users.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4">Sin datos</td></tr>`; return; }

                tbody.innerHTML = globalData.users.map(u => `
                    <tr>
                        <td>
                            <div class="font-bold text-slate-800">${u.nombre || "Sin Nombre"}</div>
                            <div class="text-xs text-slate-400">${u.email}</div>
                        </td>
                        <td>${u.firma ? `<img src="${u.firma}" class="h-8 w-auto object-contain" style="mix-blend-mode: multiply;">` : '<span class="text-xs text-red-300">Sin Firma</span>'}</td>
                        <td><span class="role-badge role-${u.rol}">${u.rol}</span></td>
                        <td class="text-right flex justify-end gap-2">
                            <button onclick="window.editUser('${u.id}')" class="text-blue-600 p-2 hover:bg-blue-50 rounded"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="window.deleteUser('${u.id}')" class="text-red-500 p-2 hover:bg-red-50 rounded" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            } catch (e) { 
                console.error("Error loading users:", e); 
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-400">Error de permisos</td></tr>`;
                throw e; // Re-throw to be caught in initApp
            }
        };

        window.deleteUser = async (id) => {
            if(!confirm("ADVERTENCIA: ¬øRealmente desea eliminar este usuario de la base de datos?")) return;
            try { 
                await deleteDoc(doc(db, "users", id)); 
                // Actualizar la tabla localmente sin recargar toda la p√°gina si es posible, o recargar
                showToast("Usuario eliminado correctamente"); 
                // Si el usuario borrado es el actual, salir
                if(currentUser && currentUser.uid === id) {
                    await handleLogout();
                } else {
                    await loadUsers(); 
                }
            } catch(e) { 
                showToast("Error al eliminar: " + e.message, 'error'); 
            }
        };

        // 2-6. Datos Acad√©micos (Sections, Areas, Subjects, Courses, Distributive)
        // (Funciones similares abreviadas para ahorrar espacio, l√≥gica id√©ntica a versi√≥n anterior)
        window.loadSections = async () => { const s = await getDocs(collection(db, "sections")); globalData.sections=[]; s.forEach(d=>globalData.sections.push({id:d.id,...d.data()})); renderSimpleTable('sections-table-body', globalData.sections, 'sections'); };
        window.loadAreas = async () => { const s = await getDocs(collection(db, "areas")); globalData.areas=[]; s.forEach(d=>globalData.areas.push({id:d.id,...d.data()})); renderSimpleTable('areas-table-body', globalData.areas, 'areas'); };
        window.loadSubjects = async () => { const s = await getDocs(collection(db, "subjects")); globalData.subjects=[]; s.forEach(d=>globalData.subjects.push({id:d.id,...d.data()})); renderSubjectsTable(); };
        window.loadCourses = async () => { const s = await getDocs(collection(db, "courses")); globalData.courses=[]; s.forEach(d=>globalData.courses.push({id:d.id,...d.data()})); renderCoursesTable(); };
        window.loadDistributive = async () => { const s = await getDocs(collection(db, "distributive")); globalData.distributive=[]; s.forEach(d=>globalData.distributive.push({id:d.id,...d.data()})); renderDistributiveTable(); };

        function renderSimpleTable(id, data, col) {
            document.getElementById(id).innerHTML = data.map(i => `<tr><td class="font-bold">${i.name}</td><td class="text-right"><button onclick="deleteItem('${col}','${i.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('');
        }
        function renderSubjectsTable() {
            document.getElementById('subjects-table-body').innerHTML = globalData.subjects.map(s => {
                const area = globalData.areas.find(a => a.id === s.areaId)?.name || '---';
                return `<tr><td class="font-bold">${s.name}</td><td class="text-xs uppercase">${area}</td><td class="text-right"><button onclick="deleteItem('subjects','${s.id}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            }).join('');
        }
        function renderCoursesTable() {
             document.getElementById('courses-table-body').innerHTML = globalData.courses.map(c => {
                const sec = globalData.sections.find(s => s.id === c.sectionId)?.name || '---';
                return `<tr><td class="font-bold">${c.name}</td><td class="text-xs">${sec}</td><td>${c.parallels.join(', ')}</td><td class="text-right"><button onclick="deleteItem('courses','${c.id}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            }).join('');
        }
        function renderDistributiveTable() {
            document.getElementById('distributive-table-body').innerHTML = globalData.distributive.map(d => {
                const t = globalData.users.find(u => u.id === d.teacherId)?.nombre || '---';
                const s = globalData.subjects.find(s => s.id === d.subjectId)?.name || '---';
                const c = globalData.courses.find(c => c.id === d.courseId)?.name || '---';
                return `<tr><td class="font-bold text-sm">${t}</td><td class="text-xs"><span class="font-bold">${c}</span> (${d.parallel})</td><td class="text-sm">${s}</td><td class="text-right"><button onclick="deleteItem('distributive','${d.id}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            }).join('');
        }

        // 7. Dashboard Resumen
        window.loadTeacherAssignments = async (teacherId) => {
            const container = document.getElementById('dashboard-cards');
            const myAssignments = globalData.distributive.filter(d => d.teacherId === teacherId);
            // No mostrar mensaje vac√≠o aqu√≠ para no duplicar con el calendario, solo dejar vac√≠o o cards
            if (myAssignments.length === 0) { container.innerHTML = ""; return; }
            
            container.innerHTML = myAssignments.map(assign => {
                const subject = globalData.subjects.find(s => s.id === assign.subjectId);
                const course = globalData.courses.find(c => c.id === assign.courseId);
                const hue = (parseInt(assign.subjectId.substr(0, 2), 16) * 137) % 360;
                return `
                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-[hsl(${hue},70%,90%)] rounded-bl-full opacity-50"></div>
                    <div class="relative z-10">
                        <h3 class="text-sm font-black text-slate-800 leading-tight mb-1 truncate">${subject?.name || 'Materia'}</h3>
                        <p class="text-xs text-slate-500">${course?.name || 'Curso'} (${assign.parallel})</p>
                    </div>
                </div>`;
            }).join('');
        };

        // --- GESTI√ìN DE HORARIOS (MATRIZ & COPIA) ---

        window.updateSchedCourses = () => {
            const sectionId = document.getElementById('sched-section-select').value;
            const courseSel = document.getElementById('sched-course-select');
            const parSel = document.getElementById('sched-parallel-select');
            courseSel.innerHTML = '<option value="">Selecciona Curso...</option>';
            parSel.innerHTML = '<option value="">Selecciona Paralelo...</option>';
            parSel.disabled = true;
            document.getElementById('schedule-matrix-container').classList.add('hidden');

            if (!sectionId) { courseSel.disabled = true; return; }
            courseSel.innerHTML += globalData.courses.filter(c => c.sectionId === sectionId).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            courseSel.disabled = false;
        };

        window.updateSchedParallels = () => {
            const courseId = document.getElementById('sched-course-select').value;
            const parSel = document.getElementById('sched-parallel-select');
            parSel.innerHTML = '<option value="">Selecciona Paralelo...</option>';
            document.getElementById('schedule-matrix-container').classList.add('hidden');

            if (!courseId) { parSel.disabled = true; return; }
            const course = globalData.courses.find(c => c.id === courseId);
            if (course) {
                parSel.innerHTML += course.parallels.map(p => `<option value="${p}">${p}</option>`).join('');
                parSel.disabled = false;
            }
        };

        window.loadScheduleMatrix = async () => {
            const courseId = document.getElementById('sched-course-select').value;
            const parallel = document.getElementById('sched-parallel-select').value;
            
            if (!courseId || !parallel) return;
            document.getElementById('schedule-matrix-container').classList.remove('hidden');
            
            // 1. Cargar Periodos (Filas)
            const qPeriods = query(collection(db, "course_periods"), where("courseId", "==", courseId), where("parallel", "==", parallel));
            const snapP = await getDocs(qPeriods);
            globalData.currentPeriods = [];
            snapP.forEach(d => globalData.currentPeriods.push({id: d.id, ...d.data()}));
            globalData.currentPeriods.sort((a,b) => a.start.localeCompare(b.start));

            // 2. Cargar Asignaciones (Celdas)
            const qAssign = query(collection(db, "schedules"), where("courseId", "==", courseId), where("parallel", "==", parallel));
            const snapA = await getDocs(qAssign);
            globalData.currentAssignments = [];
            snapA.forEach(d => globalData.currentAssignments.push({id: d.id, ...d.data()}));

            renderMatrix();
        };

        function renderMatrix() {
            const tbody = document.getElementById('matrix-body');
            tbody.innerHTML = '';

            globalData.currentPeriods.forEach(period => {
                const tr = document.createElement('tr');
                
                // Columna de Hora
                const tdTime = document.createElement('td');
                tdTime.className = 'matrix-time-cell';
                tdTime.innerHTML = `<div>${period.start}<br><span class="text-xs text-blue-300">|</span><br>${period.end}</div>`;
                tr.appendChild(tdTime);

                // Columnas de D√≠as
                const days = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes"];
                days.forEach(day => {
                    const td = document.createElement('td');
                    td.className = 'matrix-cell';
                    
                    // Buscar asignaci√≥n existente
                    const assign = globalData.currentAssignments.find(a => a.periodId === period.id && a.day === day);
                    
                    if (assign) {
                        const subjectName = globalData.subjects.find(s => s.id === assign.subjectId)?.name || '???';
                        td.innerHTML = `
                            <div class="matrix-cell-content">
                                <span class="matrix-subject">${subjectName}</span>
                            </div>`;
                        td.onclick = () => openAssignModal(period.id, day, period.start, period.end, assign.subjectId, assign.id);
                    } else {
                        td.innerHTML = `<div class="matrix-cell-content"><i class="fa-solid fa-plus matrix-add-icon"></i></div>`;
                        td.onclick = () => openAssignModal(period.id, day, period.start, period.end, null, null);
                    }
                    tr.appendChild(td);
                });

                // Bot√≥n Borrar Fila
                const tdAction = document.createElement('td');
                tdAction.className = 'text-center align-middle';
                tdAction.innerHTML = `<button onclick="deletePeriod('${period.id}')" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>`;
                tr.appendChild(tdAction);

                tbody.appendChild(tr);
            });
        }

        window.addPeriod = async (e) => {
            e.preventDefault();
            const start = document.getElementById('period-start').value;
            const end = document.getElementById('period-end').value;
            const courseId = document.getElementById('sched-course-select').value;
            const parallel = document.getElementById('sched-parallel-select').value;

            try {
                await addDoc(collection(db, "course_periods"), { courseId, parallel, start, end });
                showToast("Hora a√±adida");
                loadScheduleMatrix();
            } catch(e) { showToast("Error", 'error'); }
        };

        window.deletePeriod = async (id) => {
            if(!confirm("¬øBorrar esta franja horaria?")) return;
            await deleteDoc(doc(db, "course_periods", id));
            loadScheduleMatrix();
        };

        // --- FUNCIONES PARA COPIAR HORARIO ---
        window.openCopyScheduleModal = () => {
            const courseId = document.getElementById('sched-course-select').value;
            const parallel = document.getElementById('sched-parallel-select').value;
            
            if (!courseId || !parallel) return showToast("Selecciona un horario origen primero", 'error');

            const container = document.getElementById('copy-targets-list');
            container.innerHTML = '';

            globalData.courses.forEach(course => {
                course.parallels.forEach(p => {
                    // Skip current selection
                    if (course.id === courseId && p === parallel) return;

                    const label = document.createElement('label');
                    label.className = "flex items-center gap-3 p-3 border border-slate-100 rounded-xl hover:bg-slate-50 cursor-pointer";
                    label.innerHTML = `
                        <input type="checkbox" class="w-5 h-5 accent-indigo-600 copy-target-checkbox" data-course="${course.id}" data-parallel="${p}">
                        <div>
                            <p class="font-bold text-slate-700 text-sm">${course.name}</p>
                            <p class="text-xs text-slate-400">Paralelo ${p}</p>
                        </div>
                    `;
                    container.appendChild(label);
                });
            });

            window.openModal('modal-copy-schedule');
        };

        window.confirmCopySchedule = async () => {
            const checkboxes = document.querySelectorAll('.copy-target-checkbox:checked');
            if (checkboxes.length === 0) return showToast("Selecciona al menos un curso destino", 'error');

            if (!confirm(`¬øCopiar horario a ${checkboxes.length} cursos seleccionados? Se a√±adir√°n las horas y materias.`)) return;

            const batch = writeBatch(db);
            let opCount = 0;

            // Get source data
            const periods = globalData.currentPeriods;
            const assigns = globalData.currentAssignments;

            checkboxes.forEach(cb => {
                const targetCourseId = cb.dataset.course;
                const targetParallel = cb.dataset.parallel;

                // Copy Periods
                periods.forEach(p => {
                    const newPeriodRef = doc(collection(db, "course_periods"));
                    batch.set(newPeriodRef, {
                        courseId: targetCourseId,
                        parallel: targetParallel,
                        start: p.start,
                        end: p.end
                    });
                    
                    // Copy assignments linked to this period (find matches by old period ID)
                    const relatedAssigns = assigns.filter(a => a.periodId === p.id);
                    relatedAssigns.forEach(a => {
                        const newAssignRef = doc(collection(db, "schedules"));
                        batch.set(newAssignRef, {
                            courseId: targetCourseId,
                            parallel: targetParallel,
                            periodId: newPeriodRef.id, // Link to NEW period ID
                            day: a.day,
                            subjectId: a.subjectId
                        });
                        opCount++;
                    });
                    opCount++;
                });
            });

            try {
                await batch.commit();
                showToast(`Horario copiado exitosamente (${opCount} operaciones)`);
                window.closeModal('modal-copy-schedule');
            } catch (e) {
                console.error(e);
                showToast("Error al copiar: " + e.message, 'error');
            }
        };

        // --- L√ìGICA DEL MODAL DE ASIGNACI√ìN (ADMIN) ---
        let currentAssignContext = null;

        window.openAssignModal = (periodId, day, start, end, currentSubjectId, assignId) => {
            currentAssignContext = { periodId, day, assignId };
            
            document.getElementById('assign-modal-subtitle').textContent = `${day} | ${start} - ${end}`;
            document.getElementById('assign-subject-select').value = currentSubjectId || "";
            
            // Llenar select de materias
            const select = document.getElementById('assign-subject-select');
            select.innerHTML = '<option value="">-- Seleccionar Materia --</option>';
            globalData.subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                if(s.id === currentSubjectId) opt.selected = true;
                select.appendChild(opt);
            });

            window.openModal('modal-assign-subject');
        };

        window.saveAssignment = async () => {
            const subjectId = document.getElementById('assign-subject-select').value;
            const courseId = document.getElementById('sched-course-select').value;
            const parallel = document.getElementById('sched-parallel-select').value;

            if (!subjectId) return showToast("Selecciona una materia", 'error');
            
            try {
                if (currentAssignContext.assignId) {
                    // Actualizar existente
                    await updateDoc(doc(db, "schedules", currentAssignContext.assignId), { subjectId });
                } else {
                    // Crear nuevo
                    await addDoc(collection(db, "schedules"), {
                        courseId, parallel,
                        periodId: currentAssignContext.periodId,
                        day: currentAssignContext.day,
                        subjectId
                    });
                }
                showToast("Materia Asignada");
                window.closeModal('modal-assign-subject');
                loadScheduleMatrix();
            } catch (e) { showToast("Error al guardar", 'error'); }
        };

        window.removeAssignment = async () => {
            if (!currentAssignContext.assignId) return;
            if(!confirm("¬øQuitar materia de este horario?")) return;
            
            try {
                await deleteDoc(doc(db, "schedules", currentAssignContext.assignId));
                showToast("Asignaci√≥n eliminada");
                window.closeModal('modal-assign-subject');
                loadScheduleMatrix();
            } catch(e) { showToast("Error", 'error'); }
        };


        // --- UI HELPERS & COMMON ---
        window.updateRepCourses = () => {
             const sectionId = document.getElementById('rep-section-select').value;
             const courseSel = document.getElementById('rep-course-select');
             const parSel = document.getElementById('rep-parallel-select');
             
             courseSel.innerHTML = '<option value="">Seleccione...</option>';
             parSel.innerHTML = '<option value="">Seleccione...</option>';
             parSel.disabled = true;
             courseSel.disabled = true;

             if (!sectionId) return;

             const courses = globalData.courses.filter(c => c.sectionId === sectionId);
             courseSel.innerHTML += courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
             courseSel.disabled = false;
        };

        window.updateRepParallels = () => {
             const courseId = document.getElementById('rep-course-select').value;
             const parSel = document.getElementById('rep-parallel-select');
             parSel.innerHTML = '<option value="">Seleccione...</option>';
             parSel.disabled = true;

             if (!courseId) return;

             const course = globalData.courses.find(c => c.id === courseId);
             if (course) {
                 parSel.innerHTML += course.parallels.map(p => `<option value="${p}">${p}</option>`).join('');
                 parSel.disabled = false;
             }
        };

        function updateDropdowns() {
            const areaSel = document.getElementById('subject-area-select');
            areaSel.innerHTML = '<option value="">Seleccione √Årea...</option>' + globalData.areas.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            
            const secOpts = globalData.sections.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('course-section-select').innerHTML = '<option value="">Seleccione Secci√≥n...</option>' + secOpts;
            document.getElementById('sched-section-select').innerHTML = '<option value="">Selecciona Secci√≥n...</option>' + secOpts;
            document.getElementById('rep-section-select').innerHTML = '<option value="">Seleccione...</option>' + secOpts;
            document.getElementById('rep-mass-section-select').innerHTML = '<option value="">Seleccione Secci√≥n...</option>' + secOpts;

            const teachers = globalData.users.filter(u => u.rol === 'Docente' || u.rol === 'Admin');
            document.getElementById('dist-teacher-select').innerHTML = '<option value="">Sel. Docente...</option>' + teachers.map(t => `<option value="${t.id}">${t.nombre || t.email}</option>`).join('');

            const subjOpts = globalData.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.getElementById('dist-subject-select').innerHTML = '<option value="">Sel. Materia...</option>' + subjOpts;
            
            document.getElementById('dist-course-select').innerHTML = '<option value="">Sel. Curso...</option>' + globalData.courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        // Window Functions
        window.deleteItem = async (colName, id) => { if(!confirm("¬øEliminar?")) return; try { await deleteDoc(doc(db, colName, id)); showToast("Eliminado"); loadAllAcademicData(); } catch(e) { showToast("Error", 'error'); } }
        window.switchTab = (btn, tabId) => { 
            // Handle active class for special tabs
            const isIndividual = btn.classList.contains('tab-btn-individual');
            const isMass = btn.classList.contains('tab-btn-mass');
            
            // Remove active from siblings
            const parent = btn.parentElement;
            Array.from(parent.children).forEach(child => child.classList.remove('active'));
            
            btn.classList.add('active');
            
            // Hide all content in this container
            const container = parent.parentElement;
            container.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
        };
        window.switchAuth = (mode) => { document.getElementById('login-form').classList.toggle('hidden', mode !== 'login'); document.getElementById('register-form').classList.toggle('hidden', mode !== 'register'); document.getElementById('tab-login').className = mode === 'login' ? 'flex-1 pb-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600' : 'flex-1 pb-3 text-sm font-bold text-slate-400 hover:text-slate-600'; document.getElementById('tab-register').className = mode === 'register' ? 'flex-1 pb-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600' : 'flex-1 pb-3 text-sm font-bold text-slate-400 hover:text-slate-600'; };
        window.showSection = (sectionId) => { document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden')); const target = document.getElementById('section-'+sectionId); if(target) target.classList.remove('hidden'); };
        window.openModal = (id) => document.getElementById(id).classList.replace('hidden', 'flex');
        window.closeModal = (id) => document.getElementById(id).classList.replace('flex', 'hidden');
        window.handleLogout = async () => { await signOut(auth); currentUser = null; window.showAuthView(); };
        window.showToast = (message, type = 'success') => { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`; toast.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> <span>${message}</span>`; container.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 300); }, 3000); };
        window.editUser = (uid) => { const user = globalData.users.find(u => u.id === uid); if (!user) return; document.getElementById('edit-uid').value = user.id; document.getElementById('edit-name').value = user.nombre || ""; document.getElementById('edit-email').value = user.email || ""; document.getElementById('edit-rol').value = user.rol || "Docente"; document.getElementById('edit-is-super').checked = !!user.isSuperAdmin; window.openModal('modal-user-edit'); };
        window.updateDistParallels = () => { const courseId = document.getElementById('dist-course-select').value; const parSel = document.getElementById('dist-parallel-select'); parSel.innerHTML = ''; const course = globalData.courses.find(c => c.id === courseId); if(course) parSel.innerHTML = course.parallels.map(p => `<option value="${p}">${p}</option>`).join(''); };
        window.resetEditForm = () => { document.getElementById('edit-uid').value = ""; document.getElementById('form-user-edit').reset(); }

        // Generic Event Listeners
        document.getElementById('form-user-edit').addEventListener('submit', async (e) => { e.preventDefault(); const uid = document.getElementById('edit-uid').value; const updates = { nombre: document.getElementById('edit-name').value, rol: document.getElementById('edit-rol').value, isSuperAdmin: document.getElementById('edit-is-super').checked }; const sigFile = document.getElementById('edit-signature').files[0]; if (sigFile) updates.firma = await toBase64(sigFile); try { if (uid) { await updateDoc(doc(db, "users", uid), updates); showToast("Actualizado"); } loadUsers(); window.closeModal('modal-user-edit'); } catch(error) { showToast("Error", 'error'); } });
        document.getElementById('form-section').addEventListener('submit', (e) => { e.preventDefault(); addItem('sections', { name: document.getElementById('section-name').value }, loadSections); e.target.reset(); });
        document.getElementById('form-area').addEventListener('submit', (e) => { e.preventDefault(); addItem('areas', { name: document.getElementById('area-name').value }, loadAreas); e.target.reset(); });
        document.getElementById('form-subject').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('subject-name').value; const areaId = document.getElementById('subject-area-select').value; if(!areaId) return showToast("Seleccione un √Årea", 'error'); addItem('subjects', { name, areaId }, loadSubjects); e.target.reset(); });
        document.getElementById('form-course').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('course-name').value; const sectionId = document.getElementById('course-section-select').value; const parallelsStr = document.getElementById('course-parallels').value; if(!sectionId) return showToast("Seleccione una Secci√≥n", 'error'); const parallels = parallelsStr.split(',').map(p => p.trim().toUpperCase()).filter(p => p !== ""); addItem('courses', { name, sectionId, parallels }, loadCourses); e.target.reset(); });
        document.getElementById('form-distributive').addEventListener('submit', (e) => { e.preventDefault(); const teacherId = document.getElementById('dist-teacher-select').value; const courseId = document.getElementById('dist-course-select').value; const parallel = document.getElementById('dist-parallel-select').value; const subjectId = document.getElementById('dist-subject-select').value; if(!teacherId || !courseId || !parallel || !subjectId) return showToast("Faltan datos", 'error'); addItem('distributive', { teacherId, courseId, parallel, subjectId }, loadDistributive); });
        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const pass = document.getElementById('login-pass').value; try { await signInWithEmailAndPassword(auth, email, pass); } catch (error) { showToast(error.code, 'error'); } });
        document.getElementById('register-form').addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('reg-email').value; const pass = document.getElementById('reg-pass').value; const name = document.getElementById('reg-name').value; const sigFile = document.getElementById('reg-signature').files[0]; try { const cred = await createUserWithEmailAndPassword(auth, email, pass); let signatureBase64 = null; if (sigFile) signatureBase64 = await toBase64(sigFile); await setDoc(doc(db, "users", cred.user.uid), { email: email, nombre: name, rol: "Docente", firma: signatureBase64, createdAt: new Date().toISOString() }); showToast("Cuenta creada", 'success'); } catch (error) { showToast(error.code, 'error'); } });

        async function addItem(collectionName, data, loadFn) { try { await addDoc(collection(db, collectionName), data); showToast("Guardado"); await loadFn(); } catch (e) { showToast("Error", 'error'); } }
        const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
    </script>
</body>
</html>