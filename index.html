<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leccionario Virtual - Gestión Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos UI */
        .role-badge { padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 9px; font-weight: 900; text-transform: uppercase; background: #f1f5f9; color: #64748b; display: inline-block; margin-right: 4px; margin-bottom: 2px; }
        .role-Admin { background: #fee2e2; color: #ef4444; }
        .role-Docente { background: #dcfce7; color: #16a34a; }
        .data-badge { display: inline-block; padding: 2px 6px; background: #eef2ff; color: #4f46e5; border-radius: 4px; font-size: 10px; font-weight: 700; margin-right: 2px; margin-bottom: 2px; border: 1px solid #e0e7ff; }
        .modal-animate { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .tab-btn { border-bottom: 3px solid transparent; color: #94a3b8; transition: all 0.2s; }
        .tab-btn.active { border-color: #2563eb; color: #1e293b; font-weight: 900; }
        .check-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; max-height: 120px; overflow-y: auto; padding: 0.5rem; background: #f8fafc; border-radius: 0.75rem; border: 1px solid #e2e8f0; }
        .check-item { display: flex; align-items: center; font-size: 11px; color: #475569; cursor: pointer; user-select: none; }
        .check-item input { margin-right: 6px; accent-color: #2563eb; }
        .schedule-cell { height: 60px; border: 1px solid #e2e8f0; background: #fff; cursor: pointer; transition: all 0.2s; font-size: 11px; text-align: center; vertical-align: middle; padding: 4px; position: relative; }
        .schedule-cell:hover { background: #f8fafc; }
        .schedule-cell.filled { background: #eff6ff; color: #1e40af; font-weight: 700; border-color: #dbeafe; }
        .time-col { background: #f1f5f9; color: #64748b; font-weight: 800; font-size: 10px; width: 80px; text-align: center; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-white z-[100] flex items-center justify-center transition-all duration-500">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-600 mb-4"></div>
            <p id="loader-text" class="text-slate-400 font-medium animate-pulse">Iniciando sistema...</p>
        </div>
    </div>

    <!-- VISTA DE LOGIN -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl border border-slate-200 w-full max-w-md text-center">
            <div class="w-32 h-32 bg-blue-50 mx-auto mb-8 rounded-3xl flex items-center justify-center text-blue-600 font-black text-4xl">EV</div>
            <h1 class="text-3xl font-black mb-2 text-slate-800">Leccionario Virtual</h1>
            <p class="text-slate-400 text-sm mb-4">Ingresa tus credenciales institucionales</p>
            
            <div id="firebase-status" class="mb-6 py-2 px-4 rounded-xl bg-slate-50 border border-slate-200 text-xs font-mono text-slate-400 flex items-center justify-center gap-2">
                <span class="w-2 h-2 rounded-full bg-slate-300"></span>
                Iniciando conexión...
            </div>

            <form id="auth-form" class="space-y-5 text-left">
                <input type="text" id="email" required placeholder="Correo o Usuario" class="w-full px-5 py-4 rounded-2xl border border-slate-200 outline-none focus:ring-4 focus:ring-blue-50 bg-slate-50">
                <input type="password" id="password" required placeholder="Contraseña" class="w-full px-5 py-4 rounded-2xl border border-slate-200 outline-none focus:ring-4 focus:ring-blue-50 bg-slate-50">
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-blue-700 transition-all">Ingresar</button>
            </form>
            <div id="login-error" class="bg-red-50 text-red-500 text-xs p-3 rounded-xl mt-4 font-bold hidden border border-red-100 text-left"></div>
            <p class="text-[10px] text-slate-300 mt-6 font-bold uppercase tracking-widest">Modo Prueba: admin / admin</p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="user-logged-in" class="hidden max-w-7xl mx-auto p-4 md:p-10">
        <div id="main-dashboard-view">
            <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-12 gap-6">
                <div>
                    <h1 class="text-4xl font-black text-slate-900 tracking-tighter mb-2">Mi Dashboard</h1>
                    <p class="text-slate-400 font-medium">Panel de Gestión Académica</p>
                </div>
                <div class="flex items-center gap-4 bg-white p-3 pr-6 rounded-[2rem] border border-slate-200 shadow-sm">
                    <div id="avatar-circle" class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center font-black">U</div>
                    <div>
                        <span id="user-email-display" class="text-slate-800 text-sm font-bold block"></span>
                        <span id="user-role-display" class="text-[10px] text-slate-400 uppercase font-black tracking-widest"></span>
                    </div>
                    <button id="logout-btn" class="ml-4 text-slate-400 hover:text-red-500 font-bold text-sm">Salir</button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <div class="lg:col-span-8">
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-10">
                            <div>
                                <h2 class="text-2xl font-black text-slate-800">Clases del Día</h2>
                                <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">
                                    <span id="day-of-week-label"></span> • <span id="day-current-display"></span>
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="changeDay(-1)" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center font-bold text-slate-600"><</button>
                                <button onclick="changeDay(1)" class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center font-bold text-slate-600">></button>
                            </div>
                        </div>
                        <div id="daily-classes-list" class="space-y-6">
                            <!-- Inyectado por JS -->
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-4 space-y-6">
                    <button id="btn-open-admin" class="w-full bg-slate-900 text-white p-8 rounded-[3rem] text-left hover:scale-[1.02] transition-all relative overflow-hidden group hidden">
                        <div class="relative z-10">
                            <div class="text-xs font-black text-white/40 uppercase mb-2">Administración</div>
                            <div class="text-xl font-bold">Configuración Global</div>
                            <p class="text-white/60 text-xs mt-2">Usuarios, Materias, Horarios...</p>
                        </div>
                    </button>
                    <div class="bg-blue-600 text-white p-8 rounded-[3rem] shadow-xl shadow-blue-200/50 relative overflow-hidden">
                        <div class="relative z-10">
                            <h3 class="font-black text-lg mb-2">Resumen</h3>
                            <div class="text-sm opacity-80 mb-4">Clases hoy:</div>
                            <div class="text-4xl font-black" id="classes-count">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-view" class="hidden space-y-8">
            <div class="flex flex-col sm:flex-row justify-between items-end gap-4">
                <button id="btn-back-dashboard" class="font-black text-xs text-slate-400 uppercase tracking-widest hover:text-blue-600 flex items-center gap-2">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg> Volver
                </button>
                <div class="flex space-x-6 border-b border-slate-200 w-full sm:w-auto overflow-x-auto">
                    <button onclick="switchTab('users')" id="tab-users" class="tab-btn active px-4 py-2 text-sm uppercase tracking-widest">Usuarios</button>
                    <button onclick="switchTab('catalogs')" id="tab-catalogs" class="tab-btn px-4 py-2 text-sm uppercase tracking-widest">Parámetros</button>
                    <button onclick="switchTab('schedules')" id="tab-schedules" class="tab-btn px-4 py-2 text-sm uppercase tracking-widest">Horarios</button>
                </div>
            </div>

            <!-- TAB USUARIOS -->
            <div id="content-users" class="space-y-6">
                <div class="flex justify-end">
                    <button id="btn-add-user" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-blue-700 shadow-lg shadow-blue-200 flex items-center gap-2"><span>+</span> Nuevo Usuario</button>
                </div>
                <div class="bg-white rounded-[3rem] shadow-xl border border-slate-100 overflow-hidden">
                    <div class="overflow-x-auto"><table class="w-full text-left min-w-[800px]"><thead><tr class="text-slate-400 text-[10px] uppercase font-black border-b border-slate-50"><th class="px-8 py-6">Usuario</th><th class="px-8 py-6">Materias y Áreas</th><th class="px-8 py-6">Cursos</th><th class="px-8 py-6">Rol</th><th class="px-8 py-6 text-right">Acciones</th></tr></thead><tbody id="users-table-body" class="divide-y divide-slate-50"></tbody></table></div>
                </div>
            </div>

            <!-- TAB CATÁLOGOS (ACTUALIZADA) -->
            <div id="content-catalogs" class="hidden space-y-6">
                <!-- Cabecera con Botón Guardar -->
                <div class="flex justify-between items-center bg-white p-4 rounded-[2rem] border border-slate-100 shadow-sm">
                    <div class="flex items-center gap-3 px-2">
                        <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                        </div>
                        <div>
                            <h3 class="font-black text-slate-800 text-lg">Catálogos del Sistema</h3>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Listas Desplegables</p>
                        </div>
                    </div>
                    <button onclick="manualSaveCatalogs()" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-black text-xs uppercase tracking-widest hover:bg-black transition-all shadow-lg shadow-slate-200 flex items-center gap-2">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>
                        Guardar Todo
                    </button>
                </div>
                
                <!-- Grid de Catálogos -->
                <div id="catalog-grid-inner" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- TAB HORARIOS -->
            <div id="content-schedules" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-wrap gap-4 items-end justify-between">
                    <div class="flex gap-4 flex-wrap">
                        <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase">Sección</label><select id="sch-seccion" class="p-3 bg-slate-50 rounded-xl text-sm border-none outline-none font-bold text-slate-700 min-w-[150px]"></select></div>
                        <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase">Curso</label><select id="sch-curso" class="p-3 bg-slate-50 rounded-xl text-sm border-none outline-none font-bold text-slate-700 min-w-[150px]"></select></div>
                        <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase">Paralelo</label><select id="sch-paralelo" class="p-3 bg-slate-50 rounded-xl text-sm border-none outline-none font-bold text-slate-700 min-w-[100px]"></select></div>
                        <button onclick="loadSchedule()" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-black text-xs uppercase hover:bg-black transition-all h-[44px] self-end">Cargar</button>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="openTimeConfig()" class="bg-blue-50 text-blue-600 px-6 py-3 rounded-xl font-black text-xs uppercase hover:bg-blue-100 transition-all border border-blue-100 h-[44px]">Configurar Horas</button>
                        <button onclick="saveCurrentSchedule()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-black text-xs uppercase hover:bg-green-700 transition-all h-[44px] shadow-lg shadow-green-100">Guardar</button>
                    </div>
                </div>
                <div id="schedule-container" class="bg-white rounded-[3rem] shadow-xl border border-slate-100 p-8 overflow-x-auto"><div class="text-center py-10 text-slate-400 font-bold italic">Selecciona los parámetros y carga el horario.</div></div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <!-- MODAL USUARIO -->
    <div id="modal-user" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[110] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-3xl rounded-[3rem] p-10 modal-animate max-h-[95vh] overflow-y-auto">
            <div class="flex justify-between mb-8"><h3 id="modal-title" class="text-3xl font-black text-slate-800 tracking-tighter text-blue-600">Usuario</h3><button onclick="closeModal('modal-user')" class="text-slate-400 hover:text-red-500 text-2xl">✕</button></div>
            <form id="user-form" class="space-y-6">
                <input type="hidden" id="form-user-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase">Correo</label><input type="email" id="form-email" required class="w-full p-4 rounded-2xl bg-slate-50 border-none outline-none focus:ring-2 focus:ring-blue-500/20"></div>
                    <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase">Contraseña</label><input type="text" id="form-pass" disabled placeholder="Gestionado por Auth" class="w-full p-4 rounded-2xl bg-slate-100 border-none outline-none text-slate-400 cursor-not-allowed"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-6 border-t border-slate-100 pt-6">
                    <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase flex justify-between">Áreas</label><div id="container-areas" class="check-grid"></div></div>
                    <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase flex justify-between">Materias</label><div id="container-materias" class="check-grid"></div></div>
                    <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase flex justify-between">Cursos</label><div id="container-cursos" class="check-grid"></div></div>
                    <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase flex justify-between">Paralelos</label><div id="container-paralelos" class="check-grid"></div></div>
                    <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase">Sección</label><select id="sel-seccion" class="w-full p-3 rounded-xl bg-slate-50 outline-none cursor-pointer"></select></div>
                    <div><label class="block text-xs font-black text-slate-400 mb-2 uppercase">Rol</label><select id="sel-rol" class="w-full p-3 rounded-xl bg-slate-50 outline-none cursor-pointer font-bold text-blue-600"></select></div>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black uppercase tracking-widest hover:bg-black transition-all shadow-xl">Guardar en Base de Datos</button>
            </form>
        </div>
    </div>

    <!-- MODAL CATÁLOGO -->
    <div id="modal-catalog" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[120] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 modal-animate">
            <h3 id="catalog-title" class="text-2xl font-black text-slate-800 mb-6">Administrar</h3>
            <div class="flex gap-2 mb-6"><input type="text" id="catalog-input" placeholder="Nueva opción..." class="flex-1 p-4 rounded-xl bg-slate-50 border outline-none"><button onclick="addCatalogItem()" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">+</button></div>
            <div id="catalog-list" class="max-h-60 overflow-y-auto space-y-2 pr-2"></div>
            <button onclick="closeModal('modal-catalog')" class="mt-6 w-full text-slate-400 font-bold uppercase text-xs hover:text-slate-600">Cerrar</button>
        </div>
    </div>

    <!-- MODAL TIME SLOTS -->
    <div id="modal-time-slots" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[130] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-8 modal-animate">
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-black text-slate-800">Franjas Horarias</h3><button onclick="closeModal('modal-time-slots')" class="text-slate-400 hover:text-red-500 font-bold">✕</button></div>
            <div class="flex gap-2 mb-4 bg-slate-50 p-4 rounded-2xl"><input type="time" id="ts-start" class="p-2 rounded-lg border border-slate-200 text-sm"><span class="self-center text-slate-400">-</span><input type="time" id="ts-end" class="p-2 rounded-lg border border-slate-200 text-sm"><button onclick="addTimeSlot()" class="flex-1 bg-slate-800 text-white rounded-lg font-bold text-xs uppercase">Agregar</button></div>
            <div id="slots-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
        </div>
    </div>

    <!-- MODAL ASSIGN SUBJECT -->
    <div id="modal-assign-subject" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[140] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 modal-animate">
            <h3 class="text-xl font-black text-slate-800 mb-4">Asignar Materia</h3>
            <div id="subject-selector-list" class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto"></div>
            <button onclick="closeModal('modal-assign-subject')" class="mt-6 w-full bg-slate-100 text-slate-500 py-3 rounded-xl font-bold text-xs uppercase">Cancelar</button>
        </div>
    </div>

    <!-- SEGURO DE VIDA PARA LOADER (Script estándar fuera del módulo) -->
    <script>
        function resolveLoader() {
            const loader = document.getElementById('loader');
            if (loader && loader.style.display !== 'none') {
                console.warn("Loader retirado por mecanismo de seguridad.");
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        }
        window.addEventListener('load', () => setTimeout(resolveLoader, 2000));
        setTimeout(resolveLoader, 5000);
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // IMPORTANTE: Analytics añadido
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN FIREBASE (TUS DATOS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB1eXkCiF5VZcTin0W5hBQv2X2PEE2bAJc",
            authDomain: "leccionario-virtual.firebaseapp.com",
            projectId: "leccionario-virtual",
            storageBucket: "leccionario-virtual.firebasestorage.app",
            messagingSenderId: "731785058376",
            appId: "1:731785058376:web:161550bdc3941e1a64207d",
            measurementId: "G-ZR0SXQDNY9"
        };

        let app, auth, db, analytics;
        
        try {
            app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app); // Inicializar Analytics
            auth = getAuth(app);
            db = getFirestore(app);
            
            const statusEl = document.getElementById('firebase-status');
            if(statusEl) {
                statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> Conexión Firebase OK`;
                statusEl.className = "mb-6 py-2 px-4 rounded-xl bg-green-50 border border-green-200 text-xs font-bold text-green-700 flex items-center justify-center gap-2";
            }
        } catch(e) {
            console.error("Error iniciando Firebase", e);
            const statusEl = document.getElementById('firebase-status');
            if(statusEl) {
                statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> Error de Conexión`;
                statusEl.className = "mb-6 py-2 px-4 rounded-xl bg-red-50 border border-red-200 text-xs font-bold text-red-700 flex items-center justify-center gap-2";
            }
        }

        // --- ESTADO GLOBAL ---
        let state = {
            catalogs: { areas: [], materias: [], cursos: [], paralelos: [], secciones: [], roles: [] },
            users: [],
            currentUser: null,
            currentSchedule: null,
            currentCatalog: null,
            viewDate: new Date()
        };

        const dom = {
            loader: document.getElementById('loader'),
            auth: document.getElementById('auth-container'),
            dashboard: document.getElementById('user-logged-in'),
            userTable: document.getElementById('users-table-body'),
            userEmail: document.getElementById('user-email-display'),
            userRole: document.getElementById('user-role-display'),
            avatar: document.getElementById('avatar-circle'),
            catalogGrid: document.getElementById('catalog-grid-inner'), // UPDATED ID
            catalogList: document.getElementById('catalog-list'),
            scheduleContainer: document.getElementById('schedule-container'),
            dailyList: document.getElementById('daily-classes-list')
        };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    loginSuccess({ uid: user.uid, email: user.email, ...userDoc.data() });
                } else {
                    const userByEmail = await getDoc(doc(db, "users", user.email));
                    if (userByEmail.exists()) {
                        const existingData = userByEmail.data();
                        await setDoc(doc(db, "users", user.uid), existingData);
                        try { await deleteDoc(doc(db, "users", user.email)); } catch(e) {}
                        loginSuccess({ uid: user.uid, email: user.email, ...existingData });
                    } else {
                        const basicProfile = { email: user.email, rol: "Docente", materias: [], areas: [] };
                        await setDoc(doc(db, "users", user.uid), basicProfile);
                        loginSuccess({ uid: user.uid, ...basicProfile });
                    }
                }
            } else {
                dom.dashboard.classList.add('hidden');
                dom.auth.classList.remove('hidden');
            }
            resolveLoader();
        });

        async function loginSuccess(userData) {
            state.currentUser = userData;
            dom.userEmail.textContent = userData.email;
            dom.userRole.textContent = userData.rol || "Usuario";
            dom.avatar.textContent = userData.email[0].toUpperCase();
            
            const adminBtn = document.getElementById('btn-open-admin');
            if (userData.rol === "Admin") adminBtn.classList.remove('hidden');
            else adminBtn.classList.add('hidden');

            dom.auth.classList.add('hidden');
            dom.dashboard.classList.remove('hidden');
            
            try {
                await loadCatalogs();
                if(userData.rol === "Admin") subscribeToUsers();
                await updateDashboardDate();
            } catch(e) { console.warn("Modo offline o error carga inicial", e); }
        }

        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('password').value;
            const errDiv = document.getElementById('login-error');
            errDiv.classList.add('hidden');

            // BYPASS LOCAL ADMIN
            if (email === "admin" && pass === "admin") {
                loginSuccess({ 
                    uid: "local_admin", 
                    email: "admin_local@test.com", 
                    rol: "Admin",
                    materias: ["General"], areas: ["Dirección"], cursos: [], paralelos: [], seccion: "Matutina"
                });
                state.catalogs = { 
                    areas: ["Ciencias Exactas", "Lenguaje", "Sociales"], 
                    materias: ["Matemáticas", "Física", "Lengua"], 
                    cursos: ["1ero Bach", "2do Bach"], 
                    paralelos: ["A", "B"], 
                    secciones: ["Matutina"], 
                    roles: ["Admin", "Docente"] 
                };
                renderCatalogs();
                populateScheduleSelectors();
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                console.error(error);
                let msg = "Error desconocido";
                if (error.code === 'auth/invalid-email') msg = "El correo no tiene un formato válido.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') msg = "Credenciales incorrectas.";
                if (error.code === 'auth/wrong-password') msg = "La contraseña es incorrecta.";
                if (error.code === 'auth/network-request-failed') msg = "Error de conexión a internet.";
                errDiv.textContent = msg;
                errDiv.classList.remove('hidden');
            }
        };

        document.getElementById('logout-btn').onclick = () => {
            if (state.currentUser.uid === "local_admin") location.reload();
            else signOut(auth);
        };

        // --- CATALOGS ---
        async function loadCatalogs() {
            const docSnap = await getDoc(doc(db, "config", "catalogs"));
            if (docSnap.exists()) {
                state.catalogs = docSnap.data();
            } else {
                await setDoc(doc(db, "config", "catalogs"), state.catalogs);
            }
            renderCatalogs();
            populateScheduleSelectors();
        }

        window.manualSaveCatalogs = async () => {
            if (state.currentUser.uid === "local_admin") { alert("Guardado simulado (Local)"); return; }
            try {
                await setDoc(doc(db, "config", "catalogs"), state.catalogs);
                alert("✅ Parámetros guardados correctamente en Firebase.");
            } catch(e) {
                console.error(e);
                alert("❌ Error al guardar: " + e.message);
            }
        };

        // --- USERS ---
        function subscribeToUsers() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                state.users = [];
                snapshot.forEach(doc => state.users.push({ id: doc.id, ...doc.data() }));
                renderUserTable();
            });
        }

        window.deleteUser = async (id) => {
            if(confirm("¿Eliminar usuario de DB?")) {
                try {
                    await deleteDoc(doc(db, "users", id));
                    alert("Usuario eliminado.");
                } catch (e) { console.error(e); alert("Error al eliminar."); }
            }
        };

        document.getElementById('user-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('form-user-id').value;
            const email = document.getElementById('form-email').value;
            const userData = {
                email: email,
                areas: getCheckedValues('chk-area'),
                materias: getCheckedValues('chk-materia'),
                cursos: getCheckedValues('chk-curso'),
                paralelos: getCheckedValues('chk-paralelo'),
                seccion: document.getElementById('sel-seccion').value,
                rol: document.getElementById('sel-rol').value
            };

            if (state.currentUser.uid === "local_admin") {
                alert("Modo prueba: No guarda usuarios reales.");
                return;
            }

            try {
                if (id) {
                    await updateDoc(doc(db, "users", id), userData);
                } else {
                    await setDoc(doc(db, "users", email), userData); 
                    alert("Usuario guardado en DB.");
                }
                closeModal('modal-user');
            } catch (e) { console.error(e); alert("Error: " + e.message); }
        };

        // --- SCHEDULES & DASHBOARD ---
        window.loadSchedule = async () => {
            const sec = document.getElementById('sch-seccion').value;
            const cur = document.getElementById('sch-curso').value;
            const par = document.getElementById('sch-paralelo').value;
            const scheduleId = `${sec}_${cur}_${par}`;
            
            if (state.currentUser.uid === "local_admin") {
                state.currentSchedule = { id: scheduleId, slots: [], grid: {} };
                renderScheduleTable(state.currentSchedule);
                return;
            }

            const docSnap = await getDoc(doc(db, "schedules", scheduleId));
            if (docSnap.exists()) state.currentSchedule = { id: scheduleId, ...docSnap.data() };
            else state.currentSchedule = { id: scheduleId, slots: [], grid: {} };
            renderScheduleTable(state.currentSchedule);
        };

        window.saveCurrentSchedule = async () => {
            if (!state.currentSchedule) return;
            if (state.currentUser.uid === "local_admin") { alert("Guardado simulado."); return; }
            try {
                await setDoc(doc(db, "schedules", state.currentSchedule.id), {
                    slots: state.currentSchedule.slots,
                    grid: state.currentSchedule.grid
                });
                alert("Horario guardado.");
            } catch(e) { alert("Error: " + e.message); }
        };

        window.updateDashboardDate = async () => {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('day-current-display').textContent = state.viewDate.toLocaleDateString('es-ES', options);
            const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
            document.getElementById('day-of-week-label').textContent = days[state.viewDate.getDay()];
            
            if(state.currentUser.uid === "local_admin") {
                document.getElementById('daily-classes-list').innerHTML = `<div class="p-8 text-center text-slate-400">Modo prueba: Sin clases.</div>`;
            } else {
                document.getElementById('daily-classes-list').innerHTML = `<div class="p-8 text-center text-slate-400">Selecciona fecha.</div>`;
            }
        };

        window.changeDay = (d) => { state.viewDate.setDate(state.viewDate.getDate() + d); updateDashboardDate(); };

        // --- HELPERS UI ---
        window.switchTab = (tab) => { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${tab}`).classList.add('active'); ['users', 'catalogs', 'schedules'].forEach(t => document.getElementById(`content-${t}`).classList.add('hidden')); document.getElementById(`content-${tab}`).classList.remove('hidden'); };
        window.openModal = (id) => document.getElementById(id).classList.replace('hidden', 'flex');
        window.closeModal = (id) => document.getElementById(id).classList.replace('flex', 'hidden');
        
        function renderUserTable() {
            dom.userTable.innerHTML = state.users.map(u => `
                <tr class="hover:bg-slate-50/50 transition-colors group border-b border-slate-50 last:border-0">
                    <td class="px-8 py-4 align-top"><div class="font-bold text-slate-800">${u.email}</div></td>
                    <td class="px-8 py-4 align-top">${(u.materias||[]).map(m => `<span class="data-badge">${m}</span>`).join('')}</td>
                    <td class="px-8 py-4 align-top">${(u.cursos||[]).map(c => `<span class="text-xs font-bold text-slate-700 block">${c}</span>`).join('')}</td>
                    <td class="px-8 py-4 align-top"><span class="role-badge role-${u.rol}">${u.rol}</span></td>
                    <td class="px-8 py-4 align-top text-right">
                        <button onclick="editUser('${u.id}')" class="text-blue-600 font-black text-[10px] uppercase hover:underline">Editar</button>
                        <button onclick="deleteUser('${u.id}')" class="text-red-400 font-black text-[10px] uppercase ml-4 hover:text-red-600">Eliminar</button>
                    </td>
                </tr>`).join('');
        }
        
        window.editUser = (id) => {
            renderFormOptions();
            const u = state.users.find(x => x.id === id);
            document.getElementById('form-user-id').value = u.id;
            document.getElementById('form-email').value = u.email;
            document.getElementById('sel-seccion').value = u.seccion;
            document.getElementById('sel-rol').value = u.rol;
            setCheckedValues('chk-area', u.areas || []);
            setCheckedValues('chk-materia', u.materias || []);
            setCheckedValues('chk-curso', u.cursos || []);
            setCheckedValues('chk-paralelo', u.paralelos || []);
            openModal('modal-user');
        };

        function renderFormOptions() {
            createCheckboxes('container-areas', state.catalogs.areas, 'chk-area');
            createCheckboxes('container-materias', state.catalogs.materias, 'chk-materia');
            createCheckboxes('container-cursos', state.catalogs.cursos, 'chk-curso');
            createCheckboxes('container-paralelos', state.catalogs.paralelos, 'chk-paralelo');
            populateSelect('sel-seccion', state.catalogs.secciones);
            populateSelect('sel-rol', state.catalogs.roles);
        }
        
        function createCheckboxes(cid, opts, name) { document.getElementById(cid).innerHTML = (opts||[]).map(o => `<label class="check-item"><input type="checkbox" name="${name}" value="${o}"><span>${o}</span></label>`).join(''); }
        function populateSelect(id, opts) { document.getElementById(id).innerHTML = (opts||[]).map(o => `<option value="${o}">${o}</option>`).join(''); }
        function populateScheduleSelectors() { populateSelect('sch-seccion', state.catalogs.secciones); populateSelect('sch-curso', state.catalogs.cursos); populateSelect('sch-paralelo', state.catalogs.paralelos); }
        window.setCheckedValues = (name, vals) => document.querySelectorAll(`input[name="${name}"]`).forEach(cb => cb.checked = vals.includes(cb.value));
        window.getCheckedValues = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

        function renderCatalogs() {
            dom.catalogGrid.innerHTML = Object.keys(state.catalogs).map(key => `
                <div onclick="openCatalogManager('${key}')" class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm hover:shadow-md transition cursor-pointer group">
                    <div class="flex justify-between items-center mb-4"><h4 class="font-black text-slate-800 uppercase tracking-widest text-xs">${key}</h4><span class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded-lg">${(state.catalogs[key]||[]).length}</span></div>
                    <div class="flex flex-wrap gap-1 max-h-20 overflow-hidden">${(state.catalogs[key]||[]).slice(0, 4).map(item => `<span class="text-[9px] bg-slate-50 text-slate-400 px-2 py-1 rounded-md border border-slate-100">${item}</span>`).join('')}</div>
                </div>`).join('');
        }
        window.openCatalogManager = (key) => { state.currentCatalog = key; document.getElementById('catalog-title').textContent = key.toUpperCase(); renderCatalogList(); openModal('modal-catalog'); };
        function renderCatalogList() { document.getElementById('catalog-list').innerHTML = state.catalogs[state.currentCatalog].map((item, index) => `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100"><span class="text-sm font-bold text-slate-600">${item}</span><button onclick="removeCatalogItem(${index})" class="text-red-400 font-black text-xs">✕</button></div>`).join(''); }
        
        window.addCatalogItem = async () => { const val = document.getElementById('catalog-input').value.trim(); if(val){ state.catalogs[state.currentCatalog].push(val); document.getElementById('catalog-input').value=''; renderCatalogList(); renderCatalogs(); populateScheduleSelectors(); } };
        window.removeCatalogItem = async (idx) => { state.catalogs[state.currentCatalog].splice(idx, 1); renderCatalogList(); renderCatalogs(); populateScheduleSelectors(); };

        function renderScheduleTable(schedule) {
            if (!schedule.slots || schedule.slots.length === 0) {
                dom.scheduleContainer.innerHTML = `<div class="text-center py-10"><p class="text-slate-400 font-bold mb-4">Sin horas configuradas.</p><button onclick="openTimeConfig()" class="text-blue-600 underline text-sm font-bold">Configurar</button></div>`; return;
            }
            const days = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
            let html = `<table class="w-full border-collapse"><thead><tr><th class="p-3 text-[10px] uppercase font-black text-slate-400 bg-slate-50 border border-slate-200">Hora</th>${days.map(d => `<th class="p-3 text-[10px] uppercase font-black text-slate-400 bg-slate-50 border border-slate-200">${d}</th>`).join('')}</tr></thead><tbody>`;
            schedule.slots.sort((a,b) => a.start.localeCompare(b.start)).forEach(slot => {
                html += `<tr><td class="time-col border border-slate-200 p-2">${slot.start} - ${slot.end}</td>`;
                days.forEach((day, index) => {
                    const cellId = `${slot.id}_${index}`;
                    const subject = schedule.grid[cellId] || "";
                    const filledClass = subject ? 'filled' : '';
                    html += `<td onclick="openAssignSubject('${cellId}')" class="schedule-cell ${filledClass}">${subject}</td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            dom.scheduleContainer.innerHTML = html;
        }
        window.openTimeConfig = () => { if (!state.currentSchedule) { alert("Carga un horario primero"); return; } renderTimeSlotsList(); openModal('modal-time-slots'); };
        function renderTimeSlotsList() {
            document.getElementById('slots-list').innerHTML = state.currentSchedule.slots.map((slot, idx) => `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100"><span class="text-sm font-bold text-slate-700">${slot.start} - ${slot.end}</span><button onclick="removeTimeSlot(${idx})" class="text-red-400 font-black text-xs">✕</button></div>`).join('');
        }
        window.addTimeSlot = () => { const s = document.getElementById('ts-start').value; const e = document.getElementById('ts-end').value; if(s && e) { state.currentSchedule.slots.push({id: Date.now(), start:s, end:e}); renderTimeSlotsList(); renderScheduleTable(state.currentSchedule); } };
        window.removeTimeSlot = (i) => { state.currentSchedule.slots.splice(i, 1); renderTimeSlotsList(); renderScheduleTable(state.currentSchedule); };
        window.openAssignSubject = (cid) => { state.tempCellTarget = cid; const c = document.getElementById('subject-selector-list'); c.innerHTML = state.catalogs.materias.map(m => `<button onclick="assignSubject('${m}')" class="p-3 bg-slate-50 hover:bg-blue-50 text-slate-600 font-bold border border-slate-100 text-xs">${m}</button>`).join('') + `<button onclick="assignSubject('')" class="p-3 bg-red-50 text-red-500 font-bold border border-red-100 text-xs col-span-2">Borrar</button>`; openModal('modal-assign-subject'); };
        window.assignSubject = (sub) => { if(sub) state.currentSchedule.grid[state.tempCellTarget] = sub; else delete state.currentSchedule.grid[state.tempCellTarget]; renderScheduleTable(state.currentSchedule); closeModal('modal-assign-subject'); };
        
        document.getElementById('btn-add-user').onclick = () => { 
            renderFormOptions(); 
            document.getElementById('user-form').reset(); 
            document.getElementById('form-user-id').value = ""; 
            openModal('modal-user'); 
        };

        // NAVEGACIÓN ENTRE VISTAS (DASHBOARD <-> ADMIN)
        document.getElementById('btn-open-admin').onclick = () => {
            document.getElementById('main-dashboard-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            switchTab('users'); // Ir a usuarios por defecto
            renderUserTable();
        };

        document.getElementById('btn-back-dashboard').onclick = () => {
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('main-dashboard-view').classList.remove('hidden');
        };
    </script>
</body>
</html>