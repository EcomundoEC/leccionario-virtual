<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leccionario Virtual V3.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, updateDoc, setDoc, onSnapshot, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURACIÓN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyB1eXkCiF5VZcTin0W5hBQv2X2PEE2bAJc",
            authDomain: "leccionario-virtual.firebaseapp.com",
            projectId: "leccionario-virtual",
            storageBucket: "leccionario-virtual.firebasestorage.app",
            messagingSenderId: "731785058376",
            appId: "1:731785058376:web:161550bdc3941e1a64207d",
            measurementId: "G-ZR0SXQDNY9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ESTADO GLOBAL
        let currentUser = null;
        let userData = null;
        
        // Cache de datos para renderizado instantáneo
        window.dbData = {
            courses: [],
            schedules: [],
            logs: [],
            users: {},
            sections: [],
            areas: [],
            subjects: []
        };
        
        let calCurrentDate = new Date();

        // ------------------------------------------------------------------
        // 1. SISTEMA DE DATOS EN TIEMPO REAL (CORE)
        // ------------------------------------------------------------------
        
        // Inicia la escucha de datos apenas se loguea el usuario
        function initDataListeners(user) {
            // 1. Cursos
            onSnapshot(collection(db, 'courses'), snap => {
                window.dbData.courses = [];
                snap.forEach(d => window.dbData.courses.push({id: d.id, ...d.data()}));
                refreshDashboardUI(); // Actualizar Dashboard si cambian cursos
            });

            // 2. Horarios (Solo del usuario actual)
            const schedQ = query(collection(db, 'schedules'), where("uid", "==", user.uid));
            onSnapshot(schedQ, snap => {
                window.dbData.schedules = [];
                snap.forEach(d => window.dbData.schedules.push({id: d.id, ...d.data()}));
                refreshDashboardUI(); // Actualizar Dashboard si cambian horarios
            });

            // 3. Logs/Registros (Solo del usuario actual)
            const logsQ = query(collection(db, 'daily_logs'), where("uid", "==", user.uid));
            onSnapshot(logsQ, snap => {
                window.dbData.logs = [];
                snap.forEach(d => window.dbData.logs.push({id: d.id, ...d.data()}));
                refreshDashboardUI(); // Actualizar Dashboard si cambian registros
            });

            // 4. Catálogos Generales (Secciones, Áreas, Materias)
            onSnapshot(collection(db, 'sections'), snap => {
                window.dbData.sections = [];
                snap.forEach(d => window.dbData.sections.push({id: d.id, ...d.data()}));
                updateAdminTables();
            });
            onSnapshot(collection(db, 'areas'), snap => {
                window.dbData.areas = [];
                snap.forEach(d => window.dbData.areas.push({id: d.id, ...d.data()}));
                updateAdminTables();
            });
            onSnapshot(collection(db, 'subjects'), snap => {
                window.dbData.subjects = [];
                snap.forEach(d => window.dbData.subjects.push({id: d.id, ...d.data()}));
                updateAdminTables();
            });
            
            // 5. Usuarios
            onSnapshot(collection(db, 'users'), snap => {
                window.dbData.users = {};
                snap.forEach(d => window.dbData.users[d.id] = d.data());
                renderUsersTable();
            });
        }

        function refreshDashboardUI() {
            // Si el dashboard es visible, redibujarlo con los nuevos datos
            if(!document.getElementById('section-dashboard').classList.contains('hidden')) {
                renderDashboard();
            }
        }

        // ------------------------------------------------------------------
        // 2. RENDERIZADO DE INTERFAZ (UI)
        // ------------------------------------------------------------------

        function renderDashboard() {
            // A. Panel Mis Cursos
            const list = document.getElementById('my-load-list');
            const myC = window.dbData.courses.filter(c => c.uid === currentUser.uid);
            
            if (myC.length === 0) {
                list.innerHTML = '<p class="text-sm text-slate-400 italic text-center py-4">No tienes cursos registrados aún.</p>';
            } else {
                list.innerHTML = myC.map(c => `
                    <div class="p-3 bg-white border border-slate-200 rounded-xl hover:shadow-md transition cursor-pointer flex items-center gap-3 mb-2" onclick="window.showSection('schedules')">
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-lg shrink-0">
                            ${c.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="overflow-hidden">
                            <div class="font-bold text-slate-800 text-sm truncate">${c.name}</div>
                            <div class="text-xs text-slate-500 truncate">Paralelos: ${c.parallels.join(', ')}</div>
                        </div>
                    </div>`).join('');
            }

            // B. Leccionario de Hoy
            renderTodayLeccionario();

            // C. Calendario
            renderCalendarWidget();
        }

        function renderTodayLeccionario() {
            const container = document.getElementById('today-leccionario-body');
            const emptyMsg = document.getElementById('leccionario-empty-msg');
            const wrapper = document.getElementById('leccionario-wrapper');
            
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const dayIdx = (today.getDay() + 6) % 7; // Ajuste para 0=Lunes

            // Buscar clases para hoy en los horarios cargados
            const tasks = [];
            window.dbData.schedules.forEach(sched => {
                const from = new Date(sched.validFrom); from.setHours(0,0,0,0);
                const to = new Date(sched.validTo); to.setHours(23,59,59,999);
                
                if(today >= from && today <= to) {
                    Object.keys(sched.matrix).forEach(key => {
                        const [row, col] = key.split('-');
                        if(parseInt(col) === dayIdx) {
                            const subj = sched.matrix[key];
                            if(subj) {
                                const timeSlot = sched.timeSlots && sched.timeSlots[row] ? sched.timeSlots[row] : {s:'??',e:'??'};
                                tasks.push({
                                    key: `${sched.id}_${row}`,
                                    schedId: sched.id,
                                    row: parseInt(row),
                                    time: `${timeSlot.s} - ${timeSlot.e}`,
                                    subject: subj,
                                    course: `${sched.courseName} ${sched.parallel}`
                                });
                            }
                        }
                    });
                }
            });

            if(tasks.length === 0) {
                wrapper.classList.add('hidden');
                emptyMsg.classList.remove('hidden');
                return;
            }

            wrapper.classList.remove('hidden');
            emptyMsg.classList.add('hidden');
            tasks.sort((a,b) => a.row - b.row);

            // Cruzar con lo ya guardado hoy
            const savedLogs = {};
            window.dbData.logs.filter(l => l.dateStr === dateStr).forEach(l => {
                savedLogs[`${l.schedId}_${l.row}`] = l;
            });

            const firmaImg = userData?.firma ? `<img src="${userData.firma}" class="h-8 mx-auto" alt="Firma">` : '<span class="text-xs text-gray-300">--</span>';

            container.innerHTML = tasks.map(t => {
                const saved = savedLogs[t.key] || {};
                const isReceso = t.subject.toUpperCase() === 'RECESO';
                
                if(isReceso) return `
                    <tr class="bg-gray-100 border-b border-gray-200">
                        <td class="p-3 text-xs font-bold text-slate-500">${t.time}</td>
                        <td colspan="5" class="p-3 text-center text-xs font-bold text-slate-400 tracking-widest">RECESO</td>
                    </tr>`;

                return `
                    <tr class="hover:bg-blue-50/30 transition border-b border-gray-100">
                        <td class="p-3 text-xs font-bold text-slate-600 whitespace-nowrap align-middle">${t.time}</td>
                        <td class="p-3 align-middle">
                            <div class="text-xs font-bold text-slate-800">${t.subject}</div>
                            <div class="text-[10px] text-blue-600 font-medium">${t.course}</div>
                        </td>
                        <td class="p-2 align-middle"><textarea id="topic_${t.key}" class="w-full text-xs p-2 border border-slate-200 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 focus:bg-white" rows="2" placeholder="Tema tratado...">${saved.topic||''}</textarea></td>
                        <td class="p-3 text-xs text-center text-slate-600 align-middle">${userData?.nombre||'Yo'}</td>
                        <td class="p-3 text-center align-middle">${firmaImg}</td>
                        <td class="p-2 align-middle"><textarea id="obs_${t.key}" class="w-full text-xs p-2 border border-slate-200 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 focus:bg-white" rows="2" placeholder="Observaciones...">${saved.observation||''}</textarea></td>
                    </tr>`;
            }).join('');
            
            window.currentTasks = tasks;
        }

        function renderCalendarWidget() {
            const year = calCurrentDate.getFullYear();
            const month = calCurrentDate.getMonth();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            const label = document.getElementById('cal-month-label');
            if(label) label.textContent = `${monthNames[month]} ${year}`;
            
            const grid = document.getElementById('cal-grid');
            if(!grid) return;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = (firstDay.getDay() + 6) % 7; 

            let html = '';
            for(let i=0; i<startDayOfWeek; i++) html += `<div class="h-16 bg-slate-50 rounded-lg opacity-50 border border-transparent"></div>`;

            const todayStr = new Date().toISOString().split('T')[0];

            for(let day=1; day<=daysInMonth; day++) {
                const dateObj = new Date(year, month, day);
                const dateStr = dateObj.toISOString().split('T')[0];
                const dayOfWeekIdx = (dateObj.getDay() + 6) % 7;

                // Calcular Esperado vs Real
                let expected = 0;
                window.dbData.schedules.forEach(s => {
                    const from = new Date(s.validFrom); from.setHours(0,0,0,0);
                    const to = new Date(s.validTo); to.setHours(23,59,59,999);
                    if (dateObj >= from && dateObj <= to) {
                        Object.keys(s.matrix).forEach(k => {
                            const [r, c] = k.split('-');
                            if(parseInt(c) === dayOfWeekIdx) {
                                const subj = s.matrix[k];
                                if(subj && subj.toUpperCase() !== 'RECESO') expected++;
                            }
                        });
                    }
                });

                const filled = window.dbData.logs.filter(l => l.dateStr === dateStr).length;
                
                let colorClass = "bg-white border-slate-200 text-slate-400";
                let statusIcon = "";
                
                if (expected > 0) {
                    if (filled >= expected) {
                        colorClass = "bg-emerald-50 border-emerald-200 text-emerald-700";
                        statusIcon = `<i class="fa-solid fa-check-circle text-emerald-500 absolute bottom-1 right-1 text-xs"></i>`;
                    } else if (filled > 0) {
                        colorClass = "bg-amber-50 border-amber-200 text-amber-700";
                        statusIcon = `<i class="fa-solid fa-circle-half-stroke text-amber-500 absolute bottom-1 right-1 text-xs"></i>`;
                    } else {
                        if (dateObj < new Date().setHours(0,0,0,0)) {
                            colorClass = "bg-rose-50 border-rose-200 text-rose-700";
                            statusIcon = `<i class="fa-solid fa-circle-exclamation text-rose-500 absolute bottom-1 right-1 text-xs"></i>`;
                        } else {
                            colorClass = "bg-white border-slate-300 text-slate-600";
                        }
                    }
                }

                const isToday = dateStr === todayStr;
                const todayRing = isToday ? "ring-2 ring-blue-500 ring-offset-2 z-10" : "";

                html += `
                    <div class="h-16 border rounded-lg p-1 relative flex flex-col justify-between ${colorClass} ${todayRing}">
                        <span class="font-bold text-xs">${day}</span>
                        ${expected > 0 ? `<div class="text-[9px] leading-tight text-right mt-1">${filled}/${expected}<br>Clases</div>` : ''}
                        ${statusIcon}
                    </div>
                `;
            }
            grid.innerHTML = html;
        }

        // ------------------------------------------------------------------
        // 3. AUTHENTICATION & STARTUP
        // ------------------------------------------------------------------

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // 1. Obtener Datos de Usuario
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    userData = userDoc.exists() ? userDoc.data() : { nombre: user.email, rol: 'Docente' };
                } catch (e) {
                    console.error("Error perfil", e);
                    userData = { nombre: "Usuario", rol: "Docente" };
                }
                
                // 2. Actualizar UI Perfil
                document.getElementById('user-name-display').textContent = userData.nombre;
                document.getElementById('user-role-label').textContent = userData.rol;
                
                // 3. Gestión de Roles (Mostrar/Ocultar Menús)
                const isAdmin = userData.rol === 'Admin';
                ['nav-admin-group', 'nav-schedules-group', 'nav-reports-group'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        if(isAdmin) el.classList.remove('hidden');
                        else el.classList.add('hidden');
                    }
                });

                // 4. CAMBIO DE VISTA INMEDIATO
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                
                // 5. INICIAR CARGA DE DATOS REALTIME
                initDataListeners(user);
                
                // 6. FORZAR DASHBOARD
                window.showSection('dashboard');

            } else {
                document.getElementById('app-view').classList.add('hidden');
                document.getElementById('auth-view').classList.remove('hidden');
                userData = null;
            }
        });

        // ------------------------------------------------------------------
        // 4. HELPERS GLOBALES (WINDOW)
        // ------------------------------------------------------------------

        window.showSection = (id) => {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            const target = document.getElementById(`section-${id}`);
            if(target) {
                target.classList.remove('hidden');
                if(id === 'dashboard') refreshDashboardUI();
                if(id === 'users') {
                   const tb = document.getElementById('users-table-body');
                   if(!tb.hasChildNodes() || tb.innerHTML.trim() === "") window.forceLoadUsers();
                }
                // Actualizar selects si entramos a configuración
                if(id === 'academic-admin' || id === 'schedules' || id === 'courses') updateAdminTables();
            }
        };

        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const color = type === 'success' ? 'bg-emerald-600' : 'bg-rose-600';
            el.className = `${color} text-white px-6 py-3 rounded-xl shadow-lg font-bold text-sm mb-2 animate-bounce flex items-center gap-2`;
            el.innerHTML = `<i class="fa-solid fa-${type==='success'?'check':'triangle-exclamation'}"></i> ${msg}`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        };

        // Acciones Login/Logout
        window.switchAuth = (type) => {
            document.getElementById('login-form').classList.toggle('hidden', type !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', type !== 'register');
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) { window.showToast("Error al salir", 'error'); }
        };

        // Acciones Guardado Diario
        window.saveDaily = async () => {
            if(!window.currentTasks) return;
            const dateStr = new Date().toISOString().split('T')[0];
            let c = 0;
            const btn = document.getElementById('btn-save-daily');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';
            btn.disabled = true;
            
            try {
                const batchPromises = window.currentTasks.map(async t => {
                    if(t.subject.toUpperCase() === 'RECESO') return;
                    const topic = document.getElementById(`topic_${t.key}`).value;
                    let obs = document.getElementById(`obs_${t.key}`).value;
                    
                    // Regla de negocio: Si escribe tema pero no obs, poner N/A. Si no escribe nada, ignorar.
                    if(!topic && !obs) return;
                    if(!obs) obs = "N/A";
                    
                    await setDoc(doc(db, 'daily_logs', `${dateStr}_${t.key}`), { 
                        dateStr, schedId: t.schedId, row: t.row, uid: currentUser.uid, 
                        topic, observation: obs, subject: t.subject, course: t.course, 
                        time: t.time, timestamp: new Date() 
                    });
                    c++;
                });
                await Promise.all(batchPromises);
                window.showToast(`${c} registros guardados`);
                refreshDashboardUI(); // Refrescar para ver cambios en calendario
            } catch(e) {
                window.showToast("Error al guardar", 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // Helpers de Tablas Admin
        function updateAdminTables() {
            // Llenar selects
            const fillSelect = (id, data, valKey='id', labelKey='name') => {
                const s = document.getElementById(id);
                if(s) {
                    s.innerHTML = '<option value="">Seleccione...</option>';
                    data.forEach(d => s.innerHTML += `<option value="${d[valKey]}">${d[labelKey]}</option>`);
                }
            };
            fillSelect('course-section-select', window.dbData.sections);
            fillSelect('sched-section-select', window.dbData.sections);
            fillSelect('subject-area-select', window.dbData.areas, 'name', 'name');

            // Render Tablas
            const renderTable = (id, data, colName) => {
                const tb = document.getElementById(id);
                if(tb) {
                    tb.innerHTML = data.map(d => `<tr><td>${d.name}</td><td class="text-right"><i class="fa-solid fa-trash text-red-400 cursor-pointer" onclick="deleteItem('${colName}','${d.id}')"></i></td></tr>`).join('');
                }
            };
            renderTable('sections-table-body', window.dbData.sections, 'sections');
            renderTable('areas-table-body', window.dbData.areas, 'areas');
            
            const tbSub = document.getElementById('subjects-table-body');
            if(tbSub) tbSub.innerHTML = window.dbData.subjects.map(d => `<tr><td>${d.name}</td><td>${d.area}</td><td class="text-right flex justify-end gap-2"><i class="fa-solid fa-pen text-blue-500 cursor-pointer" onclick="editSubjectFull('${d.id}','${d.name}','${d.area}')"></i><i class="fa-solid fa-trash text-red-400 cursor-pointer" onclick="deleteItem('subjects','${d.id}')"></i></td></tr>`).join('');
            
            const tbCourses = document.getElementById('courses-table-body');
            if(tbCourses) tbCourses.innerHTML = window.dbData.courses.map(d => `<tr><td>${d.name}</td><td>${d.sectionId}</td><td>${d.parallels.join(', ')}</td><td class="text-right"><i class="fa-solid fa-trash text-red-400 cursor-pointer" onclick="deleteItem('courses','${d.id}')"></i></td></tr>`).join('');
        }

        function renderUsersTable() {
            const tb = document.getElementById('users-table-body');
            if(tb) tb.innerHTML = Object.values(window.dbData.users).map(u => `<tr><td class="p-3 font-bold text-slate-700">${u.nombre}</td><td class="p-3 text-xs">${u.email}</td><td class="p-3"><span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">${u.rol}</span></td><td class="p-3 text-center">${u.firma ? '<i class="fa-solid fa-check text-green-500"></i>' : '--'}</td></tr>`).join('');
        }

        // Utilitarios CRUD y Varios
        window.deleteItem = async (col, id) => { if(confirm('¿Eliminar?')) { try{ await deleteDoc(doc(db, col, id)); window.showToast('Eliminado'); }catch(e){ window.showToast('Error', 'error'); } } };
        window.editSubjectFull = async (id, name, area) => { const opt = prompt(`Editar ${name}\n1.Nombre 2.Área`); if(opt=='1'){const n=prompt("Nombre:",name);if(n)await updateDoc(doc(db,'subjects',id),{name:n});} else if(opt=='2'){const a=prompt("Área:",area);if(a)await updateDoc(doc(db,'subjects',id),{area:a});} };
        window.changeMonth = (d) => { calCurrentDate.setMonth(calCurrentDate.getMonth()+d); renderCalendarWidget(); };
        window.exportPDF = () => { const el=document.getElementById('leccionario-print-area'); html2pdf().set({margin:0.3, filename:`Leccionario_${new Date().toISOString().split('T')[0]}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'in',format:'letter',orientation:'landscape'}}).from(el).save(); };
        window.forceLoadUsers = async () => { const q = query(collection(db, "users")); const s = await getDocs(q); window.dbData.users={}; s.forEach(d=>window.dbData.users[d.id]=d.data()); renderUsersTable(); window.showToast('Actualizado'); };
        
        // Modal Password
        window.openPassModal = () => document.getElementById('modal-password').classList.remove('hidden');
        window.closePassModal = () => document.getElementById('modal-password').classList.add('hidden');
        window.saveNewPassword = async () => { const p=document.getElementById('new-password').value; if(p.length<6)return window.showToast('Mínimo 6 chars','error'); try{ await updatePassword(currentUser,p); window.showToast('Clave actualizada'); window.closePassModal(); }catch(e){ window.showToast('Error: Re-ingresa al sistema','error'); } };

        // DOM Loaded - Event Listeners Formularios
        document.addEventListener('DOMContentLoaded', () => {
            // Login con Feedback Visual
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const old = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Verificando...';
                btn.disabled = true;
                try {
                    await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value);
                } catch(e) {
                    window.showToast('Credenciales incorrectas', 'error');
                    btn.innerHTML = old;
                    btn.disabled = false;
                }
            });

            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const cred = await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-pass').value);
                    const file = document.getElementById('reg-signature').files[0];
                    const reader = new FileReader();
                    reader.onload = async () => {
                        await setDoc(doc(db, "users", cred.user.uid), { email: document.getElementById('reg-email').value, nombre: document.getElementById('reg-name').value, rol: "Docente", firma: reader.result, createdAt: new Date().toISOString() });
                    };
                    if(file) reader.readAsDataURL(file);
                    else await setDoc(doc(db, "users", cred.user.uid), { email: document.getElementById('reg-email').value, nombre: document.getElementById('reg-name').value, rol: "Docente", firma: null, createdAt: new Date().toISOString() });
                } catch(e) { window.showToast(e.message, 'error'); }
            });

            // Forms Admin Simplificados
            const add = async (col, data) => { await addDoc(collection(db, col), {...data, createdAt: new Date().toISOString()}); window.showToast('Guardado'); document.activeElement.form.reset(); };
            document.getElementById('form-section').onsubmit = (e) => { e.preventDefault(); add('sections', {name: document.getElementById('section-name').value}); };
            document.getElementById('form-area').onsubmit = (e) => { e.preventDefault(); add('areas', {name: document.getElementById('area-name').value}); };
            document.getElementById('form-subject').onsubmit = (e) => { e.preventDefault(); add('subjects', {name: document.getElementById('subject-name').value, area: document.getElementById('subject-area-select').value}); };
            document.getElementById('form-course').onsubmit = (e) => { e.preventDefault(); add('courses', {name: document.getElementById('course-name').value, sectionId: document.getElementById('course-section-select').value, parallels: document.getElementById('course-parallels').value.split(',').map(s=>s.trim())}); };

            document.getElementById('current-date-label').textContent = new Date().toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
            setTimeout(() => document.getElementById('loader').classList.add('hidden'), 500);
        });

        // Helpers Horarios
        window.tempTimeSlots = [{s:'07:15', e:'08:00'}, {s:'08:00', e:'08:45'}, {s:'08:45', e:'09:25'}, {s:'10:00', e:'10:40'}, {s:'10:40', e:'11:20'}];
        window.initSchedule = () => { renderTimeConfig(); document.getElementById('sched-valid-from').value=new Date().toISOString().split('T')[0]; document.getElementById('sched-valid-to').value = new Date(new Date().setFullYear(new Date().getFullYear()+1)).toISOString().split('T')[0]; };
        window.renderTimeConfig = () => { document.getElementById('time-slots-config').innerHTML = window.tempTimeSlots.map((s,i) => `<div class="flex gap-2 mb-1"><input type="time" value="${s.s}" class="border rounded px-1 text-xs" onchange="window.tempTimeSlots[${i}].s=this.value"><input type="time" value="${s.e}" class="border rounded px-1 text-xs" onchange="window.tempTimeSlots[${i}].e=this.value"></div>`).join('') + `<button onclick="addSlot()" class="text-xs text-blue-600 font-bold mt-2">+ Agregar Hora</button>`; renderMatrix(); };
        window.addSlot = () => { window.tempTimeSlots.push({s:'00:00',e:'00:00'}); renderTimeConfig(); };
        window.removeSlot = (i) => { window.tempTimeSlots.splice(i,1); renderTimeConfig(); };
        window.updateSlot = (i,f,v) => { window.tempTimeSlots[i][f] = v; };
        function renderMatrix() { document.getElementById('matrix-body').innerHTML = window.tempTimeSlots.map((h, r) => `<tr><td class="text-[10px] text-center bg-slate-50 border-b">${h.s}<br>${h.e}</td>${[0,1,2,3,4].map(c => `<td class="border p-1 h-10 text-center cursor-pointer hover:bg-blue-50 text-[10px]" onclick="setCell(this)" data-key="${r}-${c}"></td>`).join('')}</tr>`).join(''); }
        window.setCell = (td) => { const v = prompt("Materia:", td.innerText); if(v!==null) { td.innerText = v; td.className = v === 'RECESO' ? "border p-1 h-10 text-center cursor-pointer bg-gray-200 text-[10px]" : "border p-1 h-10 text-center cursor-pointer bg-blue-100 text-[10px]"; } };
        window.updateSchedSelects = (val) => { const s = document.getElementById('sched-course-select'); s.innerHTML = '<option value="">Curso...</option>'; s.disabled = !val; window.dbData.courses.filter(c => c.sectionId === val).forEach(c => s.innerHTML += `<option value="${c.id}">${c.name}</option>`); };
        window.enableParallel = (val) => { const s = document.getElementById('sched-parallel-select'); s.innerHTML = '<option value="">Paralelo...</option>'; s.disabled = !val; window.dbData.courses.find(c => c.id === val).parallels.forEach(p => s.innerHTML += `<option value="${p}">${p}</option>`); };
        window.saveSchedule = async () => { const cid = document.getElementById('sched-course-select').value; const par = document.getElementById('sched-parallel-select').value; if(!cid || !par) return; const m = {}; document.querySelectorAll('#matrix-body td[data-key]').forEach(td => { if(td.innerText) m[td.dataset.key] = td.innerText; }); const cObj = window.dbData.courses.find(c => c.id === cid); await setDoc(doc(db, 'schedules', `${cid}_${par}`), { courseId: cid, courseName: cObj.name, parallel: par, uid: currentUser.uid, validFrom: document.getElementById('sched-valid-from').value, validTo: document.getElementById('sched-valid-to').value, timeSlots: window.tempTimeSlots, matrix: m }); window.showToast('Horario guardado'); };

    </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <!-- NAVBAR -->
    <nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer" onclick="window.showSection('dashboard')">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg text-xl">LV</div> V3.8
            </div>
            <div class="hidden md:flex items-center gap-4 text-sm font-medium text-slate-600">
                <button onclick="window.showSection('dashboard')" class="hover:text-blue-600">Inicio</button>
                <div id="nav-admin-group" class="hidden flex gap-4">
                    <button onclick="window.showSection('academic-admin')" class="hover:text-blue-600">Configuración</button>
                    <button onclick="window.showSection('courses')" class="hover:text-blue-600">Cursos</button>
                    <button onclick="window.showSection('users')" class="hover:text-blue-600">Usuarios</button>
                    <button onclick="window.showSection('schedules'); window.initSchedule()" class="hover:text-blue-600">Horarios</button>
                    <button onclick="window.showSection('report-compliance')" class="hover:text-blue-600">Reportes</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <div id="user-name-display" class="text-sm font-bold">Usuario</div>
                    <div id="user-role-label" class="text-[10px] uppercase text-slate-500">Rol</div>
                </div>
                <button onclick="window.openPassModal()" class="text-slate-400 hover:text-blue-600 transition" title="Clave"><i class="fa-solid fa-key"></i></button>
                <button onclick="window.handleLogout()" class="text-slate-400 hover:text-red-500 transition" title="Salir"><i class="fa-solid fa-power-off text-lg"></i></button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
        
        <!-- DASHBOARD (AUTO-LOAD) -->
        <div id="section-dashboard" class="hidden animate-fade-in">
            <div class="flex justify-between items-end mb-4">
                <div><h1 class="text-2xl font-bold">Leccionario de Hoy</h1><p id="current-date-label" class="text-sm text-slate-500 capitalize"></p></div>
                <div class="flex gap-2">
                    <button id="btn-save-daily" onclick="window.saveDaily()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow hover:bg-blue-700 transition"><i class="fa-solid fa-save mr-2"></i>Guardar</button>
                    <button onclick="window.exportPDF()" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold text-sm shadow hover:bg-slate-900 transition"><i class="fa-solid fa-print mr-2"></i>PDF</button>
                </div>
            </div>

            <!-- LECCIONARIO (ARRIBA) -->
            <div id="leccionario-print-area" class="bg-white rounded-xl border shadow-sm mb-6 overflow-hidden">
                <div class="p-3 bg-slate-50 border-b font-bold text-slate-700 text-xs uppercase tracking-wider text-center">Registro de Clases</div>
                <div id="leccionario-wrapper" class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead><tr class="text-xs text-slate-500 border-b bg-white"><th class="p-3">Hora</th><th class="p-3">Materia</th><th class="p-3 w-1/3">Tema</th><th class="p-3 text-center">Docente</th><th class="p-3 text-center">Firma</th><th class="p-3 w-1/3">Observación</th></tr></thead>
                        <tbody id="today-leccionario-body">
                            <tr><td colspan="6" class="text-center py-8 text-slate-400"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Cargando leccionario...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="leccionario-empty-msg" class="p-8 text-center text-slate-400 hidden"><i class="fa-solid fa-mug-hot text-3xl mb-2"></i><p>No tienes clases asignadas hoy.</p></div>
            </div>

            <!-- PANELES INFERIORES -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- CALENDARIO (AMPLIADO 50%) -->
                <div class="bg-white p-5 rounded-xl border shadow-sm h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700">Cumplimiento Mensual</h3>
                        <div class="flex gap-2">
                            <button onclick="window.changeMonth(-1)" class="text-slate-400 hover:text-blue-600"><i class="fa-solid fa-chevron-left"></i></button>
                            <span id="cal-month-label" class="text-sm font-bold uppercase w-24 text-center">MES</span>
                            <button onclick="window.changeMonth(1)" class="text-slate-400 hover:text-blue-600"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-center text-[10px] font-bold text-slate-400 mb-2"><div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div></div>
                    <div id="cal-grid" class="grid grid-cols-7 gap-2"></div>
                </div>

                <!-- MIS CURSOS (50%) -->
                <div class="bg-white p-5 rounded-xl border shadow-sm h-full flex flex-col">
                    <h3 class="font-bold text-slate-700 mb-4">Mis Cursos Asignados</h3>
                    <div id="my-load-list" class="space-y-3 flex-1 overflow-y-auto pr-2">
                        <p class="text-xs text-slate-400 animate-pulse">Cargando cursos...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIONES OCULTAS (ADMIN, CONFIG, ETC) -->
        <div id="section-academic-admin" class="hidden">
            <h2 class="text-xl font-bold mb-4">Configuración Académica</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-xl border shadow-sm">
                    <h3 class="font-bold text-sm mb-2">Secciones</h3>
                    <form id="form-section" class="flex gap-2 mb-2"><input id="section-name" class="border rounded p-1 flex-1 text-sm" required><button class="bg-blue-600 text-white px-2 rounded">+</button></form>
                    <table class="w-full text-sm"><tbody id="sections-table-body"></tbody></table>
                </div>
                <div class="bg-white p-4 rounded-xl border shadow-sm">
                    <h3 class="font-bold text-sm mb-2">Áreas</h3>
                    <form id="form-area" class="flex gap-2 mb-2"><input id="area-name" class="border rounded p-1 flex-1 text-sm" required><button class="bg-blue-600 text-white px-2 rounded">+</button></form>
                    <table class="w-full text-sm"><tbody id="areas-table-body"></tbody></table>
                </div>
                <div class="bg-white p-4 rounded-xl border shadow-sm">
                    <h3 class="font-bold text-sm mb-2">Materias</h3>
                    <form id="form-subject" class="space-y-2 mb-2"><input id="subject-name" class="w-full border rounded p-1 text-sm" placeholder="Nombre" required><select id="subject-area-select" class="w-full border rounded p-1 text-sm" required></select><button class="w-full bg-blue-600 text-white py-1 rounded text-xs font-bold">Crear</button></form>
                    <div class="h-40 overflow-y-auto"><table class="w-full text-sm"><tbody id="subjects-table-body"></tbody></table></div>
                </div>
            </div>
        </div>

        <div id="section-courses" class="hidden">
            <h2 class="text-xl font-bold mb-4">Gestión de Cursos</h2>
            <div class="bg-white p-6 rounded-xl border shadow-sm">
                <form id="form-course" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"><input id="course-name" class="border rounded p-2 text-sm" placeholder="Nombre" required><select id="course-section-select" class="border rounded p-2 text-sm" required></select><input id="course-parallels" class="border rounded p-2 text-sm" placeholder="Paralelos (A,B,C)" required><button class="bg-blue-600 text-white rounded p-2 font-bold text-sm">Guardar</button></form>
                <table class="w-full text-sm text-left"><thead class="bg-slate-50 text-xs uppercase"><tr><th class="p-2">Curso</th><th class="p-2">Sección</th><th class="p-2">Paralelos</th><th></th></tr></thead><tbody id="courses-table-body"></tbody></table>
            </div>
        </div>

        <div id="section-users" class="hidden">
            <h2 class="text-xl font-bold mb-4">Usuarios</h2>
            <div class="bg-white p-6 rounded-xl border shadow-sm">
                <div class="flex justify-between mb-4"><h3 class="font-bold">Lista de Personal</h3><button onclick="window.forceLoadUsers()" class="text-sm text-blue-600"><i class="fa-solid fa-rotate"></i> Actualizar</button></div>
                <table class="w-full text-sm text-left"><thead class="bg-slate-50 text-xs uppercase"><tr><th class="p-3">Nombre</th><th class="p-3">Email</th><th class="p-3">Rol</th><th class="p-3 text-center">Firma</th></tr></thead><tbody id="users-table-body"></tbody></table>
            </div>
        </div>

        <div id="section-schedules" class="hidden">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Horarios</h2><button onclick="window.saveSchedule()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">Guardar</button></div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white p-4 rounded-xl border shadow-sm space-y-4">
                    <div><label class="text-xs font-bold text-slate-500">Contexto</label><select id="sched-section-select" class="w-full border rounded p-2 text-sm mt-1" onchange="window.updateSchedSelects(this.value)"></select><select id="sched-course-select" class="w-full border rounded p-2 text-sm mt-2" disabled onchange="window.enableParallel(this.value)"></select><select id="sched-parallel-select" class="w-full border rounded p-2 text-sm mt-2" disabled></select></div>
                    <div><label class="text-xs font-bold text-slate-500">Vigencia</label><div class="flex gap-1 mt-1"><input type="date" id="sched-valid-from" class="w-full border rounded p-1 text-xs"><input type="date" id="sched-valid-to" class="w-full border rounded p-1 text-xs"></div></div>
                    <div><label class="text-xs font-bold text-slate-500">Horas</label><div id="time-slots-config"></div></div>
                </div>
                <div class="md:col-span-3 bg-white p-1 rounded-xl border shadow-sm overflow-x-auto"><table class="w-full border-collapse"><thead><tr><th class="p-2 w-20"></th><th class="text-xs bg-slate-50 p-2">Lunes</th><th class="text-xs bg-slate-50 p-2">Martes</th><th class="text-xs bg-slate-50 p-2">Miércoles</th><th class="text-xs bg-slate-50 p-2">Jueves</th><th class="text-xs bg-slate-50 p-2">Viernes</th></tr></thead><tbody id="matrix-body"></tbody></table></div>
            </div>
        </div>

        <div id="section-report-compliance" class="hidden">
            <h2 class="text-xl font-bold mb-4">Reporte de Faltantes</h2>
            <div class="bg-white p-6 rounded-xl border shadow-sm">
                <div class="flex items-end gap-4 mb-6"><div><label class="text-xs font-bold text-slate-500">Fecha</label><input type="date" id="rep-date" class="block mt-1 border rounded p-2 text-sm"></div><button onclick="window.runComplianceReport()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Generar</button></div>
                <table class="w-full text-left text-sm"><thead class="bg-slate-50 text-xs uppercase"><tr><th class="p-3">Curso</th><th class="p-3">Materia</th><th class="p-3">Responsable</th><th class="p-3">Estado</th></tr></thead><tbody id="compliance-body"></tbody></table>
            </div>
        </div>

    </main>

    <!-- LOADERS & MODALS -->
    <div id="loader" class="fixed inset-0 bg-white z-[100] flex items-center justify-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-[60] flex flex-col items-end"></div>
    
    <div id="modal-password" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="font-bold text-lg mb-4">Cambiar Contraseña</h3>
            <input type="password" id="new-password" class="w-full border p-2 rounded mb-4 text-sm" placeholder="Nueva clave">
            <div class="flex gap-2"><button onclick="window.closePassModal()" class="flex-1 bg-slate-100 py-2 rounded text-sm">Cancelar</button><button onclick="window.saveNewPassword()" class="flex-1 bg-blue-600 text-white py-2 rounded text-sm">Guardar</button></div>
        </div>
    </div>

    <div id="auth-view" class="fixed inset-0 bg-slate-100 flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl">
            <h1 class="text-2xl font-bold text-center mb-6">Leccionario V3.8</h1>
            <div class="flex border-b mb-6"><button onclick="window.switchAuth('login')" class="flex-1 pb-2 font-bold text-blue-600 border-b-2 border-blue-600">Entrar</button><button onclick="window.switchAuth('register')" class="flex-1 pb-2 font-bold text-slate-400">Registro</button></div>
            <form id="login-form" class="space-y-4"><input id="login-email" type="email" class="w-full border p-3 rounded-lg" placeholder="Email" required><input id="login-pass" type="password" class="w-full border p-3 rounded-lg" placeholder="Password" required><button class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Ingresar</button></form>
            <form id="register-form" class="space-y-4 hidden"><input id="reg-name" class="w-full border p-3 rounded-lg" placeholder="Nombre" required><input id="reg-email" type="email" class="w-full border p-3 rounded-lg" placeholder="Email" required><input id="reg-pass" type="password" class="w-full border p-3 rounded-lg" placeholder="Password" required><input id="reg-signature" type="file" accept="image/*" class="w-full text-sm"><button class="w-full bg-green-600 text-white p-3 rounded-lg font-bold">Registrar</button></form>
        </div>
    </div>
</body>
</html>